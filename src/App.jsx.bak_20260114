import React, { useState, useEffect, useRef } from 'react';
import {
  Calendar, MapPin, Users, Target, LayoutDashboard,
  FileText, Plus, CheckSquare, Upload, Building2,
  AlertCircle, Save, ArrowLeft, Briefcase, PenTool,
  Search, Mail, X, QrCode, Wallet, MessageCircle,
  Send, ScanLine, TrendingUp, Trash2, Link as LinkIcon,
  DollarSign, RefreshCw, Clock, Map, Database, CheckCircle,
  GripVertical, UserX, UserCheck, List, Edit3, Flag,
  AlertTriangle, ExternalLink, Copy, Check, FileSpreadsheet,
  UserPlus, Settings, Download, Eye, Folder, PackageCheck,
  Camera, Loader, Ghost, BedDouble, CalendarDays, Menu,
  ChevronDown, ChevronUp, RefreshCcw, Trash, GitBranch, Mic, Truck, Layout, User, Info, LogOut
} from 'lucide-react';
import ExcelJS from 'exceljs';
import { saveAs } from 'file-saver';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, updateDoc, doc, deleteDoc, onSnapshot, setDoc, query, limit, orderBy, writeBatch, getDocs } from "firebase/firestore";
// QRコード用ライブラリ
import { QRCodeCanvas } from 'qrcode.react';
import { Scanner } from '@yudiel/react-qr-scanner';

// ============================================================================
// 1. 定数・ヘルパー関数・初期データ
// ============================================================================

const PREFECTURES = [
  { region: "北海道・東北", prefs: ["北海道", "青森", "岩手", "宮城", "秋田", "山形", "福島"] },
  { region: "関東", prefs: ["東京", "神奈川", "埼玉", "千葉", "茨城", "栃木", "群馬"] },
  { region: "中部", prefs: ["愛知", "静岡", "岐阜", "三重", "山梨", "長野", "新潟", "富山", "石川", "福井"] },
  { region: "近畿", prefs: ["大阪", "兵庫", "京都", "滋賀", "奈良", "和歌山"] },
  { region: "中国・四国", prefs: ["広島", "岡山", "鳥取", "島根", "山口", "香川", "徳島", "愛媛", "高知"] },
  { region: "九州・沖縄", prefs: ["福岡", "佐賀", "長崎", "熊本", "大分", "宮崎", "鹿児島", "沖縄"] },
];

const EQUIPMENT_OPTIONS = ["長机", "椅子", "プロジェクター", "マイク", "マイクスタンド", "スクリーン", "演台", "パーテーション"];
const MASTER_SHEET_URL = "https://docs.google.com/spreadsheets/d/1hnZdkquaybY-bBSAevnW2BOLn83OdITzNvt-hmZkmVI/edit?gid=0#gid=0";
const INITIAL_INTERNAL_SUPPLIES = [
  "メジャー", "テープ", "消毒液", "音楽用CD", "ダンボール", "ヤマト佐川送り状",
  "ラミネート看板", "介援隊袋", "横断幕", "延長ケーブル",
  "自社用レイアウト用紙", "お客様用レイアウト用紙", "介援隊カタログ", "展示会案内チラシ　50枚ほど"
].map((name, i) => ({ id: `is-${i}`, name, count: 1, checked: false }));

// ▼ メーカーリスト初期値（CSV取込前提のため空配列）
const FIXED_MAKERS_LIST = [];

// ▼ 完全版タスクリスト（以前の内容を維持）
const INITIAL_TASKS = [
  { id: 's1', category: 'sales', phase: 'prep', title: '展示会日時・エリアの決定', status: 'done', assignee: '', dueDate: '', desc: '役員会議にて決定' },
  { id: 's2', category: 'sales', phase: 'prep', title: '展示会場選び', status: 'done', assignee: '', dueDate: '', desc: '' },
  { id: 's3', category: 'sales', phase: 'prep', title: '展示会場申請', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's4', category: 'sales', phase: 'prep', title: 'メーカー選定（予備リストを編集）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's5', category: 'sales', phase: 'prep', title: '講演会企画の計画', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's6', category: 'sales', phase: 'prep', title: '電気設備会社手配', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's7', category: 'sales', phase: 'prep', title: '展示会必要品の手配（リストを参照）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's8', category: 'sales', phase: 'prep', title: '集荷手配（ヤマト・佐川）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's9', category: 'sales', phase: 'prep', title: 'バイトの手配と打ち合わせ', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's10', category: 'sales', phase: 'prep', title: '展示会場最終打ち合わせ', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's11', category: 'sales', phase: 'prep', title: '当日のデモンストレーション', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's12', category: 'sales', phase: 'prep', title: '得意先集客', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's13', category: 'sales', phase: 'prep', title: 'エンド（施設など）集客', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's14', category: 'sales', phase: 'prep', title: '当日の展示会運営', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's15', category: 'sales', phase: 'prep', title: '当日の講演会運営', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's16', category: 'sales', phase: 'prep', title: 'ホテル予約', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's17', category: 'sales', phase: 'prep', title: '弁当手配', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's18', category: 'sales', phase: 'prep', title: '打ち上げ会場予約', status: 'pending', assignee: '', dueDate: '', desc: '予算一人5000円以内' },
  { id: 's20', category: 'sales', phase: 'post', title: '備品整理', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 's21', category: 'sales', phase: 'post', title: '領収書等を企画へ送付', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p1', category: 'planning', phase: 'prep', title: '展示会企画概要作成', status: 'done', assignee: '', dueDate: '', desc: '詳細省略' },
  { id: 'p2', category: 'planning', phase: 'prep', title: 'メーカー選定（希望リスト編集）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p3', category: 'planning', phase: 'prep', title: 'メーカー招待', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p4', category: 'planning', phase: 'prep', title: 'メーカー問い合わせ対応', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p5', category: 'planning', phase: 'prep', title: '案内チラシ作成', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p6', category: 'planning', phase: 'prep', title: '講演会企画の手配実行', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p7', category: 'planning', phase: 'prep', title: '展示会場レイアウト作成', status: 'pending', assignee: '', dueDate: '', desc: 'メーカー用・来場者用・自社用' },
  { id: 'p8', category: 'planning', phase: 'prep', title: 'メーカー招待（催促）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p9', category: 'planning', phase: 'prep', title: 'メーカー招待（第2弾）', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p10', category: 'planning', phase: 'prep', title: '（仮）収支報告書作成', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p11', category: 'planning', phase: 'prep', title: 'メーカーへチラシ配布を依頼', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p12', category: 'planning', phase: 'prep', title: '備品確保・貸借申請', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p13', category: 'planning', phase: 'prep', title: 'メーカーパネルラミネート作成', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p14', category: 'planning', phase: 'prep', title: '出展確定メーカーに確定メールを送信', status: 'pending', assignee: '', dueDate: '', desc: 'レイアウト添付・チラシ添付・搬入時間変更・フォーム記載の案内文' },
  { id: 'p15', category: 'planning', phase: 'prep', title: '当日の工程表作成', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p16', category: 'planning', phase: 'prep', title: 'メーカー請求書作成（送付依頼）', status: 'pending', assignee: '', dueDate: '', desc: '澤田さんに出展メーカーへ送ってもらう' },
  { id: 'p18', category: 'planning', phase: 'post', title: '入金確認（振り込み・現金集金）', status: 'pending', assignee: '経理', dueDate: '', desc: '' },
  { id: 'p19', category: 'planning', phase: 'post', title: '展示会使用経費のデータをもらう', status: 'pending', assignee: '', dueDate: '', desc: '' },
  { id: 'p20', category: 'planning', phase: 'post', title: '収支報告書（決定版）', status: 'pending', assignee: '', dueDate: '', desc: '' },
];

const DEFAULT_FORM_CONFIG = {
  section1: {
    title: '（今回の展示会のタイトル） 出展申込みフォーム',
    description: `拝啓　貴社ますますご清栄のこととお喜び申し上げます。
日頃は格別のお引き立てを賜り厚く御礼申しあげます。
早速ではございますが、下記の要領で福祉用具展示会を開催する運びとなりました。
つきましては御社ご出展をお願い致したく、ご案内申し上げます。
ご検討の程、宜しくお願い申し上げます。敬具

出展を希望されない場合も、お手数ですが、その旨お答えいただきますようお願い申し上げます。

【展示会概要】
開催日時：（開催日時、曜日なども添えて）
会場：（今回の展示会の会場名称）
住所：（今回の展示会の住所）
電話：（今回の展示会場の電話番号）
アクセス： 今回の展示会場のGoogleマップのURL

搬入方法：（フリー入力スペース　日時と時間を指定可能）
※事前に荷物の発送を希望される方：（フリー入力スペース）の時間帯でよろしくお願い致します。

【宛先】（今回の展示会場の住所）
（今回の展示会の会場名称）
介援隊ブース〇〇ブース　(御社名を記載お願い致します)
※当日送付は（フリー入力スペース）時以降になります。

出展費用：1コマ（2.5ｍ×2.5ｍ）　30,000円(税込)　昼食付(1社2名様分まで)
出展費用につきましては下記アンケートより希望方法をご指定ください。
※2コマ以上をご希望の場合はスペースに限りがございますので、
ご希望に添えない場合がございます。予めご了承下さい。

【申込期日】（日時入力）　厳守

出展メーカー数：100社ほどを予定しております。
来場者：福祉用具販売・貸与事業所様、
一部施設スタッフ・ケアマネ様、介護施設。病院関係者様など

当日は午前9：15分頃より簡単な朝礼を行いますので、時間までに準備集合をお願いいたします。

展示会終了後の集荷については、ヤマト、佐川急便を手配予定です。

お問い合わせは、当社営業企画部(06-6150-7333)までお願い致します。`,
    items: [
      { id: 'companyName', label: '貴社名', type: 'text', help: '法人格は略さずに記入ください。前後にスペースは不要です。例：株式会社ケアマックスコーポレーション' },
      { id: 'companyNameKana', label: '貴社名フリガナ', type: 'text', help: 'フリガナに法人格は不要です。全角カタカナでお願いします。例：ケアマックスコーポレーション' },
      { id: 'repName', label: 'お名前', type: 'text', help: '出展(回答)される方、代表者1名を明記ください　例：介援　太郎' },
      { id: 'phone', label: '携帯番号', type: 'text', help: '半角　ハイフン含めて明記ください　例：080-0000-0000' },
      { id: 'email', label: 'メールアドレス', type: 'email', help: '' },
      { id: 'status', label: '出展の可否について', type: 'radio', options: ['出展を申し込む', '出展を申し込まない'] }
    ]
  },
  section2: {
    title: '出展詳細入力',
    description: '出展に必要な詳細情報をご記入ください。',
    items: [
      { id: 'moveInDate', label: '搬入日時', type: 'radio', options: ['前日搬入', '当日搬入'] },
      { id: 'boothCount', label: '希望コマ数', type: 'radio', options: ['1コマ', '2コマ', 'その他要相談'] },
      { id: 'staffCount', label: '参加人数', type: 'select', options: ['1', '2', '3', '4', '5'] },
      { id: 'lunchCount', label: '昼食について', type: 'radio', options: ['1', '2'] },
      { id: 'itemsDesk', label: '長机', type: 'select', options: ['0', '1', '2', '3'] },
      { id: 'itemsChair', label: '椅子', type: 'select', options: ['0', '1', '2', '3', '4', '5', '6'] },
      { id: 'itemsPower', label: '電源', type: 'radio', options: ['不要', '必要'] },
      { id: 'powerDetail', label: '★電源を使用する機器について', type: 'text', help: '上記質問で電源必要と答えられた方は、配線に必要ですので、何に電源を使用するのか具体的に記入ください。', condition: { targetId: 'itemsPower', operator: 'eq', value: '必要' }, required: true },
      { id: 'transport', label: '搬出時に会場から運送便を使う場合', type: 'radio', options: ['ヤマト', '佐川', '使用しない'] },
      { id: 'packages', label: '出荷個口数', type: 'select', options: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'], condition: { targetId: 'transport', operator: 'neq', value: '使用しない' } },
      { id: 'payment', label: '出展費用支払方法', type: 'radio', options: ['仕入れより相殺', '振り込み'] },
      { id: 'note', label: '特記事項入力欄', type: 'textarea', help: '' },
      { id: 'billIssue', label: '出展日請求書の発行', type: 'radio', options: ['必要', '不要'] },
      { id: 'products', label: '展示会予定品', type: 'textarea', help: '商品名を記入' }
    ]
  },
  section3: {
    title: '受付いたしました（不参加）',
    description: `ご検討いただきありがとうございました。
もしよろしければ、今回不参加の理由をお知らせください。

今後の参考とさせていただきます。
何卒宜しくお願い致します。
ケアマックスコーポレーション　展示会事務局`,
    items: [
      { id: 'declineReason', label: '不参加理由', type: 'textarea', help: '回答無しでもOK' }
    ]
  },
  mail: {
    subject: '（展示会タイトル）　【出展のご案内】',
    body: `ご担当者　様

いつも大変お世話になっております。
ケアマックスコーポレーションでございます。
この度、（開催日時）に、介援隊の展示会を開催する運びとなりましたのでご案内申し上げます。
つきましては、下記URLよりご参加の可否に関わらずご回答いただけますと幸甚に存じます。
ご多用のところ誠に恐れ入りますが、何卒よろしくお願い申し上げます。

{url}

よろしくお願いいたします。`
  }
};

const DEFAULT_VISITOR_FORM_CONFIG = {
  title: '来場者事前登録',
  description: '当日のスムーズな入場のため、事前登録にご協力をお願いいたします。登録完了後、入場用QRコードが発行されます。',
  items: [
    { id: 'type', label: '★受付区分', type: 'select', options: ['販売店', '介護・看護従事者様(看護師・介護士・ケアマネ等)', 'メーカー・製造業', '一般・個人'], required: true },
    { id: 'companyName', label: '★会社名・法人名', type: 'text', help: '個人の場合は「個人」とご明記ください (例：株式会社ケアマックスコーポレーション)', required: true },
    { id: 'repName', label: '★代表者名', type: 'text', help: '', required: true },
    { id: 'phone', label: '★電話番号', type: 'text', help: 'ハイフンなしでも可', required: true },
    { id: 'email', label: '★メールアドレス', type: 'email', help: 'QRコード送付用', required: true },
    { id: 'invitedBy', label: '★招待企業様名', type: 'text', help: '招待状をお持ちの場合、企業名をご記入ください（任意）', required: false }
  ]
};

const downloadCSV = (data, filename) => {
  if (!data || !data.length) return;
  const headers = Object.keys(data[0]);
  const csvContent = [
    headers.join(','),
    ...data.map(row => headers.map(header => {
      const val = row[header] ? String(row[header]).replace(/"/g, '""') : '';
      return `"${val}"`;
    }).join(','))
  ].join('\n');

  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

const parseCSV = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const lines = text.split(/\r\n|\n/).filter(line => line.trim());
      const data = lines.map((line, index) => {
        const [code, companyName] = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
        if (!code || !companyName) return null;
        return {
          id: Date.now() + index,
          code,
          companyName,
          status: 'listed',
          note: 'CSV取込',
          accessToken: crypto.randomUUID() // 自動生成
        };
      }).filter(item => item !== null);
      resolve(data);
    };
    reader.onerror = (e) => reject(e);
    reader.readAsText(file);
  });
};

const extractNum = (val) => {
  if (typeof val === 'number') return val;
  if (!val) return 0;
  const halfVal = val.toString().replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
  const match = halfVal.match(/\d+/);
  return match ? parseInt(match[0], 10) : 0;
};
// ============================================================================
// 2. 共通小コンポーネント & フォーム編集モーダル
// ============================================================================

function DetailItem({ label, value }) {
  return (
    <div>
      <label className="block text-xs font-bold text-slate-400 mb-1">{label}</label>
      <div className="font-medium text-slate-800 break-words">{value || '-'}</div>
    </div>
  );
}

// 機能強化版フォームエディタ (ラベル、補足、選択肢の編集に対応)
function FormEditorModal({ config, onSave, onClose }) {
  const [localConfig, setLocalConfig] = useState(config);
  const [activeTab, setActiveTab] = useState('section1');
  const [expandedItems, setExpandedItems] = useState({});

  const toggleItem = (id) => {
    setExpandedItems(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const updateSection = (k, v) => setLocalConfig({ ...localConfig, [activeTab]: { ...localConfig[activeTab], [k]: v } });

  const updateItem = (id, field, value) => {
    const updatedItems = localConfig[activeTab].items.map(i => {
      if (i.id === id) {
        if (field === 'options') return { ...i, options: value.split(',').map(s => s.trim()) };
        return { ...i, [field]: value };
      }
      return i;
    });
    updateSection('items', updatedItems);
  };

  const addOption = (itemId) => {
    const updatedItems = localConfig[activeTab].items.map(i => {
      if (i.id === itemId) return { ...i, options: [...(i.options || []), '新しい選択肢'] };
      return i;
    });
    updateSection('items', updatedItems);
  };

  const removeOption = (itemId, index) => {
    const updatedItems = localConfig[activeTab].items.map(i => {
      if (i.id === itemId) {
        const newOpts = [...(i.options || [])];
        newOpts.splice(index, 1);
        return { ...i, options: newOpts };
      }
      return i;
    });
    updateSection('items', updatedItems);
  };

  const updateOptionText = (itemId, index, val) => {
    const updatedItems = localConfig[activeTab].items.map(i => {
      if (i.id === itemId) {
        const newOpts = [...(i.options || [])];
        newOpts[index] = val;
        return { ...i, options: newOpts };
      }
      return i;
    });
    updateSection('items', updatedItems);
  };

  const addItem = () => {
    const newItem = {
      id: `custom_${Date.now()}`,
      label: '新しい質問',
      type: 'text',
      help: '',
      required: false,
      options: ['選択肢1', '選択肢2']
    };
    const updatedItems = [...(localConfig[activeTab].items || []), newItem];
    updateSection('items', updatedItems);
    setExpandedItems(prev => ({ ...prev, [newItem.id]: true }));
  };

  const deleteItem = (id) => {
    if (window.confirm('この質問を削除してもよろしいですか？')) {
      const updatedItems = localConfig[activeTab].items.filter(i => i.id !== id);
      updateSection('items', updatedItems);
    }
  };

  const updateCondition = (itemId, field, value) => {
    const updatedItems = localConfig[activeTab].items.map(i => {
      if (i.id === itemId) {
        // If toggling condition off (value === null/false), remove it
        if (field === 'enabled' && !value) {
          const { condition, ...rest } = i;
          return rest;
        }
        // If toggling on, add default
        if (field === 'enabled' && value) {
          return { ...i, condition: { targetId: '', operator: 'eq', value: '' } };
        }
        // Updating fields inside condition object
        return { ...i, condition: { ...(i.condition || { targetId: '', operator: 'eq', value: '' }), [field]: value } };
      }
      return i;
    });
    updateSection('items', updatedItems);
  };

  // Helper to get options from other items for condition setting
  const getOtherItems = (currentItemId) => {
    return localConfig[activeTab].items.filter(i => i.id !== currentItemId && (i.type === 'radio' || i.type === 'select'));
  };

  const getOptionsForTarget = (targetId) => {
    const target = localConfig[activeTab].items.find(i => i.id === targetId);
    return target ? target.options || [] : [];
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl">
        <div className="p-6 border-b flex justify-between">
          <h3 className="font-bold text-lg">招待フォーム設定</h3>
          <button onClick={onClose}><X /></button>
        </div>
        <div className="flex border-b bg-slate-50">
          <button onClick={() => setActiveTab('section1')} className={`px-6 py-3 font-bold text-sm ${activeTab === 'section1' ? 'bg-white border-t-2 border-t-blue-500 text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>基本情報</button>
          <button onClick={() => setActiveTab('section2')} className={`px-6 py-3 font-bold text-sm ${activeTab === 'section2' ? 'bg-white border-t-2 border-t-blue-500 text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>詳細情報</button>
          <button onClick={() => setActiveTab('section3')} className={`px-6 py-3 font-bold text-sm ${activeTab === 'section3' ? 'bg-white border-t-2 border-t-blue-500 text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>完了画面</button>
        </div>
        <div className="p-8 overflow-y-auto flex-1 space-y-6 bg-slate-50/50">
          <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">セクションタイトル</label>
              <input className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none font-bold" value={localConfig[activeTab]?.title} onChange={e => updateSection('title', e.target.value)} />
            </div>
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">説明文・案内文</label>
              <textarea className="w-full border p-2 rounded h-32 text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={localConfig[activeTab]?.description} onChange={e => updateSection('description', e.target.value)} />
            </div>
          </div>

          {localConfig[activeTab]?.items && (
            <div>
              <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><List size={18} /> 質問項目設定</h4>
              <div className="space-y-3">
                {localConfig[activeTab].items.map(item => (
                  <div key={item.id} className="bg-white border border-slate-200 rounded-lg overflow-hidden">
                    <div
                      className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors"
                      onClick={() => toggleItem(item.id)}
                    >
                      <div className="flex items-center gap-3">
                        <span className={`text-xs font-bold px-2 py-1 rounded border ${item.type === 'radio' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-slate-100 text-slate-500 border-slate-200'}`}>{item.type === 'text' ? 'テキスト' : item.type === 'radio' ? 'ラジオボタン' : item.type === 'select' ? 'プルダウン' : item.type === 'checkbox' ? 'チェックボックス' : item.type === 'textarea' ? '長文' : item.type}</span>
                        <span className="font-bold text-slate-700">{item.label}</span>
                        {item.required && <span className="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">必須</span>}
                        {item.condition && <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold flex items-center gap-1"><GitBranch size={10} /> 分岐あり</span>}
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={(e) => { e.stopPropagation(); deleteItem(item.id); }} className="p-2 text-slate-300 hover:text-red-500 rounded hover:bg-red-50 transition-colors"><Trash2 size={16} /></button>
                        {expandedItems[item.id] ? <ChevronUp size={16} className="text-slate-400" /> : <ChevronDown size={16} className="text-slate-400" />}
                      </div>
                    </div>

                    {expandedItems[item.id] && (
                      <div className="p-4 bg-slate-50 border-t border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                        <div className="md:col-span-2">
                          <label className="block text-xs font-bold text-slate-400 mb-1">質問ラベル</label>
                          <input className="w-full border p-2 rounded text-sm" value={item.label} onChange={e => updateItem(item.id, 'label', e.target.value)} />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-slate-400 mb-1">回答タイプ</label>
                          <select className="w-full border p-2 rounded text-sm bg-white" value={item.type} onChange={e => updateItem(item.id, 'type', e.target.value)}>
                            <option value="text">テキスト入力 (1行)</option>
                            <option value="textarea">テキスト入力 (複数行)</option>
                            <option value="radio">ラジオボタン (1つ選択)</option>
                            <option value="checkbox">チェックボックス (複数選択)</option>
                            <option value="select">プルダウン (1つ選択)</option>
                            <option value="email">メールアドレス</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-slate-400 mb-1">必須設定</label>
                          <div className="flex items-center gap-2 mt-2">
                            <input type="checkbox" checked={item.required || false} onChange={e => updateItem(item.id, 'required', e.target.checked)} className="w-4 h-4 text-blue-600 rounded" />
                            <span className="text-sm font-bold text-slate-700">必須にする</span>
                          </div>
                        </div>
                        <div className="md:col-span-2">
                          <label className="block text-xs font-bold text-slate-400 mb-1">補足説明 (Help Text)</label>
                          <input className="w-full border p-2 rounded text-sm" value={item.help || ''} onChange={e => updateItem(item.id, 'help', e.target.value)} />
                        </div>
                        {(item.type === 'select' || item.type === 'radio' || item.type === 'checkbox') && (
                          <div className="md:col-span-2 bg-white p-4 rounded border border-slate-200">
                            <label className="block text-xs font-bold text-slate-400 mb-2">選択肢設定</label>
                            <div className="space-y-2">
                              {(item.options || []).map((opt, idx) => (
                                <div key={idx} className="flex gap-2">
                                  <input
                                    className="flex-1 border p-2 rounded text-sm"
                                    value={opt}
                                    onChange={e => updateOptionText(item.id, idx, e.target.value)}
                                  />
                                  <button
                                    onClick={() => removeOption(item.id, idx)}
                                    className="bg-red-50 text-red-500 p-2 rounded hover:bg-red-100"
                                    title="削除"
                                  >
                                    <Trash2 size={16} />
                                  </button>
                                </div>
                              ))}
                              <button
                                onClick={() => addOption(item.id)}
                                className="w-full py-2 border-2 border-dashed border-slate-300 rounded text-slate-400 text-sm font-bold hover:bg-slate-50 hover:border-slate-400 flex items-center justify-center gap-2 transition-colors"
                              >
                                <Plus size={16} /> 選択肢を追加
                              </button>
                            </div>
                          </div>
                        )}

                        {/* Conditional Logic UI */}
                        <div className="md:col-span-2 bg-amber-50 p-4 rounded border border-amber-200 mt-2">
                          <div className="flex items-center justify-between mb-2">
                            <label className="text-xs font-bold text-amber-800 flex items-center gap-2"><GitBranch size={14} /> 表示条件設定 (条件付きで表示)</label>
                            <div className="flex items-center gap-2">
                              <input
                                type="checkbox"
                                checked={!!item.condition}
                                onChange={e => updateCondition(item.id, 'enabled', e.target.checked)}
                                className="w-4 h-4 text-amber-600 rounded"
                              />
                              <span className="text-xs font-bold text-amber-700">条件を有効にする</span>
                            </div>
                          </div>

                          {item.condition && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2 animate-fade-in">
                              <div>
                                <label className="block text-[10px] font-bold text-amber-600 mb-1">この質問の回答が...</label>
                                <select
                                  className="w-full border p-2 rounded text-xs bg-white"
                                  value={item.condition.targetId}
                                  onChange={e => updateCondition(item.id, 'targetId', e.target.value)}
                                >
                                  <option value="">(質問を選択)</option>
                                  {getOtherItems(item.id).map(opt => (
                                    <option key={opt.id} value={opt.id}>{opt.label.length > 15 ? opt.label.substring(0, 15) + '...' : opt.label}</option>
                                  ))}
                                </select>
                              </div>
                              <div>
                                <label className="block text-[10px] font-bold text-amber-600 mb-1">条件 (一致/不一致)</label>
                                <select
                                  className="w-full border p-2 rounded text-xs bg-white"
                                  value={item.condition.operator}
                                  onChange={e => updateCondition(item.id, 'operator', e.target.value)}
                                >
                                  <option value="eq">と等しい時 (Equals)</option>
                                  <option value="neq">と異なる時 (Not Equals)</option>
                                </select>
                              </div>
                              <div>
                                <label className="block text-[10px] font-bold text-amber-600 mb-1">対象の値</label>
                                {item.condition.targetId && (getOptionsForTarget(item.condition.targetId).length > 0) ? (
                                  <select
                                    className="w-full border p-2 rounded text-xs bg-white"
                                    value={item.condition.value}
                                    onChange={e => updateCondition(item.id, 'value', e.target.value)}
                                  >
                                    <option value="">(値を選択)</option>
                                    {getOptionsForTarget(item.condition.targetId).map(val => (
                                      <option key={val} value={val}>{val}</option>
                                    ))}
                                  </select>
                                ) : (
                                  <input
                                    className="w-full border p-2 rounded text-xs"
                                    placeholder="値を入力"
                                    value={item.condition.value}
                                    onChange={e => updateCondition(item.id, 'value', e.target.value)}
                                  />
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                <button
                  onClick={addItem}
                  className="w-full py-3 bg-blue-50 border-2 border-blue-200 border-dashed rounded-xl text-blue-600 font-bold hover:bg-blue-100 hover:border-blue-300 transition-colors flex items-center justify-center gap-2"
                >
                  <Plus size={20} /> 新しい質問を追加
                </button>
              </div>
            </div>
          )}
        </div>
        <div className="p-4 border-t flex justify-end gap-2 bg-white">
          <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200">キャンセル</button>
          <button onClick={() => onSave(localConfig)} className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg">設定を保存</button>
        </div>
      </div>
    </div>
  );
}

function MakerResponseForm({ config, onClose, onSubmit }) {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({ companyName: '', companyNameKana: '', repName: '', phone: '', email: '', status: '', moveInDate: '前日搬入', boothCount: '1コマ', staffCount: '1', lunchCount: '1', itemsDesk: '1', itemsChair: '2', itemsPower: '不要', powerDetail: '', transport: '使用しない', packages: '0', payment: '仕入れより相殺', billIssue: '必要', products: '', note: '', declineReason: '' });

  const checkCondition = (item) => {
    if (!item.condition) return true;
    const { targetId, operator, value } = item.condition;
    // Check if target question exists in current form data
    const targetValue = formData[targetId];

    if (operator === 'eq') return targetValue === value;
    if (operator === 'neq') return targetValue !== value;
    // Fallback
    return true;
  };

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    // Find the item to determine its type for special handling (e.g., checkbox)
    let item = null;
    for (const sectionKey in config) {
      if (config[sectionKey] && config[sectionKey].items) {
        item = config[sectionKey].items.find(i => i.id === name);
        if (item) break;
      }
    }

    if (item && item.type === 'checkbox') {
      const currentValues = formData[name] || [];
      if (checked) {
        setFormData({ ...formData, [name]: [...currentValues, value] });
      } else {
        setFormData({ ...formData, [name]: currentValues.filter(v => v !== value) });
      }
    } else {
      setFormData({ ...formData, [name]: value });
    }
  };

  const handleNext = () => {
    if (step === 1) {
      // Basic validation for system fields
      const requiredFields = config.section1.items.filter(i => {
        if (!i.required) return false;
        // Ignore hidden fields from validation
        return checkCondition(i);
      }).map(i => i.id);

      const isInvalid = requiredFields.some(id => {
        const item = config.section1.items.find(i => i.id === id);
        if (item && item.type === 'checkbox') {
          return !formData[id] || formData[id].length === 0;
        }
        return !formData[id];
      });

      if (isInvalid) { alert('必須項目を入力してください'); return; }

      if (formData.status === '出展を申し込む' || formData.status === 'confirmed') setStep(2);
      else if (formData.status === '出展を申し込まない' || formData.status === 'declined') setStep(3);
      else setStep(2); // Fallback if status is not set or unexpected
    }
  };

  const handleSubmit = async () => {
    console.log('[DEBUG] MakerResponseForm.handleSubmit - formData.status:', formData.status);

    const isConfirmed = formData.status === '出展を申し込む' || formData.status === 'confirmed';
    const submitData = {
      ...formData,
      status: isConfirmed ? 'confirmed' : 'declined'
    };

    console.log('[DEBUG] MakerResponseForm.handleSubmit - isConfirmed:', isConfirmed);
    console.log('[DEBUG] MakerResponseForm.handleSubmit - submitData.status:', submitData.status);

    try {
      const result = await onSubmit(submitData);
      if (result) {
        setFormData(prev => ({ ...prev, ...result }));
      }
      setStep(4);
    } catch (e) {
      alert('送信に失敗しました: ' + e.message);
    }
  };

  const handleSendMail = () => {
    const subject = "【回答控え】展示会出展フォーム回答内容";
    const body = `
以下の内容で回答を送信しました。
--------------------------------
会社名: ${formData.companyName}
担当者: ${formData.repName}
出展: ${formData.status}

【詳細】
搬入: ${formData.moveInDate}
コマ数: ${formData.boothCount}
人数: ${formData.staffCount}
--------------------------------
※このメールはご自身のメーラーから送信するための下書きです。
宛先にご自身のメールアドレス (${formData.email}) を入力して送信してください。
    `.trim();
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  };

  // Helper to render individual fields dynamically
  const renderField = (item) => {
    // Check conditional visibility
    if (!checkCondition(item)) return null;

    // STANDARD FIELDS
    return (
      <div key={item.id} className={`${(item.type === 'textarea' || item.type === 'radio' || item.type === 'checkbox') ? 'col-span-2' : ''} animate-fade-in`}>
        <label className="block text-sm font-bold mb-1">
          {item.label} {item.required && <span className="text-red-500">*</span>}
        </label>

        {item.type === 'text' || item.type === 'email' ? (
          <input
            type={item.type}
            name={item.id}
            value={formData[item.id] || ''}
            onChange={handleChange}
            className="w-full border p-3 rounded bg-white shadow-sm"
            placeholder={item.help}
          />
        ) : item.type === 'textarea' ? (
          <textarea
            name={item.id}
            value={formData[item.id] || ''}
            onChange={handleChange}
            className="w-full border p-3 rounded h-24 bg-white shadow-sm"
            placeholder={item.help}
          />
        ) : item.type === 'select' ? (
          <select name={item.id} value={formData[item.id] || ''} onChange={handleChange} className="w-full border p-3 rounded bg-white shadow-sm">
            <option value="">選択してください</option>
            {item.options.map(opt => (
              <option key={opt} value={opt}>{opt}</option>
            ))}
          </select>
        ) : item.type === 'radio' ? (
          <div className="flex flex-wrap gap-4 mt-2">
            {item.options.map(opt => (
              <label key={opt} className={`flex items-center gap-2 cursor-pointer p-3 rounded-lg border transition-colors ${formData[item.id] === opt ? 'bg-blue-50 border-blue-500 shadow-sm' : 'bg-white border-slate-200 hover:border-blue-200'}`}>
                <input type="radio" name={item.id} value={opt} checked={formData[item.id] === opt} onChange={handleChange} className="w-4 h-4 text-blue-600" />
                <span className={`font-bold ${formData[item.id] === opt ? 'text-blue-700' : 'text-slate-700'}`}>{opt}</span>
              </label>
            ))}
          </div>
        ) : item.type === 'checkbox' ? (
          <div className="flex flex-wrap gap-4 mt-2">
            {item.options.map(opt => (
              <label key={opt} className={`flex items-center gap-2 cursor-pointer p-3 rounded-lg border transition-colors ${(formData[item.id] || []).includes(opt) ? 'bg-blue-50 border-blue-500 shadow-sm' : 'bg-white border-slate-200 hover:border-blue-200'}`}>
                <input type="checkbox" name={item.id} value={opt} checked={(formData[item.id] || []).includes(opt)} onChange={handleChange} className="w-4 h-4 text-blue-600 rounded" />
                <span className={`font-bold ${(formData[item.id] || []).includes(opt) ? 'text-blue-700' : 'text-slate-700'}`}>{opt}</span>
              </label>
            ))}
          </div>
        ) : null}

        {item.type !== 'text' && item.type !== 'email' && item.type !== 'textarea' && item.help && (
          <p className="text-xs text-slate-500 mt-1 ml-1">{item.help}</p>
        )}
      </div>
    );
  };

  return (<div className="fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl my-8 border-t-8 border-blue-600 animate-slide-up max-h-[90vh] overflow-y-auto">{step === 1 && (<div className="p-8 space-y-8 animate-fade-in"><div className="bg-slate-50 p-8 border-b border-slate-200 -mx-8 -mt-8 mb-8"><h2 className="text-2xl font-bold text-slate-800 mb-2">{config.section1.title}</h2></div>
    <div className="bg-slate-50 p-6 rounded-lg border border-slate-200"><div className="max-h-60 overflow-y-auto text-sm leading-relaxed text-slate-700 whitespace-pre-wrap">{config.section1.description}</div></div>
    <div className="space-y-6"><h3 className="font-bold text-lg border-b pb-2">基本情報</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {config.section1.items.map(item => renderField(item))}
    </div></div>  <div className="flex justify-between pt-4"><button onClick={onClose} className="text-slate-500 font-bold">閉じる</button><button onClick={handleNext} className="bg-blue-600 text-white font-bold px-12 py-4 rounded-full shadow-lg hover:bg-blue-700 transition-all text-lg">次へ進む</button></div></div>)}{step === 2 && (<div className="p-8 space-y-8 animate-fade-in"><h3 className="font-bold text-xl border-b pb-4 mb-6">{config.section2.title}</h3>{config.section2.description && <div className="bg-slate-50 p-4 rounded text-sm mb-6 whitespace-pre-wrap">{config.section2.description}</div>}<div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {config.section2.items.map(item => renderField(item))}
    </div><div className="flex justify-between pt-6 border-t mt-6"><button onClick={() => setStep(1)} className="text-slate-500 font-bold px-6 py-3">戻る</button><button onClick={handleSubmit} className="bg-blue-600 text-white font-bold px-12 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-all">上記内容で送信する</button></div></div>)}{step === 3 && (<div className="p-8 space-y-6 animate-fade-in"><div className="bg-slate-50 p-6 rounded-xl text-center"><h3 className="font-bold text-lg mb-2">{config.section3.title}</h3><p className="text-sm text-slate-600 mb-4 whitespace-pre-wrap">{config.section3.description}</p></div>
      {config.section3.items.map(item => renderField(item))}
      <div className="flex justify-between pt-6 border-t"><button onClick={() => setStep(1)} className="text-slate-500 font-bold px-6 py-3">戻る</button><button onClick={handleSubmit} className="bg-slate-600 text-white font-bold px-12 py-3 rounded-full shadow-lg hover:bg-slate-700 transition-all">送信する</button></div></div>)}{step === 4 && (
        <div className="p-8 text-center animate-fade-in flex flex-col items-center justify-center">
          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-500 mb-6 animate-bounce"><Check size={40} strokeWidth={4} /></div>

          {/* ステータスに応じたメッセージ */}
          {formData.status === '出展を申し込む' || formData.status === 'confirmed' ? (
            <div className="mb-6">
              <h3 className="text-2xl font-bold text-green-700 mb-2">{formData.companyName || '貴社'}</h3>
              <p className="text-xl font-bold text-slate-800">参加登録完了</p>
              <p className="text-slate-600 mt-2">ご参加いただきありがとうございます。<br />追って登録いただいたメールアドレスに確定メールをお送りいたします。</p>

              {/* QRコード表示エリアは削除 */}

              {/* 強烈な注意書き */}
              <div className="mt-8 bg-blue-50 border border-blue-200 p-4 rounded-xl text-left max-w-md mx-auto">
                <div className="flex items-start gap-3">
                  <Info className="text-blue-600 shrink-0 mt-1" size={24} />
                  <div>
                    <h4 className="font-bold text-blue-800 text-lg">今後の流れ</h4>
                    <p className="text-blue-700 font-bold mt-1">別途、出展者専用ダッシュボードのURLをご案内いたします。</p>
                    <p className="text-blue-600 text-sm mt-2">
                      ※この画面を閉じてしまっても問題ありません。<br />
                      登録内容の控えメールをご確認ください。
                    </p>
                  </div>
                </div>
              </div>

            </div>
          ) : (
            <div className="mb-6">
              <h3 className="text-2xl font-bold text-slate-700 mb-2">ご回答ありがとうございました</h3>
              <p className="text-slate-500">ご検討いただきありがとうございました。</p>
            </div>
          )}

          {/* 回答内容のコピー */}
          <div className="text-left bg-slate-50 p-6 rounded-xl mb-6 w-full max-w-lg border border-slate-200">
            <p className="text-sm font-bold text-slate-700 mb-4 text-center border-b pb-2">【回答内容の控え】</p>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between border-b border-slate-100 pb-1">
                <span className="text-slate-500">会社名</span>
                <span className="font-bold text-slate-800">{formData.companyName || '-'}</span>
              </div>
              <div className="flex justify-between border-b border-slate-100 pb-1">
                <span className="text-slate-500">ご担当者名</span>
                <span className="font-bold text-slate-800">{formData.repName || '-'}</span>
              </div>
              <div className="flex justify-between border-b border-slate-100 pb-1">
                <span className="text-slate-500">電話番号</span>
                <span className="font-bold text-slate-800">{formData.phone || '-'}</span>
              </div>
              <div className="flex justify-between border-b border-slate-100 pb-1">
                <span className="text-slate-500">メールアドレス</span>
                <span className="font-bold text-slate-800">{formData.email || '-'}</span>
              </div>
              <div className="flex justify-between border-b border-slate-100 pb-1">
                <span className="text-slate-500">出展可否</span>
                <span className={`font-bold ${formData.status === '出展を申し込む' || formData.status === 'confirmed' ? 'text-green-600' : 'text-slate-500'}`}>
                  {formData.status === '出展を申し込む' || formData.status === 'confirmed' ? '参加' : '不参加'}
                </span>
              </div>
              {(formData.status === '出展を申し込む' || formData.status === 'confirmed') && (
                <>
                  <div className="flex justify-between border-b border-slate-100 pb-1">
                    <span className="text-slate-500">搬入日時</span>
                    <span className="font-bold text-slate-800">{formData.moveInDate || '-'}</span>
                  </div>
                  <div className="flex justify-between border-b border-slate-100 pb-1">
                    <span className="text-slate-500">希望コマ数</span>
                    <span className="font-bold text-slate-800">{formData.boothCount || '-'}</span>
                  </div>
                  <div className="flex justify-between border-b border-slate-100 pb-1">
                    <span className="text-slate-500">参加人数</span>
                    <span className="font-bold text-slate-800">{formData.staffCount || '-'}名</span>
                  </div>
                  <div className="flex justify-between border-b border-slate-100 pb-1">
                    <span className="text-slate-500">電源</span>
                    <span className="font-bold text-slate-800">{formData.itemsPower || '-'}</span>
                  </div>
                </>
              )}
            </div>

            {/* コピー・保存ボタン */}
            <div className="flex gap-2 mt-4">
              <button
                onClick={() => {
                  const copyText = `【回答内容の控え】
会社名: ${formData.companyName || '-'}
ご担当者名: ${formData.repName || '-'}
電話番号: ${formData.phone || '-'}
メールアドレス: ${formData.email || '-'}
出展可否: ${formData.status === '出展を申し込む' || formData.status === 'confirmed' ? '参加' : '不参加'}
${formData.status === '出展を申し込む' || formData.status === 'confirmed' ? `搬入日時: ${formData.moveInDate || '-'}
希望コマ数: ${formData.boothCount || '-'}
参加人数: ${formData.staffCount || '-'}名
電源: ${formData.itemsPower || '-'}` : ''}`;
                  navigator.clipboard.writeText(copyText);
                  alert('回答内容をクリップボードにコピーしました！');
                }}
                className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
              >
                <Copy size={18} /> 回答をコピー
              </button>
              <button
                onClick={() => {
                  alert('このページのスクリーンショットを撮影して保存してください。\n\niPhone: 電源+音量上ボタン\nAndroid: 電源+音量下ボタン\nPC: PrtScキー または Windows+Shift+S');
                }}
                className="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
              >
                <Camera size={18} /> 画像保存の案内
              </button>
            </div>
            <p className="text-xs text-slate-400 mt-2 text-center">※コピーしたテキストをメモアプリ等に貼り付けて保存してください</p>
          </div>

          <button onClick={() => { if (onClose) onClose(); }} className="mt-4 px-8 py-3 bg-slate-200 hover:bg-slate-300 rounded-lg font-bold text-slate-700">閉じる</button>
        </div>
      )}</div></div>);
}

function MakerDetailModal({ maker, onClose, onSave }) {
  const [isEditing, setIsEditing] = useState(false);
  const [editData, setEditData] = useState({ ...maker });

  const handleSave = () => {
    if (onSave) onSave(editData);
    setIsEditing(false);
  };

  const EditableField = ({ label, field, type = 'text' }) => (
    <div className="mb-3">
      <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>
      {isEditing ? (
        <input
          type={type}
          className="w-full border p-2 rounded text-sm"
          value={editData[field] || ''}
          onChange={e => setEditData({ ...editData, [field]: e.target.value })}
        />
      ) : (
        <p className="text-sm text-slate-800">{maker[field] || '-'}</p>
      )}
    </div>
  );

  return (
    <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up">
        <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-start sticky top-0">
          <div>
            <h3 className="text-2xl font-bold text-slate-800">{maker.companyName}</h3>
            <div className="flex gap-2 mt-2">
              <span className={`px-2 py-0.5 rounded text-xs font-bold uppercase ${maker.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>{maker.status}</span>
              <span className="text-slate-500 text-sm font-mono">{maker.code}</span>
            </div>
          </div>
          <div className="flex gap-2">
            {!isEditing ? (
              <button onClick={() => setIsEditing(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-1"><Edit3 size={16} /> 編集</button>
            ) : (
              <>
                <button onClick={() => { setEditData({ ...maker }); setIsEditing(false); }} className="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm">キャンセル</button>
                <button onClick={handleSave} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-1"><Save size={16} /> 保存</button>
              </>
            )}
            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
          </div>
        </div>
        <div className="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
          <div className="space-y-4">
            <h4 className="font-bold text-slate-500 border-b pb-2 mb-4">基本情報</h4>
            <EditableField label="会社名" field="companyName" />
            <EditableField label="フリガナ" field="companyNameKana" />
            <EditableField label="担当者名" field="repName" />
            <EditableField label="電話番号" field="phone" type="tel" />
            <EditableField label="メールアドレス" field="email" type="email" />
            <EditableField label="支払い方法" field="payment" />
            <EditableField label="請求書発行" field="billIssue" />
          </div>
          <div className="space-y-4">
            <h4 className="font-bold text-slate-500 border-b pb-2 mb-4">出展詳細</h4>
            <EditableField label="搬入日時" field="moveInDate" />
            <div className="grid grid-cols-2 gap-4">
              <EditableField label="希望コマ数" field="boothCount" />
              <EditableField label="参加人数" field="staffCount" />
            </div>
            <EditableField label="昼食(必要数)" field="lunchCount" />
            <div className="bg-slate-50 p-4 rounded-lg space-y-3">
              <p className="font-bold text-sm text-slate-700 mb-2">備品・設備</p>
              <EditableField label="長机" field="itemsDesk" />
              <EditableField label="椅子" field="itemsChair" />
              <EditableField label="電源" field="itemsPower" />
              <EditableField label="電源詳細" field="powerDetail" />
            </div>
          </div>
          <div className="col-span-1 md:col-span-2 space-y-4">
            <h4 className="font-bold text-slate-500 border-b pb-2 mb-4">搬出・展示品・その他</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <EditableField label="運送便利用" field="transport" />
              <EditableField label="出荷個口数" field="packages" />
            </div>
            <EditableField label="展示予定品" field="products" />
            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
              <label className="block text-xs font-bold text-yellow-700 mb-1">特記事項 / 備考</label>
              {isEditing ? (
                <textarea className="w-full border p-2 rounded text-sm" rows="3" value={editData.note || ''} onChange={e => setEditData({ ...editData, note: e.target.value })} />
              ) : (
                <p className="text-sm text-yellow-900">{maker.note || 'なし'}</p>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function VisitorFormEditor({ config, onSave }) {
  const [localConfig, setLocalConfig] = useState(JSON.parse(JSON.stringify(config)));
  const [newItemName, setNewItemName] = useState('');
  const updateField = (key, val) => setLocalConfig({ ...localConfig, [key]: val });
  const updateItem = (id, key, val) => {
    const newItems = localConfig.items.map(item => item.id === id ? { ...item, [key]: val } : item);
    setLocalConfig({ ...localConfig, items: newItems });
  };
  const deleteItem = (id) => { if (window.confirm('削除しますか？')) setLocalConfig({ ...localConfig, items: localConfig.items.filter(i => i.id !== id) }); };
  const addItem = () => { if (!newItemName) return; setLocalConfig({ ...localConfig, items: [...localConfig.items, { id: `custom-${Date.now()}`, label: newItemName, type: 'text', help: '', required: false }] }); setNewItemName(''); };

  return (
    <div className="animate-fade-in max-w-3xl mx-auto">
      <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-slate-800">登録フォーム編集</h2><button onClick={() => onSave(localConfig)} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"><Save size={18} /> 保存する</button></div>
      <div className="bg-white border border-slate-200 rounded-xl p-6 mb-6 shadow-sm"><div className="space-y-4"><div><label className="block text-sm font-bold text-slate-500 mb-1">フォームタイトル</label><input className="w-full border p-2 rounded" value={localConfig.title} onChange={e => updateField('title', e.target.value)} /></div><div><label className="block text-sm font-bold text-slate-500 mb-1">説明文</label><textarea className="w-full border p-2 rounded h-24" value={localConfig.description} onChange={e => updateField('description', e.target.value)} /></div></div></div>
      <div className="bg-slate-50 border border-slate-200 rounded-xl p-6"><h3 className="font-bold text-slate-700 border-b pb-2 mb-4">質問項目</h3><div className="space-y-3">{localConfig.items.map((item, idx) => (<div key={item.id} className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm group"><div className="flex justify-between items-start mb-2"><span className="text-xs font-bold text-slate-400">項目 {idx + 1} ({item.type})</span><button onClick={() => deleteItem(item.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={16} /></button></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-xs font-bold mb-1">質問ラベル</label><input className="w-full border p-2 rounded text-sm" value={item.label} onChange={e => updateItem(item.id, 'label', e.target.value)} /></div><div><label className="block text-xs font-bold mb-1">補足説明</label><input className="w-full border p-2 rounded text-sm" value={item.help || ''} onChange={e => updateItem(item.id, 'help', e.target.value)} /></div></div><div className="mt-2 flex items-center gap-2"><label className="flex items-center gap-1 text-sm cursor-pointer"><input type="checkbox" checked={item.required} onChange={e => updateItem(item.id, 'required', e.target.checked)} /> 必須項目</label>{item.type === 'select' && (<div className="flex-1 ml-4"><label className="block text-xs font-bold mb-1">選択肢 (カンマ区切り)</label><input className="w-full border p-1 rounded text-xs" value={item.options ? item.options.join(',') : ''} onChange={e => updateItem(item.id, 'options', e.target.value.split(','))} /></div>)}</div></div>))}</div><div className="mt-6 flex gap-2"><input className="flex-1 border p-2 rounded" placeholder="新しい質問タイトル..." value={newItemName} onChange={e => setNewItemName(e.target.value)} /><button onClick={addItem} className="bg-slate-700 text-white px-4 py-2 rounded font-bold text-sm">新規追加</button></div></div>
    </div>
  );
}

function SimulatedPublicVisitorForm({ config, onClose, onSubmit }) {
  const [formData, setFormData] = useState({});
  const handleChange = (id, val) => { setFormData({ ...formData, [id]: val }); };
  const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };

  return (
    <div className="fixed inset-0 bg-slate-900/90 z-[90] flex items-center justify-center p-4 overflow-y-auto">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg my-8 overflow-hidden animate-slide-up relative">
        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X /></button>
        <div className="bg-blue-600 p-8 text-white"><h2 className="text-2xl font-bold mb-2">{config.title}</h2><p className="text-blue-100 text-sm">{config.description}</p></div>
        <form onSubmit={handleSubmit} className="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
          {config.items.map(item => (<div key={item.id}><label className="block text-sm font-bold text-slate-700 mb-1">{item.label} {item.required && <span className="text-red-500">*</span>}</label>{item.type === 'select' ? (<select required={item.required} className="w-full border border-slate-300 p-3 rounded-lg bg-white outline-none" onChange={e => handleChange(item.id, e.target.value)}><option value="">選択してください</option>{item.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>) : (<input type={item.type} required={item.required} className="w-full border border-slate-300 p-3 rounded-lg outline-none" placeholder={item.help} onChange={e => handleChange(item.id, e.target.value)} />)}{item.help && item.type !== 'text' && <p className="text-xs text-slate-400 mt-1">{item.help}</p>}</div>))}
          <div className="pt-4"><button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"><QrCode size={20} /> 登録して入場QRを発行</button></div>
        </form>
      </div>
    </div>
  );
}

// ============================================================================
// 3. Maker Dashboard (New)
// ============================================================================
function MakerDashboard({ maker, onScan, scanLogs, exhibitionName }) {
  const [tab, setTab] = useState('scanner');
  const [scanResult, setScanResult] = useState(null); // { success, type, message, visitor }
  const [isScanning, setIsScanning] = useState(false); // Start false, enable after mount

  // Delay scanner activation to ensure camera is ready
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsScanning(true);
    }, 500); // Wait 500ms for camera to initialize
    return () => clearTimeout(timer);
  }, []);

  const handleScan = async (result) => {
    // 1. isScanning Check
    if (!isScanning) return;
    if (!result || result.length === 0) return;

    const rawValue = result[0]?.rawValue;
    if (rawValue) {
      console.log('[DEBUG] Scan Detected:', rawValue);

      // Stop scanning IMMEDIATELY
      setIsScanning(false);
      // Sound removed by request

      // Process scan
      const res = await onScan(rawValue);
      console.log('[DEBUG] Scan Result:', res);

      // Show Result Modal (Manual Resume)
      if (res) {
        setScanResult(res);
      } else {
        // Fallback if no result returned (should not happen with new logic)
        setScanResult({ success: false, type: 'error', message: 'Unknown error' });
      }
    }
  };

  const handleNextScan = () => {
    setScanResult(null);
    setIsScanning(true);
  };

  const myLogs = (scanLogs || []).filter(log => log.makerId === (maker.id || maker.code));

  // Prepare CSV (Export ALL visitor data)
  const downloadHistoryCSV = () => {
    const data = myLogs.map(log => {
      const snapshot = log.visitorSnapshot || {};
      // Exclude internal fields like 'id', 'status', 'registeredAt'
      const { id, status, registeredAt, ...visitorData } = snapshot;
      return {
        '来訪日時': new Date(log.scannedAt).toLocaleString(),
        ...visitorData // Include ALL other visitor fields dynamically
      };
    });

    if (!data.length) return;
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
    ].join('\n');
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `visit_history_${maker.companyName}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-100 pb-20">
      {/* Header */}
      <div className="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md">
        <h1 className="text-lg font-bold truncate">{exhibitionName}</h1>
        <div className="flex justify-between items-center mt-1">
          <p className="text-xs text-slate-400">{maker.companyName} 様</p>
          <button onClick={() => window.location.reload()} className="text-xs bg-slate-800 px-2 py-1 rounded border border-slate-700"><RefreshCcw size={12} /> リロード</button>
        </div>
      </div>

      <div className="p-4">
        <div className="flex bg-white rounded-lg p-1 mb-4 shadow-sm border border-slate-200">
          <button onClick={() => setTab('scanner')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-colors flex items-center justify-center gap-1 ${tab === 'scanner' ? 'bg-blue-600 text-white shadow' : 'text-slate-500'}`}><ScanLine size={16} /> スキャナー</button>
          <button onClick={() => setTab('history')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-colors flex items-center justify-center gap-1 ${tab === 'history' ? 'bg-blue-600 text-white shadow' : 'text-slate-500'}`}><List size={16} /> 履歴 ({myLogs.length})</button>
        </div>

        {tab === 'scanner' && (
          <div className="animate-fade-in space-y-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative">

              {/* Result Overlay */}
              {scanResult && (
                <div className="absolute inset-0 z-20 bg-white/95 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center p-6 animate-fade-in">
                  <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${scanResult.type === 'success' ? 'bg-green-100 text-green-600' : scanResult.type === 'warning' ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}`}>
                    {scanResult.type === 'success' ? <Check size={40} strokeWidth={3} /> : scanResult.type === 'warning' ? <AlertCircle size={40} /> : <X size={40} strokeWidth={3} />}
                  </div>
                  <h3 className="text-xl font-bold text-slate-800 mb-2">{scanResult.type === 'success' ? 'スキャン完了' : scanResult.type === 'warning' ? '登録済み' : 'エラー'}</h3>
                  <p className="text-center text-slate-600 mb-6 font-medium whitespace-pre-wrap">{scanResult.message}</p>

                  {scanResult.visitor && (
                    <div className="bg-slate-50 p-3 rounded-lg w-full mb-6 border border-slate-200">
                      <p className="text-xs text-slate-500">会社名</p>
                      <p className="font-bold text-slate-800 mb-2">{scanResult.visitor.companyName}</p>
                      <p className="text-xs text-slate-500">氏名</p>
                      <p className="font-bold text-slate-800">{scanResult.visitor.repName}</p>
                    </div>
                  )}

                  <button onClick={handleNextScan} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-transform active:scale-95 flex items-center justify-center gap-2">
                    <ScanLine size={20} /> 次をスキャン
                  </button>
                </div>
              )}

              <div className="aspect-square bg-black rounded-lg overflow-hidden relative">
                {isScanning && !scanResult ? (
                  <Scanner
                    onScan={handleScan}
                    components={{ audio: false, finder: false }}
                    formats={['qr_code']}
                    scanDelay={50}
                    styles={{ container: { width: '100%', height: '100%' } }}
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center bg-slate-900 text-white">
                    <div className="text-center">
                      <p className="text-xs text-slate-400">Camera Paused</p>
                    </div>
                  </div>
                )}

                {/* Visual Guide (Only when scanning) */}
                {isScanning && !scanResult && (
                  <div className="absolute inset-0 border-2 border-white/30 pointer-events-none flex items-center justify-center">
                    <div className="w-64 h-64 border-2 border-blue-400/80 rounded-lg relative">
                      <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-500"></div>
                      <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-500"></div>
                      <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-500"></div>
                      <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-500"></div>
                    </div>
                  </div>
                )}
              </div>
              <p className="text-center text-xs text-slate-500 mt-2">QRコードをフレーム内に収めてください</p>
            </div>

            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl">
              <h3 className="font-bold text-blue-800 mb-2 text-sm flex items-center gap-2"><Info size={16} /> 使い方</h3>
              <ul className="text-xs text-blue-700 space-y-1 list-disc pl-4">
                <li>来場者のQRコードをカメラにかざしてください。</li>
                <li>読み取り成功時に音が鳴ります（マナーモード注意）。</li>
                <li>読み取ったデータは自動で履歴に保存されます。</li>
              </ul>
            </div>
          </div>
        )}

        {tab === 'history' && (
          <div className="animate-fade-in">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-slate-700">来訪履歴</h3>
              <button onClick={downloadHistoryCSV} className="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 shadow-sm"><Download size={14} /> CSV出力</button>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              {myLogs.length === 0 ? (
                <div className="p-8 text-center text-slate-400 text-sm">履歴はありません</div>
              ) : (
                <div className="divide-y divide-slate-100">
                  {myLogs.map((log, i) => (
                    <div key={i} className="p-4 hover:bg-slate-50">
                      <div className="flex justify-between mb-1">
                        <span className="font-bold text-slate-800">{log.visitorSnapshot?.companyName || '不明'}</span>
                        <span className="text-xs text-slate-400">{new Date(log.scannedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                      </div>
                      <div className="flex justify-between items-end">
                        <span className="text-sm text-slate-600">{log.visitorSnapshot?.repName || '不明'} 様</span>
                        <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full font-bold">来訪済</span>
                      </div>
                    </div>
                  )).reverse()}
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// Icon helper
const TryIcon = ({ size }) => <div className="w-4 h-4 rounded-full border-2 border-current flex items-center justify-center font-bold text-[10px]">?</div>;

// ============================================================================
// 4. タブ・コンテンツコンポーネント (メイン機能群)
// ============================================================================
const ALL_TAB_DEFINITIONS = [
  { id: 'main', label: 'Main Board', icon: LayoutDashboard },
  { id: 'tasks', label: 'タスク管理', icon: CheckSquare },
  { id: 'schedule', label: 'スケジュール', icon: CalendarDays },
  { id: 'makers', label: '招待メーカー', icon: Users },
  { id: 'entrance', label: '受付用', icon: QrCode },
  { id: 'lectures', label: '講演会', icon: Mic },
  { id: 'equipment', label: '会場・備品', icon: Building2 },
  { id: 'budget', label: '収支・予算', icon: Wallet },
  { id: 'files', label: '資料', icon: FileText }
];
function TabMainBoard({ exhibition, updateMainData, updateBatch, tasks }) {
  const { venueDetails = {}, otherBudgets = [], targetProfit = 0, currentVisitors = 0, targetVisitors = 0, makers = [], visitors = [] } = exhibition || {};
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editFormData, setEditFormData] = useState({ ...exhibition });
  // 日付管理用の独立ステート
  const [datesList, setDatesList] = useState(exhibition.dates || []);
  const [preDatesList, setPreDatesList] = useState(exhibition.preDates || []);

  // Refで最新値を保持（クロージャ対策）
  const datesListRef = useRef(datesList);
  const preDatesListRef = useRef(preDatesList);

  useEffect(() => {
    datesListRef.current = datesList;
  }, [datesList]);

  useEffect(() => {
    preDatesListRef.current = preDatesList;
  }, [preDatesList]);

  // ... (省略) ...



  const [hotelName, setHotelName] = useState('');
  const [hotelUrl, setHotelUrl] = useState('');
  const [selectedMembers, setSelectedMembers] = useState([]);
  const [selectedDates, setSelectedDates] = useState([]);
  const [tempDate, setTempDate] = useState('');

  const venueCost = venueDetails?.cost || 0;
  const equipItems = venueDetails?.equipment || [];
  const budgets = otherBudgets || [];
  const makerList = makers || [];
  const visitorList = visitors || [];
  const hotels = exhibition.hotels || [];

  const equipmentTotal = equipItems.reduce((sum, item) => sum + (item.count * item.price), 0);
  const totalCost = venueCost + equipmentTotal + budgets.reduce((sum, item) => item.type === 'expense' ? sum + item.amount : sum, 0);
  const totalIncome = budgets.reduce((sum, item) => item.type === 'income' ? sum + item.amount : sum, 0);
  const boothIncome = makerList.filter(m => m.status === 'confirmed').reduce((sum, m) => sum + (extractNum(m.boothCount) * 30000), 0);
  const currentBalance = (boothIncome + totalIncome) - totalCost;

  const confirmedMakers = makerList.filter(m => m.status === 'confirmed').length;
  const pendingMakers = makerList.filter(m => m.status === 'listed').length;

  const [isAddingMember, setIsAddingMember] = useState(false);
  const [newMemberName, setNewMemberName] = useState('');
  const [staffName, setStaffName] = useState('');

  const addStaff = () => { if (!staffName.trim()) return; const current = editFormData.staff ? editFormData.staff.split(',').map(s => s.trim()) : []; setEditFormData({ ...editFormData, staff: [...current, staffName].join(', ') }); setStaffName(''); };
  const removeStaff = (name) => { const current = editFormData.staff ? editFormData.staff.split(',').map(s => s.trim()) : []; setEditFormData({ ...editFormData, staff: current.filter(s => s !== name).join(', ') }); };

  // 日付編集用
  const [tempEditDate, setTempEditDate] = useState('');
  const [tempEditPreDate, setTempEditPreDate] = useState('');

  const addEditDate = (type) => {
    if (type === 'main' && tempEditDate) {
      if (!datesList.includes(tempEditDate)) {
        setDatesList([...datesList, tempEditDate].sort());
      }
      setTempEditDate('');
    } else if (type === 'pre' && tempEditPreDate) {
      if (!preDatesList.includes(tempEditPreDate)) {
        setPreDatesList([...preDatesList, tempEditPreDate].sort());
      }
      setTempEditPreDate('');
    }
  };

  const removeEditDate = (type, index) => {
    if (type === 'main') {
      const newDates = [...datesList];
      newDates.splice(index, 1);
      setDatesList(newDates);
    } else {
      const newPreDates = [...preDatesList];
      newPreDates.splice(index, 1);
      setPreDatesList(newPreDates);
    }
  };

  // 未追加の日付入力があれば自動的に追加して保存する
  const handleEditSave = () => {
    // 保存対象外のキーを除外
    const updates = {};
    const excludeKeys = ['tasks', 'venueDetails', 'makers', 'visitors', 'otherBudgets', 'hotels', 'schedule', 'lectures'];

    Object.keys(editFormData).forEach(key => {
      if (!excludeKeys.includes(key)) {
        updates[key] = editFormData[key];
      }
    });

    // 日付データの準備（Ref + 入力中のデータ）
    let finalDates = [...datesListRef.current];
    if (tempEditDate && !finalDates.includes(tempEditDate)) {
      finalDates.push(tempEditDate);
      finalDates.sort();
    }

    let finalPreDates = [...preDatesListRef.current];
    if (tempEditPreDate && !finalPreDates.includes(tempEditPreDate)) {
      finalPreDates.push(tempEditPreDate);
      finalPreDates.sort();
    }

    updates.dates = finalDates;
    updates.preDates = finalPreDates;

    // 入力欄をクリア
    setTempEditDate('');
    setTempEditPreDate('');


    // ★変更内容の差分生成と確認
    const labelMap = { title: 'タイトル', place: '会場名', venueAddress: '住所', openTime: '開場', closeTime: '閉場', targetVisitors: '集客目標', targetMakers: '招致目標', targetProfit: '利益目標', venueUrl: '会場URL', staff: 'スタッフ' };
    let diffText = '';

    // 通常フィールドの比較
    Object.keys(updates).forEach(key => {
      if (key === 'dates' || key === 'preDates') return; // 配列は別途処理
      if (JSON.stringify(exhibition[key]) !== JSON.stringify(updates[key])) {
        diffText += `・${labelMap[key] || key}: ${exhibition[key] || '(空)'} → ${updates[key]}\n`;
      }
    });

    // 日付の比較
    if (JSON.stringify(updates.dates) !== JSON.stringify(exhibition.dates || [])) {
      diffText += `・開催日: ${exhibition.dates?.length || 0}日 → ${updates.dates.length}日 (${updates.dates.join(', ')})\n`;
    }
    if (JSON.stringify(updates.preDates) !== JSON.stringify(exhibition.preDates || [])) {
      diffText += `・前日搬入: ${exhibition.preDates?.length || 0}日 → ${updates.preDates.length}日 (${updates.preDates.join(', ')})\n`;
    }

    if (!diffText) diffText = '変更点はありません。';

    alert(`【設定変更の確認】\n以下の内容で保存します：\n\n${diffText}`);

    console.log('Batch updating settings:', updates);

    // 一括更新実行
    if (updateBatch) {
      updateBatch(updates);
    } else {
      Object.keys(updates).forEach(key => updateMainData(key, updates[key]));
    }

    setIsEditModalOpen(false);
  };

  const addMember = () => { if (!newMemberName) return; updateMainData('staff', exhibition.staff + `, ${newMemberName}`); setNewMemberName(''); setIsAddingMember(false); };

  const removeMember = (nameToRemove) => {
    if (window.confirm(`${nameToRemove} をメンバーから削除しますか？`)) {
      const currentMembers = exhibition.staff.split(',').map(s => s.trim());
      const newMembers = currentMembers.filter(m => m !== nameToRemove).join(', ');
      updateMainData('staff', newMembers);
    }
  };

  const addHotelDate = () => { if (tempDate && !selectedDates.includes(tempDate)) { setSelectedDates([...selectedDates, tempDate].sort()); setTempDate(''); } };
  const toggleHotelMember = (member) => { if (selectedMembers.includes(member)) { setSelectedMembers(selectedMembers.filter(m => m !== member)); } else { setSelectedMembers([...selectedMembers, member]); } };
  const addHotel = () => { if (!hotelName) return; const newHotel = { id: Date.now(), name: hotelName, url: hotelUrl, members: selectedMembers, dates: selectedDates }; updateMainData('hotels', [...hotels, newHotel]); setHotelName(''); setHotelUrl(''); setSelectedMembers([]); setSelectedDates([]); };
  const removeHotel = (id) => { updateMainData('hotels', hotels.filter(h => h.id !== id)); };

  const urgentTasks = (tasks || []).filter(t => { if (t.status === 'done' || !t.dueDate) return false; const diffTime = new Date(t.dueDate) - new Date(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return diffDays >= 0 && diffDays <= 7; });

  const projectMembers = exhibition.staff ? exhibition.staff.split(',').map(s => s.trim()) : [];

  return (
    <div className="p-4 md:p-8 space-y-8 animate-fade-in relative">
      <div className="absolute top-0 right-4 md:right-8"><button onClick={() => {
        setEditFormData({ ...exhibition });
        setDatesList(exhibition.dates || []);
        setPreDatesList(exhibition.preDates || []);
        setIsEditModalOpen(true);
      }} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><Settings size={16} /> 設定変更</button></div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mt-8 md:mt-0">
        <div style={{ background: 'linear-gradient(to bottom right, #3b82f6, #4f46e5)' }} className="text-white rounded-2xl p-6 shadow-lg shadow-blue-500/20"><div className="flex items-center gap-3 mb-2 opacity-80"><Users size={20} /> <span>来場者数</span></div><div className="text-4xl font-bold mb-2">{String(currentVisitors).toLocaleString()}</div><div className="text-sm opacity-80">目標: {Number(targetVisitors).toLocaleString()} ({Number(targetVisitors) > 0 ? (Number(currentVisitors) / Number(targetVisitors) * 100).toFixed(1) : '0.0'}%)</div><div className="mt-4 h-1.5 bg-black/20 rounded-full overflow-hidden"><div className="h-full bg-white/90 rounded-full" style={{ width: `${Number(targetVisitors) > 0 ? Math.min((Number(currentVisitors) / Number(targetVisitors)) * 100, 100) : 0}%` }}></div></div></div>
        <div className="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm"><div className="flex items-center gap-3 mb-2 text-slate-500"><Building2 size={20} /> <span>出展メーカー</span></div><div className="flex items-end gap-2 mb-2"><span className="text-4xl font-bold text-slate-800">{confirmedMakers}</span><span className="text-sm text-slate-400 mb-1">社 (確定)</span></div><div className="text-sm text-amber-500 font-medium">未回答: {pendingMakers}社</div></div>
        <div className="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm"><div className="flex items-center gap-3 mb-2 text-slate-500"><Database size={20} /> <span>事前登録者数</span></div><div className="text-4xl font-bold text-slate-800 mb-2">{visitorList.length} <span className="text-sm text-slate-400 font-normal">名</span></div></div>
        <div className="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm"><div className="flex items-center gap-3 mb-2 text-slate-500"><TrendingUp size={20} /> <span>最終収支</span></div><div className={`text-3xl font-bold mb-2 ${currentBalance >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>¥{currentBalance.toLocaleString()}</div><div className="text-xs text-slate-400">出展費用+雑収入 - 総支出</div></div>
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-red-50 border border-red-100 rounded-xl p-6"><h3 className="font-bold text-red-800 flex items-center gap-2 mb-4"><AlertTriangle size={18} /> 期限が迫っているタスク</h3>{urgentTasks.length === 0 ? (<p className="text-sm text-red-400">現在、期限間近のタスクはありません。</p>) : (<div className="space-y-2">{urgentTasks.map(t => (<div key={t.id} className="bg-white p-3 rounded border border-red-200 flex justify-between items-center"><span className="font-bold text-slate-700">{t.title}</span><span className="text-xs font-bold text-red-500 bg-red-100 px-2 py-1 rounded">期限: {t.dueDate}</span></div>))}</div>)}</div>
          <div className="bg-white border border-slate-200 rounded-xl p-6"><h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><MapPin className="text-blue-500" /> 会場インフォメーション</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="space-y-4"><div><div className="text-xs font-bold text-slate-400 uppercase mb-1">会場名</div><div className="text-lg font-bold text-slate-800">{exhibition.place}</div></div><div><div className="text-xs font-bold text-slate-400 uppercase mb-1">住所</div><div className="text-slate-700">{exhibition.venueAddress || '未設定'}</div></div><div className="flex gap-8"><div><div className="text-xs font-bold text-slate-400 uppercase mb-1">開場</div><div className="font-mono text-lg">{exhibition.openTime}</div></div><div><div className="text-xs font-bold text-slate-400 uppercase mb-1">閉場</div><div className="font-mono text-lg">{exhibition.closeTime}</div></div></div><div className="flex flex-col gap-2">{exhibition.venueUrl && <a href={exhibition.venueUrl} target="_blank" rel="noreferrer" className="text-sm text-blue-500 hover:underline flex items-center gap-1"><ExternalLink size={14} /> 会場Webサイト</a>}{exhibition.googleMapsUrl && <a href={exhibition.googleMapsUrl} target="_blank" rel="noreferrer" className="text-sm text-green-600 hover:underline flex items-center gap-1"><Map size={14} /> Googleマップで開く</a>}</div></div>
            {/* Google Maps 埋め込み */}
            {(exhibition.googleMapsUrl || exhibition.venueUrl?.includes('google')) ? (
              <div className="rounded-xl overflow-hidden border border-slate-200 min-h-[200px]">
                <iframe
                  width="100%"
                  height="200"
                  style={{ border: 0 }}
                  loading="lazy"
                  allowFullScreen
                  referrerPolicy="no-referrer-when-downgrade"
                  src={`https://www.google.com/maps?q=${encodeURIComponent(exhibition.venueAddress || exhibition.place)}&output=embed`}
                ></iframe>
              </div>
            ) : (
              <div className="bg-slate-100 rounded-xl flex flex-col items-center justify-center text-slate-400 border border-slate-200 min-h-[200px] p-4">
                <MapPin size={32} className="mb-2 text-slate-300" />
                <p className="text-sm text-center">GoogleマップのURLを<br />プロジェクト設定に入力すると<br />地図が表示されます</p>
              </div>
            )}
          </div></div>

          <div className="bg-white border border-slate-200 rounded-xl p-6">
            <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><BedDouble className="text-purple-500" /> ホテル予約管理</h3>
            <div className="space-y-4 mb-6">
              {hotels.map(h => (<div key={h.id} className="bg-slate-50 p-4 rounded border border-slate-200 relative"><button onClick={() => removeHotel(h.id)} className="absolute top-2 right-2 text-slate-400 hover:text-red-500"><Trash2 size={16} /></button><div className="font-bold text-slate-800 text-lg mb-1">{h.name}</div>{h.url && <a href={h.url} target="_blank" rel="noreferrer" className="text-xs text-blue-500 hover:underline flex items-center gap-1 mb-2"><ExternalLink size={12} /> {h.url}</a>}<div className="flex flex-wrap gap-2 mb-2 border-t border-slate-200 pt-2">{h.dates && h.dates.map(d => <span key={d} className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-mono">{d}</span>)}</div><div className="flex flex-wrap gap-2">{h.members && h.members.map(m => <span key={m} className="bg-white border border-slate-300 px-2 py-1 rounded-full text-xs flex items-center gap-1"><UserCheck size={10} /> {m}</span>)}</div></div>))}
              {hotels.length === 0 && <p className="text-sm text-slate-400 text-center py-2">予約情報はありません</p>}
            </div>
            <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
              <h4 className="text-xs font-bold text-slate-500 mb-3">新規予約登録</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div><label className="block text-xs font-bold text-slate-500 mb-1">ホテル名</label><input className="w-full border p-2 rounded text-sm" value={hotelName} onChange={e => setHotelName(e.target.value)} placeholder="例: 博多駅前ホテル" /></div>
                <div><label className="block text-xs font-bold text-slate-500 mb-1">URL</label><input className="w-full border p-2 rounded text-sm" value={hotelUrl} onChange={e => setHotelUrl(e.target.value)} placeholder="https://..." /></div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div><label className="block text-xs font-bold text-slate-500 mb-1">宿泊日 (複数可)</label><div className="flex gap-2 mb-2"><input type="date" className="flex-1 border p-2 rounded text-sm" value={tempDate} onChange={e => setTempDate(e.target.value)} /><button onClick={addHotelDate} className="bg-slate-300 px-3 rounded font-bold text-slate-600">+</button></div><div className="flex flex-wrap gap-1">{selectedDates.map(d => <span key={d} className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs">{d}</span>)}</div></div>
                <div><label className="block text-xs font-bold text-slate-500 mb-1">宿泊者 (複数可)</label><div className="flex flex-wrap gap-2 max-h-24 overflow-y-auto p-2 bg-white rounded border">{projectMembers.map(m => (<button key={m} onClick={() => toggleHotelMember(m)} className={`px-2 py-1 rounded text-xs border ${selectedMembers.includes(m) ? 'bg-purple-500 text-white border-purple-500' : 'bg-slate-50 text-slate-600 border-slate-200'}`}>{m}</button>))}</div></div>
              </div>
              <button onClick={addHotel} className="w-full bg-purple-600 text-white py-3 rounded font-bold text-sm hover:bg-purple-700">予約を追加</button>
            </div>
          </div>

        </div>

        <div className="bg-slate-900 text-white p-6 rounded-xl">
          <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center gap-2"><Briefcase size={18} /> Project Members</h3><button onClick={() => setIsAddingMember(!isAddingMember)} className="p-1 hover:bg-slate-800 rounded text-slate-400 hover:text-white"><Plus size={16} /></button></div>
          {isAddingMember && (<div className="flex gap-2 mb-4"><input autoFocus value={newMemberName} onChange={e => setNewMemberName(e.target.value)} className="bg-slate-800 border-none rounded px-2 py-1 text-sm text-white w-full" placeholder="名前を入力" /><button onClick={addMember} className="bg-blue-600 px-3 rounded text-xs font-bold">追加</button></div>)}
          <div className="space-y-3 max-h-[300px] overflow-y-auto">
            {projectMembers.map((member, i) => (<div key={i} className="flex items-center gap-3 group"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${['bg-pink-500', 'bg-orange-500', 'bg-cyan-500'][i % 3]}`}>{member.charAt(0)}</div><span className="flex-1">{member}</span><button onClick={() => removeMember(member)} className="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400 transition-opacity"><X size={14} /></button></div>))}
          </div>
        </div></div>

      {isEditModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-slide-up p-8">
            <h2 className="text-2xl font-bold mb-6 border-b pb-4">プロジェクト設定変更</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label className="block text-sm font-bold mb-1">タイトル</label>
                <input className="w-full border p-2 rounded" value={editFormData.title} onChange={e => setEditFormData({ ...editFormData, title: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">会場名</label>
                <input className="w-full border p-2 rounded" value={editFormData.place} onChange={e => setEditFormData({ ...editFormData, place: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">住所</label>
                <input className="w-full border p-2 rounded" value={editFormData.venueAddress} onChange={e => setEditFormData({ ...editFormData, venueAddress: e.target.value })} />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="block text-sm font-bold mb-1">開場</label>
                  <input type="time" className="w-full border p-2 rounded" value={editFormData.openTime} onChange={e => setEditFormData({ ...editFormData, openTime: e.target.value })} />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">閉場</label>
                  <input type="time" className="w-full border p-2 rounded" value={editFormData.closeTime} onChange={e => setEditFormData({ ...editFormData, closeTime: e.target.value })} />
                </div>
              </div>

              {/* 日程編集セクション */}
              <div className="col-span-2 border-t pt-4 mt-2">
                <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Calendar size={18} className="text-blue-500" /> 日程設定</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-bold text-blue-700 mb-2">開催日</label>
                    <div className="flex gap-2 mb-2">
                      <input type="date" value={tempEditDate} onChange={e => setTempEditDate(e.target.value)} className="flex-1 p-2 border rounded" />
                      <button onClick={() => addEditDate('main')} className="bg-blue-100 text-blue-600 px-3 rounded hover:bg-blue-200"><Plus size={16} /></button>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {datesList.map((d, i) => (
                        <span key={i} className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm flex items-center gap-1 border border-blue-200">
                          {d} <button onClick={() => removeEditDate('main', i)}><X size={12} /></button>
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-amber-700 mb-2">前日搬入日</label>
                    <div className="flex gap-2 mb-2">
                      <input type="date" value={tempEditPreDate} onChange={e => setTempEditPreDate(e.target.value)} className="flex-1 p-2 border rounded" />
                      <button onClick={() => addEditDate('pre')} className="bg-amber-100 text-amber-600 px-3 rounded hover:bg-amber-200"><Plus size={16} /></button>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {preDatesList.map((d, i) => (
                        <span key={i} className="bg-amber-50 text-amber-700 px-2 py-1 rounded text-sm flex items-center gap-1 border border-amber-200">
                          {d} <button onClick={() => removeEditDate('pre', i)}><X size={12} /></button>
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* 目標・URL設定 */}
              <div className="col-span-2 border-t pt-4 mt-2 mb-2">
                <h3 className="font-bold text-slate-700 mb-4">目標・URL設定</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1">集客目標 (人)</label>
                    <input type="number" className="w-full border p-2 rounded" value={editFormData.targetVisitors} onChange={e => setEditFormData({ ...editFormData, targetVisitors: Number(e.target.value) })} />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1">招致メーカー目標 (社)</label>
                    <input type="number" className="w-full border p-2 rounded" value={editFormData.targetMakers} onChange={e => setEditFormData({ ...editFormData, targetMakers: Number(e.target.value) })} />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1">目標粗利額 (円)</label>
                    <input type="number" className="w-full border p-2 rounded" value={editFormData.targetProfit} onChange={e => setEditFormData({ ...editFormData, targetProfit: Number(e.target.value) })} />
                  </div>
                  <div className="col-span-3">
                    <label className="block text-xs font-bold text-slate-500 mb-1">展示会場URL</label>
                    <input type="text" className="w-full border p-2 rounded" value={editFormData.venueUrl} onChange={e => setEditFormData({ ...editFormData, venueUrl: e.target.value })} />
                  </div>
                </div>
              </div>

              {/* スタッフ設定 */}
              <div className="col-span-2">
                <label className="block text-sm font-bold mb-1">運営スタッフ</label>
                <div className="flex gap-2 mb-2">
                  <input value={staffName} onChange={e => setStaffName(e.target.value)} className="border p-1 rounded" placeholder="名前" />
                  <button onClick={addStaff} className="bg-slate-200 px-3 rounded">+</button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {editFormData.staff && editFormData.staff.split(',').filter(s => s).map((s, i) => (
                    <span key={i} className="bg-slate-100 px-2 py-1 rounded flex items-center gap-1 text-sm">
                      {s.trim()} <button onClick={() => removeStaff(s.trim())}><X size={10} /></button>
                    </span>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex justify-end gap-2 border-t pt-4">
              <button onClick={() => setIsEditModalOpen(false)} className="px-4 py-2 bg-slate-200 rounded font-bold text-slate-600">キャンセル</button>
              <button onClick={handleEditSave} className="px-6 py-2 bg-blue-600 rounded font-bold text-white">保存する</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function TabSchedule({ scheduleData, updateMainData, staff, dates, preDates }) {
  const [schedule, setSchedule] = useState(scheduleData || { dayBefore: [], eventDay: [] });
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingEventId, setEditingEventId] = useState(null);
  const [targetDay, setTargetDay] = useState('dayBefore');
  const [targetTime, setTargetTime] = useState(9);
  const [eventTitle, setEventTitle] = useState('');
  const [eventDuration, setEventDuration] = useState(1);
  const [selectedMembers, setSelectedMembers] = useState([]);

  const staffList = staff ? staff.split(',').map(s => s.trim()) : [];
  const hours = Array.from({ length: 24 }, (_, i) => i);

  // 実際の日付ラベル
  const preDateLabel = preDates && preDates.length > 0 ? preDates[0] : null;
  const eventDateLabel = dates && dates.length > 0 ? dates[0] : null;

  const handleCellClick = (day, hour) => {
    setTargetDay(day);
    setTargetTime(hour);
    setEventTitle('');
    setEventDuration(1);
    setSelectedMembers([]);
    setEditingEventId(null);
    setIsModalOpen(true);
  };

  const handleEventClick = (day, event) => {
    setTargetDay(day);
    setTargetTime(event.start);
    setEventTitle(event.title);
    setEventDuration(event.duration);
    setSelectedMembers(event.members || []);
    setEditingEventId(event.id);
    setIsModalOpen(true);
  };

  const saveEvent = () => {
    if (!eventTitle) return;
    let newScheduleData;
    if (editingEventId) {
      const updatedEvents = schedule[targetDay].map(e => e.id === editingEventId ? { ...e, title: eventTitle, start: targetTime, duration: eventDuration, members: selectedMembers } : e);
      newScheduleData = { ...schedule, [targetDay]: updatedEvents };
    } else {
      const newEvent = { id: Date.now(), title: eventTitle, start: targetTime, duration: eventDuration, members: selectedMembers };
      newScheduleData = { ...schedule, [targetDay]: [...(schedule[targetDay] || []), newEvent] };
    }
    setSchedule(newScheduleData);
    updateMainData('schedule', newScheduleData);
    setIsModalOpen(false);
  };

  const deleteEvent = () => {
    if (editingEventId && window.confirm('この予定を削除しますか？')) {
      const newSchedule = { ...schedule, [targetDay]: schedule[targetDay].filter(e => e.id !== editingEventId) };
      setSchedule(newSchedule);
      updateMainData('schedule', newSchedule);
      setIsModalOpen(false);
    }
  };

  const toggleMember = (m) => { setSelectedMembers(prev => prev.includes(m) ? prev.filter(x => x !== m) : [...prev, m]); };

  const renderTimeline = (dayKey, label, colorClass, borderClass) => (
    <div className="flex-1 bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col h-[600px] shadow-sm min-w-[200px]">
      <div className={`p-4 font-bold text-center border-b ${colorClass} text-white`}>{label}</div>
      <div className="flex-1 overflow-y-auto relative scrollbar-thin">
        {hours.map(h => (
          <div key={h} className="h-16 border-b border-slate-100 flex group relative">
            <div className="w-14 text-xs text-slate-400 p-2 text-right border-r bg-slate-50 font-mono">{h}:00</div>
            <div className="flex-1 hover:bg-slate-50 cursor-pointer transition-colors relative" onClick={() => handleCellClick(dayKey, h)}>
              <div className="absolute inset-x-0 top-1/2 border-t border-slate-50 border-dashed"></div>
            </div>
          </div>
        ))}
        {(schedule[dayKey] || []).map(event => (
          <div key={event.id} onClick={(e) => { e.stopPropagation(); handleEventClick(dayKey, event); }} className={`absolute left-16 right-2 rounded p-2 text-xs shadow-md cursor-pointer hover:opacity-90 transition-all overflow-hidden border-l-4 z-10 ${borderClass} bg-white`} style={{ top: `${event.start * 64 + 1}px`, height: `${event.duration * 64 - 2}px` }}>
            <div className="font-bold truncate text-slate-800 text-sm">{event.title}</div>
            <div className="text-slate-500 mb-1">{event.start}:00 - {event.start + event.duration}:00</div>
            <div className="flex flex-wrap gap-1">{event.members.map(m => <span key={m} className="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px] border border-slate-200">{m}</span>)}</div>
          </div>
        ))}
      </div>
    </div>
  );

  return (
    <div className="p-4 md:p-8 h-full">
      <div className="flex flex-col md:flex-row gap-6 h-full overflow-x-auto">
        {/* 前日搬入 - 日付が設定されていない場合はグレーアウト */}
        {preDateLabel ? (
          renderTimeline('dayBefore', `前日搬入 (${preDateLabel})`, 'bg-amber-500', 'border-amber-500')
        ) : (
          <div className="flex-1 bg-slate-100 rounded-xl border border-slate-200 overflow-hidden flex flex-col h-[600px] shadow-sm min-w-[200px] opacity-50">
            <div className="p-4 font-bold text-center border-b bg-slate-400 text-white">前日搬入なし</div>
            <div className="flex-1 flex items-center justify-center text-slate-400 text-sm p-4 text-center">
              <div>
                <p className="font-bold mb-2">前日搬入日が設定されていません</p>
                <p className="text-xs">プロジェクト設定から事前準備日を追加してください</p>
              </div>
            </div>
          </div>
        )}
        {/* 当日 */}
        {renderTimeline('eventDay', `開催当日 (${eventDateLabel || '日付未設定'})`, 'bg-blue-600', 'border-blue-600')}
      </div>
      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl p-6 w-96 shadow-2xl animate-slide-up">
            <h3 className="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2"><Clock size={20} /> {editingEventId ? '予定を編集' : '予定を追加'}</h3>
            <div className="mb-4"><label className="block text-xs font-bold text-slate-500 mb-1">内容</label><input autoFocus className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" value={eventTitle} onChange={e => setEventTitle(e.target.value)} placeholder="例: 全体朝礼" /></div>
            <div className="flex gap-4 mb-4"><div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">開始時間</label><div className="flex items-center border rounded"><input type="number" className="w-full p-2 rounded text-center font-bold text-slate-700 outline-none" value={targetTime} onChange={e => setTargetTime(Number(e.target.value))} min={0} max={23} /><span className="pr-2 text-slate-400">:00</span></div></div><div className="flex-1"><label className="block text-xs font-bold text-slate-500 mb-1">所要時間 (時間)</label><input type="number" className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" value={eventDuration} onChange={e => setEventDuration(Number(e.target.value))} min={1} max={24} /></div></div>
            <div className="mb-6"><label className="block text-xs font-bold text-slate-500 mb-1">担当者 (複数選択可)</label><div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto border p-2 rounded bg-slate-50">{staffList.map(m => (<button key={m} onClick={() => toggleMember(m)} className={`px-2 py-1 rounded-full text-xs border transition-all ${selectedMembers.includes(m) ? 'bg-blue-500 text-white border-blue-500 shadow-sm' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300'}`}>{m}</button>))}</div></div>
            <div className="flex justify-between border-t pt-4">
              {editingEventId ? (<button onClick={deleteEvent} className="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-1"><Trash2 size={16} /> 削除</button>) : (<div></div>)}
              <div className="flex gap-2"><button onClick={() => setIsModalOpen(false)} className="px-4 py-2 bg-slate-100 rounded font-bold text-slate-600 hover:bg-slate-200">キャンセル</button><button onClick={saveEvent} className="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-lg">保存</button></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function TabEquipment({ details, setDetails }) {
  const [newItem, setNewItem] = useState({ name: '長机', count: 1, price: 0 });
  const [isCustomItem, setIsCustomItem] = useState(false);
  const addItem = () => { if (!newItem.name) return; setDetails({ ...details, equipment: [...(details.equipment || []), { ...newItem, id: Date.now() }] }); setNewItem({ name: '長机', count: 1, price: 0 }); setIsCustomItem(false); };
  const removeItem = (id) => { setDetails({ ...details, equipment: details.equipment.filter(i => i.id !== id) }); };
  const equipmentTotal = (details.equipment || []).reduce((sum, item) => sum + (item.count * item.price), 0);
  const [newInternalItem, setNewInternalItem] = useState(''); const [newInternalCount, setNewInternalCount] = useState(1); const [isEditingInternal, setIsEditingInternal] = useState(null); const [editingValue, setEditingValue] = useState('');
  const toggleInternalItem = (id) => { const updated = details.internalSupplies.map(i => i.id === id ? { ...i, checked: !i.checked } : i); setDetails({ ...details, internalSupplies: updated }); };
  const addInternalItem = () => { if (!newInternalItem) return; const newItemObj = { id: `is-${Date.now()}`, name: newInternalItem, count: newInternalCount, checked: false }; setDetails({ ...details, internalSupplies: [...(details.internalSupplies || []), newItemObj] }); setNewInternalItem(''); setNewInternalCount(1); };
  const removeInternalItem = (id) => { setDetails({ ...details, internalSupplies: details.internalSupplies.filter(i => i.id !== id) }); };
  const startEditInternal = (item) => { setIsEditingInternal(item.id); setEditingValue(item.name); };
  const saveEditInternal = (id) => { const updated = details.internalSupplies.map(i => i.id === id ? { ...i, name: editingValue } : i); setDetails({ ...details, internalSupplies: updated }); setIsEditingInternal(null); };
  const updateInternalCount = (id, count) => { const updated = details.internalSupplies.map(i => i.id === id ? { ...i, count: parseInt(count) || 0 } : i); setDetails({ ...details, internalSupplies: updated }); };

  return (
    <div className="p-8 space-y-8">
      <div className="flex justify-between items-center pb-4 border-b border-slate-100"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Building2 className="text-blue-500" /> 会場・備品管理</h3><div className="text-right"><p className="text-xs text-slate-400">備品合計 (レンタル)</p><p className="text-2xl font-bold text-slate-800">¥{equipmentTotal.toLocaleString()}</p></div></div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="md:col-span-1 space-y-4"><div className="bg-slate-50 p-4 rounded-xl border border-slate-200"><label className="block text-sm font-bold text-slate-700 mb-2">会場利用料 (確定)</label><div className="relative"><span className="absolute left-3 top-3 text-slate-400">¥</span><input type="number" value={details.cost} onChange={e => setDetails({ ...details, cost: Number(e.target.value) })} className="w-full pl-8 p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold" /></div></div><div className="border-2 border-dashed border-slate-300 rounded-xl h-48 flex flex-col items-center justify-center bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition-colors cursor-pointer group"><h4 className="font-bold text-slate-500">会場レイアウト</h4><Upload size={32} className="text-slate-400 group-hover:text-blue-500 mb-2 transition-colors" /><p className="text-xs text-slate-500">Upload PDF/Image</p></div><div><label className="block text-sm font-medium text-slate-600 mb-1">注意事項</label><textarea value={details.notes} onChange={e => setDetails({ ...details, notes: e.target.value })} className="w-full p-3 border border-slate-200 rounded-lg bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none text-sm" rows="4" /></div></div>
        <div className="md:col-span-1 border border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm flex flex-col h-[600px]"><div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between"><h4 className="font-bold text-slate-700">レンタル備品リスト</h4><span className="font-bold">¥{equipmentTotal.toLocaleString()}</span></div><div className="p-4 bg-slate-50/50 border-b border-slate-200 flex flex-wrap gap-2 items-end"><div className="flex-1 min-w-[100px]"><label className="text-xs block text-slate-500 mb-1">品名</label>{isCustomItem ? <input type="text" value={newItem.name} onChange={e => setNewItem({ ...newItem, name: e.target.value })} className="w-full p-1 border rounded text-xs" /> : <select value={newItem.name} onChange={e => { if (e.target.value === 'Other') setIsCustomItem(true); else setNewItem({ ...newItem, name: e.target.value }); }} className="w-full p-1 border rounded text-xs bg-white">{EQUIPMENT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}<option value="Other">その他（自由表記）</option></select>}</div><div className="w-16"><label className="text-xs block text-slate-500 mb-1">数量</label><input type="number" value={newItem.count} onChange={e => setNewItem({ ...newItem, count: Number(e.target.value) })} className="w-full p-1 border rounded text-xs" /></div><div className="w-20"><label className="text-xs block text-slate-500 mb-1">単価</label><input type="number" value={newItem.price} onChange={e => setNewItem({ ...newItem, price: Number(e.target.value) })} className="w-full p-1 border rounded text-xs" /></div><button onClick={addItem} className="bg-blue-600 text-white p-1 rounded hover:bg-blue-700"><Plus size={16} /></button></div><div className="flex-1 overflow-y-auto"><table className="w-full text-xs text-left"><thead className="bg-white text-slate-500 sticky top-0 border-b border-slate-100"><tr><th className="p-2">品名</th><th className="p-2">数</th><th className="p-2">単価</th><th className="p-2">小計</th><th className="p-2"></th></tr></thead><tbody>{(details.equipment || []).map(item => (<tr key={item.id} className="border-b border-slate-100 last:border-0 hover:bg-slate-50"><td className="p-2 font-medium">{item.name}</td><td className="p-2">{item.count}</td><td className="p-2">¥{item.price.toLocaleString()}</td><td className="p-2 font-bold">¥{(item.count * item.price).toLocaleString()}</td><td className="p-2 text-right"><button onClick={() => removeItem(item.id)} className="text-slate-400 hover:text-red-500"><Trash2 size={14} /></button></td></tr>))}</tbody></table></div></div>
        <div className="md:col-span-1 border border-emerald-200 rounded-xl overflow-hidden bg-emerald-50/30 shadow-sm flex flex-col h-[600px]"><div className="bg-emerald-100 p-4 border-b border-emerald-200 flex justify-between items-center"><h4 className="font-bold text-emerald-800 flex items-center gap-2"><PackageCheck size={18} /> ケアマックス用意備品</h4><span className="text-xs text-emerald-600 font-bold">{details.internalSupplies?.filter(i => i.checked).length} / {details.internalSupplies?.length || 0}</span></div><div className="p-3 border-b border-emerald-100 flex gap-2 items-end"><div className="flex-1"><input type="text" value={newInternalItem} onChange={e => setNewInternalItem(e.target.value)} className="w-full p-2 border border-emerald-200 rounded text-sm outline-none focus:ring-1 focus:ring-emerald-500" placeholder="備品名..." /></div><div className="w-16"><input type="number" value={newInternalCount} onChange={e => setNewInternalCount(e.target.value)} className="w-full p-2 border border-emerald-200 rounded text-sm outline-none" /></div><button onClick={addInternalItem} className="bg-emerald-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-emerald-700">追加</button></div><div className="flex-1 overflow-y-auto p-2 space-y-1">{(details.internalSupplies || []).map(item => (<div key={item.id} className={`flex items-center gap-2 p-3 rounded-lg border transition-all ${item.checked ? 'bg-emerald-100 border-emerald-200' : 'bg-white border-red-100 border-l-4 border-l-red-400'}`}><button onClick={() => toggleInternalItem(item.id)} className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${item.checked ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-300'}`}>{item.checked && <Check size={12} strokeWidth={4} />}</button><div className="flex-1">{isEditingInternal === item.id ? (<input autoFocus value={editingValue} onChange={e => setEditingValue(e.target.value)} onBlur={() => saveEditInternal(item.id)} onKeyDown={e => e.key === 'Enter' && saveEditInternal(item.id)} className="w-full p-1 border rounded text-sm" />) : (<span onClick={() => startEditInternal(item)} className={`text-sm font-medium cursor-pointer hover:underline ${item.checked ? 'text-emerald-800' : 'text-slate-700'}`}>{item.name}</span>)}</div><input type="number" value={item.count || 1} onChange={e => updateInternalCount(item.id, e.target.value)} className="w-12 p-1 border rounded text-xs text-center" /><button onClick={() => removeInternalItem(item.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={14} /></button></div>))}</div></div>
      </div>
    </div>
  );
}

function TabBudget({ exhibition, updateMainData }) {
  const { venueDetails, otherBudgets, makers, targetProfit, lectures } = exhibition;
  const equipmentTotal = (venueDetails?.equipment || []).reduce((sum, item) => sum + (item.count * item.price), 0);
  const boothIncome = (makers || []).filter(m => m.status === 'confirmed').reduce((sum, m) => sum + (extractNum(m.boothCount) * 30000), 0);

  // 講演会費用（講演がある場合のみ計算）
  const lectureList = lectures || [];
  const lectureSpeakerFees = lectureList.reduce((sum, l) => sum + (l.speakerFee || 0), 0);
  const lectureTransportFees = lectureList.reduce((sum, l) => sum + (l.transportFee || 0), 0);
  const lectureTotalFees = lectureSpeakerFees + lectureTransportFees;

  const [newItem, setNewItem] = useState({ type: 'expense', item: '', amount: 0, note: '' });
  const [editingId, setEditingId] = useState(null);
  const [editingItemData, setEditingItemData] = useState(null);

  const handleAddItem = () => {
    if (!newItem.item || newItem.amount <= 0) return;
    const updatedBudgets = [...(otherBudgets || []), { ...newItem, id: Date.now() }];
    updateMainData('otherBudgets', updatedBudgets);
    setNewItem({ type: 'expense', item: '', amount: 0, note: '' });
  };

  const removeItem = (id) => {
    if (window.confirm('削除しますか？')) {
      const updatedBudgets = otherBudgets.filter(b => b.id !== id);
      updateMainData('otherBudgets', updatedBudgets);
    }
  };

  const startEdit = (item) => {
    setEditingId(item.id);
    setEditingItemData({ ...item });
  };

  const saveEdit = () => {
    const updatedBudgets = otherBudgets.map(b => b.id === editingId ? editingItemData : b);
    updateMainData('otherBudgets', updatedBudgets);
    setEditingId(null);
  };

  const incomes = (otherBudgets || []).filter(b => b.type === 'income');
  const expenses = (otherBudgets || []).filter(b => b.type === 'expense');
  const totalIncome = boothIncome + incomes.reduce((sum, i) => sum + i.amount, 0);
  const totalExpense = venueDetails.cost + equipmentTotal + lectureTotalFees + expenses.reduce((sum, i) => sum + i.amount, 0);

  const exportCSV = () => {
    const data = [
      { Category: '収入', Item: '出展費用', Amount: boothIncome, Note: '自動計算' },
      ...incomes.map(i => ({ Category: '収入', Item: i.item, Amount: i.amount, Note: i.note })),
      { Category: '支出', Item: '会場利用料', Amount: venueDetails.cost, Note: '管理画面連動' },
      { Category: '支出', Item: '備品費', Amount: equipmentTotal, Note: '備品リスト連動' },
      ...expenses.map(i => ({ Category: '支出', Item: i.item, Amount: i.amount, Note: i.note })),
      { Category: '合計', Item: '収支差額', Amount: totalIncome - totalExpense, Note: '' }
    ];
    downloadCSV(data, 'budget_report.csv');
  };

  const handleExcelDownload = async () => {
    try {
      // テンプレート読み込み
      const response = await fetch('/展示会収支報告書 (収支報告書元データ）.xlsx');
      if (!response.ok) throw new Error('テンプレートファイルの読み込みに失敗しました');
      const arrayBuffer = await response.arrayBuffer();

      const workbook = new ExcelJS.Workbook();
      await workbook.xlsx.load(arrayBuffer);
      const worksheet = workbook.worksheets[0];

      // Header: D1-H4 Title
      try { worksheet.unmergeCells('D1:H4'); } catch (e) { }
      try { worksheet.mergeCells('D1:H4'); } catch (e) { }
      const titleCell = worksheet.getCell('D1');
      titleCell.value = '収支報告書';
      titleCell.alignment = { vertical: 'middle', horizontal: 'center' };
      titleCell.font = { size: 18, bold: true, name: 'ＭＳ Ｐゴシック' };

      // Header: I5 Date
      const displayDate = exhibition.dates && exhibition.dates.length > 0 ? exhibition.dates[0] : '';
      worksheet.getCell('I5').value = `開催日: ${displayDate}`;

      // Header: A5-G5 Exhibition Title
      try { worksheet.unmergeCells('A5:G5'); } catch (e) { }
      try { worksheet.mergeCells('A5:G5'); } catch (e) { }
      const subTitleCell = worksheet.getCell('A5');
      subTitleCell.value = exhibition.title || '';
      subTitleCell.alignment = { vertical: 'middle', horizontal: 'center' };
      subTitleCell.font = { name: 'Meiryo UI', size: 11 }; // 一応フォント指定

      // Date Format for Column B(Remove Year)
      // Expecting 'YYYY-MM-DD'. Slice to 'MM-DD' or replace to 'MM/DD'
      const shortDate = displayDate.length >= 10 ? displayDate.substring(5).replace('-', '/') : displayDate;

      // データ準備
      const rows = [];
      // 収入
      rows.push({ cat: '収入', name: '出展費用', amount: boothIncome, note: '' });
      incomes.forEach(i => rows.push({ cat: '収入', name: i.item, amount: i.amount, note: i.note }));
      // 空行
      rows.push({ isEmpty: true });
      // 支出
      rows.push({ cat: '支出', name: '会場利用料', amount: venueDetails.cost, note: '管理画面連動' });
      rows.push({ cat: '支出', name: '備品費', amount: equipmentTotal, note: '備品リスト連動' });
      if (lectureTotalFees > 0) {
        rows.push({ cat: '支出', name: '講演会費用', amount: lectureTotalFees, note: '' });
      }
      expenses.forEach(i => rows.push({ cat: '支出', name: i.item, amount: i.amount, note: i.note }));

      // 書き込み
      let currentRow = 7;
      const footerStartRow = 23; // 名前欄の開始行と想定

      for (let i = 0; i < rows.length; i++) {
        const data = rows[i];

        // フッター領域に達したら行を挿入
        if (currentRow >= footerStartRow + (i - (footerStartRow - 7))) {
          // 補正ロジック: 初期 7-22 (16行) が埋まったら、以降は挿入が必要。
          // i が 16 を超えたら挿入。
        }

        // シンプルな戦略: 行が足りなくなったら挿入
        // 既存行数チェックではなく、23行目(フッター)に達したら挿入
        if (currentRow >= 23) {
          worksheet.insertRow(currentRow, []);
          try { worksheet.mergeCells(`C${currentRow}:F${currentRow}`); } catch (e) { }
          try { worksheet.mergeCells(`G${currentRow}:H${currentRow}`); } catch (e) { }
        }

        const row = worksheet.getRow(currentRow);

        if (data.isEmpty) {
          row.getCell(1).value = null;
          row.getCell(3).value = null;
          row.getCell(7).value = null;
          row.getCell(9).value = null;
        } else {
          row.getCell(1).value = data.cat;
          row.getCell(2).value = shortDate; // B列: 西暦なし日付

          const nameCell = row.getCell(3);
          nameCell.value = data.name;
          nameCell.font = { name: 'Meiryo UI', size: 11 };
          nameCell.alignment = { vertical: 'middle', horizontal: 'left' };

          row.getCell(7).value = data.amount;
          row.getCell(9).value = data.note;
        }
        currentRow++;
      }

      // Row 21 まで空行で埋める
      while (currentRow < 21) {
        const row = worksheet.getRow(currentRow);
        ['A', 'B', 'C', 'G', 'I'].forEach(col => row.getCell(col).value = null);
        currentRow++;
      }

      // 合計行 (Row 21 or later)
      if (currentRow >= footerStartRow) {
        worksheet.insertRow(currentRow, []);
      }
      try { worksheet.mergeCells(`C${currentRow}:F${currentRow}`); } catch (e) { }
      try { worksheet.mergeCells(`G${currentRow}:H${currentRow}`); } catch (e) { }

      const totalRow = worksheet.getRow(currentRow);
      const labelCell = totalRow.getCell(3);
      labelCell.value = '計';
      labelCell.alignment = { vertical: 'middle', horizontal: 'left' };
      labelCell.font = { bold: true };

      const amountCell = totalRow.getCell(7);
      amountCell.value = totalIncome - totalExpense;
      amountCell.font = { bold: true };

      currentRow++; // Move past total row

      // 名前欄のクリア
      const footerNameRow1 = Math.max(23, currentRow + 1);
      const footerNameRow2 = footerNameRow1 + 1;

      worksheet.getCell(`I${footerNameRow1}`).value = '';
      worksheet.getCell(`I${footerNameRow2}`).value = '';

      // ファイル保存
      const buffer = await workbook.xlsx.writeBuffer();
      if (buffer.byteLength === 0) throw new Error('Excelファイルの生成に失敗しました (サイズ0)');
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });


      // Data URI download fallback
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = function () {
        const base64data = reader.result;
        const a = document.createElement('a');
        a.href = base64data;
        a.download = "BudgetReport.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert("ダウンロードが完了しました。ファイルを確認してください。");
      };

    } catch (e) {
      console.error(e);
      alert('Excel出力エラー: ' + e.message);
    }
  };

  const EditableRow = ({ item, isEditing, editData, setEditData, onSave, onCancel, onDelete }) => {
    if (isEditing) {
      return (
        <div className="flex gap-2 p-2 bg-yellow-50 rounded border border-yellow-200">
          <input className="flex-1 border p-1 rounded text-xs" value={editData.item} onChange={e => setEditData({ ...editData, item: e.target.value })} />
          <input type="number" className="w-24 border p-1 rounded text-xs" value={editData.amount} onChange={e => setEditData({ ...editData, amount: parseInt(e.target.value) || 0 })} />
          <input className="flex-1 border p-1 rounded text-xs" value={editData.note} onChange={e => setEditData({ ...editData, note: e.target.value })} />
          <button onClick={onSave} className="text-green-600"><Check size={16} /></button>
          <button onClick={onCancel} className="text-slate-400"><X size={16} /></button>
        </div>
      );
    }
    return (
      <div className="flex justify-between p-3 bg-white rounded border border-blue-100 group">
        <span className="flex items-center gap-2">{item.item} <span className="text-xs text-slate-400">({item.note})</span></span>
        <div className="flex items-center gap-3">
          <span className="font-bold">¥{item.amount.toLocaleString()}</span>
          <button onClick={() => startEdit(item)} className="text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100"><Edit3 size={14} /></button>
          <button onClick={() => onDelete(item.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><X size={14} /></button>
        </div>
      </div>
    );
  };

  return (
    <div className="p-8">
      <div className="bg-slate-800 text-white p-6 rounded-xl mb-8 flex justify-between items-center shadow-lg"><div><p className="text-sm text-slate-400 mb-1">最終収支</p><p className={`text-4xl font-bold ${totalIncome - totalExpense >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>¥{(totalIncome - totalExpense).toLocaleString()}</p></div><div className="text-right"><p className="text-sm text-slate-400 mb-1">目標利益</p><p className="text-xl font-bold">¥{targetProfit.toLocaleString()}</p></div></div>
      <div className="flex justify-between items-end mb-6"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Wallet className="text-blue-500" /> 収支管理</h3><div className="flex gap-2"><button onClick={handleExcelDownload} className="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 flex items-center gap-2 text-sm"><FileSpreadsheet size={16} /> Excel出力</button></div></div>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div className="bg-blue-50/50 border border-blue-100 rounded-xl overflow-hidden"><div className="bg-blue-100 p-4 flex justify-between items-center"><h4 className="font-bold text-blue-900">収入の部</h4><span className="text-xl font-bold text-blue-700">¥{totalIncome.toLocaleString()}</span></div><div className="p-4 space-y-2"><div className="flex justify-between p-3 bg-white rounded border border-blue-100"><span>出展費用</span><span className="font-bold">¥{boothIncome.toLocaleString()}</span></div>
          {incomes.map(i => (
            <EditableRow key={i.id} item={i} isEditing={editingId === i.id} editData={editingItemData} setEditData={setEditingItemData} onSave={saveEdit} onCancel={() => setEditingId(null)} onDelete={removeItem} />
          ))}
        </div></div>
        <div className="bg-red-50/50 border border-red-100 rounded-xl overflow-hidden"><div className="bg-red-100 p-4 flex justify-between items-center"><h4 className="font-bold text-red-900">支出の部</h4><span className="text-xl font-bold text-red-700">¥{totalExpense.toLocaleString()}</span></div><div className="p-4 space-y-2"><div className="flex justify-between p-3 bg-white rounded border border-red-100"><span>会場利用料</span><span className="font-bold">¥{venueDetails.cost.toLocaleString()}</span></div><div className="flex justify-between p-3 bg-white rounded border border-red-100"><span>備品費</span><span className="font-bold">¥{equipmentTotal.toLocaleString()}</span></div>
          {lectureTotalFees > 0 && (
            <div className="flex justify-between p-3 bg-purple-50 rounded border border-purple-200">
              <span className="flex items-center gap-2"><Mic size={14} className="text-purple-500" /> 講演会費用</span>
              <span className="font-bold text-purple-700">¥{lectureTotalFees.toLocaleString()}</span>
            </div>
          )}
          {expenses.map(i => (
            <EditableRow key={i.id} item={i} isEditing={editingId === i.id} editData={editingItemData} setEditData={setEditingItemData} onSave={saveEdit} onCancel={() => setEditingId(null)} onDelete={removeItem} />
          ))}
        </div></div>
      </div>
      <div className="bg-slate-100 p-4 rounded-xl flex flex-wrap gap-4 items-end border border-slate-200"><div><label className="text-xs font-bold text-slate-500 mb-1 block">区分</label><select value={newItem.type} onChange={e => setNewItem({ ...newItem, type: e.target.value })} className="p-2 border rounded text-sm w-32"><option value="income">収入 (+)</option><option value="expense">支出 (-)</option></select></div><div className="flex-1"><label className="text-xs font-bold text-slate-500 mb-1 block">項目名</label><input type="text" value={newItem.item} onChange={e => setNewItem({ ...newItem, item: e.target.value })} className="w-full p-2 border rounded text-sm" placeholder="例: 協賛金 / 打ち上げ代" /></div><div className="w-32"><label className="text-xs font-bold text-slate-500 mb-1 block">金額</label><input type="number" value={newItem.amount || ''} onChange={e => { const val = e.target.value; if (val === '' || /^[1-9][0-9]*$/.test(val)) setNewItem({ ...newItem, amount: val === '' ? 0 : parseInt(val) }); }} className="w-full p-2 border rounded text-sm" /></div><div className="flex-1"><label className="text-xs font-bold text-slate-500 mb-1 block">備考</label><input type="text" value={newItem.note} onChange={e => setNewItem({ ...newItem, note: e.target.value })} className="w-full p-2 border rounded text-sm" placeholder="詳細メモ" /></div><button onClick={handleAddItem} className="bg-slate-800 text-white px-6 py-2 rounded font-bold hover:bg-slate-700 text-sm h-fit shadow-md">追加</button></div>
    </div>
  );
}

// LectureFormModal: 講演フォームモーダル（外部コンポーネントでスクロール問題を防止）
function LectureFormModal({ data, updateField, onSave, onCancel, title, staffList = [] }) {
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl">
        <div className="bg-purple-50 p-6 border-b flex justify-between items-center sticky top-0 z-10">
          <h3 className="text-xl font-bold text-purple-800 flex items-center gap-2"><Mic size={20} /> {title}</h3>
          <button onClick={onCancel} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
        </div>
        <div className="p-6 space-y-6">
          {/* 講師情報 */}
          <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
            <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Users size={16} /> 講師情報</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">講師名 *</label>
                <input className="w-full border p-2 rounded" value={data.speakerName || ''} onChange={e => updateField('speakerName', e.target.value)} placeholder="山田 太郎" />
              </div>
              <div>
                <div><label className="block text-sm font-bold mb-1">写真 (選択)</label><input type="file" accept="image/*" onChange={(e) => { const file = e.target.files[0]; if (file) { if (file.size > 800 * 1024) { alert("ファイルサイズが大きすぎます (800KB以下にしてください)"); return; } const reader = new FileReader(); reader.onloadend = () => { updateField('speakerPhoto', reader.result); }; reader.readAsDataURL(file); } }} className="w-full text-sm border p-2 rounded" />{data.speakerPhoto && <div className="mt-2"><img src={data.speakerPhoto} alt="Preview" className="w-20 h-20 object-cover rounded-full border border-slate-200" /><button onClick={() => updateField('speakerPhoto', '')} className="text-xs text-red-500 mt-1 hover:underline">削除</button></div>}</div>
                <div><label className="block text-sm font-bold mb-1">または画像URL</label><input className="w-full border p-2 rounded" value={data.speakerPhoto || ''} onChange={e => updateField('speakerPhoto', e.target.value)} placeholder="https://..." /></div>
              </div>
            </div>
          </div>

          {/* 講演内容 */}
          <div className="bg-purple-50 p-4 rounded-xl border border-purple-200">
            <h4 className="font-bold text-purple-700 mb-4 flex items-center gap-2"><FileText size={16} /> 講演内容</h4>
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">テーマ *</label>
                <input className="w-full border p-2 rounded" value={data.theme || ''} onChange={e => updateField('theme', e.target.value)} placeholder="○○について" />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">講演内容概略</label>
                <textarea className="w-full border p-2 rounded h-24" value={data.summary || ''} onChange={e => updateField('summary', e.target.value)} placeholder="講演の概要を入力..." />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">チラシ用文言</label>
                <textarea className="w-full border p-2 rounded h-16" value={data.flyerText || ''} onChange={e => updateField('flyerText', e.target.value)} placeholder="チラシに掲載する文言" />
              </div>
            </div>
          </div>

          {/* 開催情報 */}
          <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
            <h4 className="font-bold text-blue-700 mb-4 flex items-center gap-2"><Clock size={16} /> 開催情報</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">開始時間</label>
                <input type="time" className="w-full border p-2 rounded" value={data.time || ''} onChange={e => updateField('time', e.target.value)} />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">講演時間(分)</label>
                <input type="number" className="w-full border p-2 rounded" value={data.duration || ''} onChange={e => updateField('duration', e.target.value)} placeholder="60" />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">会場 / 場所</label>
                <input className="w-full border p-2 rounded" value={data.location || ''} onChange={e => updateField('location', e.target.value)} placeholder="セミナールームA" />
              </div>
            </div>
          </div>

          {/* 費用 */}
          <div className="bg-green-50 p-4 rounded-xl border border-green-200">
            <h4 className="font-bold text-green-700 mb-4 flex items-center gap-2"><Wallet size={16} /> 費用</h4>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">講演費 (円)</label>
                <input type="number" className="w-full border p-2 rounded" value={data.speakerFee || 0} onChange={e => updateField('speakerFee', parseInt(e.target.value) || 0)} />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">交通費 (円)</label>
                <input type="number" className="w-full border p-2 rounded" value={data.transportFee || 0} onChange={e => updateField('transportFee', parseInt(e.target.value) || 0)} />
              </div>
            </div>
          </div>

          {/* 準備・担当 */}
          <div className="bg-amber-50 p-4 rounded-xl border border-amber-200">
            <h4 className="font-bold text-amber-700 mb-4 flex items-center gap-2"><Briefcase size={16} /> 準備・担当</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">担当者</label>
                {staffList.length > 0 ? (
                  <select className="w-full border p-2 rounded" value={data.person || ''} onChange={e => updateField('person', e.target.value)}>
                    <option value="">選択してください</option>
                    {staffList.map((s, i) => <option key={i} value={s}>{s}</option>)}
                  </select>
                ) : (
                  <input className="w-full border p-2 rounded" value={data.person || ''} onChange={e => updateField('person', e.target.value)} placeholder="担当者名" />
                )}
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">資料格納場所URL</label>
                <input className="w-full border p-2 rounded" value={data.materialsUrl || ''} onChange={e => updateField('materialsUrl', e.target.value)} placeholder="https://drive.google.com/..." />
              </div>
            </div>
            <div className="mt-4">
              <label className="block text-xs font-bold text-slate-500 mb-1">準備するもの</label>
              <textarea className="w-full border p-2 rounded h-16" value={data.preparation || ''} onChange={e => updateField('preparation', e.target.value)} placeholder="マイク、プロジェクター、..." />
            </div>
          </div>
        </div>
        <div className="p-6 border-t flex justify-end gap-2 sticky bottom-0 bg-white">
          <button onClick={onCancel} className="px-6 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">キャンセル</button>
          <button onClick={onSave} className="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 shadow-lg">保存</button>
        </div>
      </div>
    </div>
  );
}

// TabLectures: 講演会管理コンポーネント
function TabLectures({ lectures, updateMainData, staff }) {
  const [lectureList, setLectureList] = useState(lectures || []);
  const [isAddOpen, setIsAddOpen] = useState(false);
  const [editingLecture, setEditingLecture] = useState(null);

  // スタッフリストを配列に変換
  const staffList = staff ? staff.split(',').map(s => s.trim()).filter(s => s) : [];
  const [newLecture, setNewLecture] = useState({
    speakerName: '',
    speakerPhoto: '',
    theme: '',
    summary: '',
    time: '',
    duration: '',
    location: '',
    speakerFee: 0,
    transportFee: 0,
    flyerText: '',
    preparation: '',
    person: '',
    materialsUrl: ''
  });

  useEffect(() => { setLectureList(lectures || []); }, [lectures]);

  const handleAdd = () => {
    if (!newLecture.speakerName || !newLecture.theme) return alert('講師名とテーマは必須です');
    const lecture = { id: crypto.randomUUID(), ...newLecture };
    const updated = [...lectureList, lecture];
    updateMainData('lectures', updated);
    setNewLecture({ speakerName: '', speakerPhoto: '', theme: '', summary: '', time: '', duration: '', location: '', speakerFee: 0, transportFee: 0, flyerText: '', preparation: '', person: '', materialsUrl: '' });
    setIsAddOpen(false);
  };

  const handleUpdate = () => {
    if (!editingLecture) return;
    const updated = lectureList.map(l => l.id === editingLecture.id ? editingLecture : l);
    updateMainData('lectures', updated);
    setEditingLecture(null);
  };

  const handleDelete = (id) => {
    if (!window.confirm('この講演を削除しますか？')) return;
    const updated = lectureList.filter(l => l.id !== id);
    updateMainData('lectures', updated);
  };

  // フォームデータを更新する関数（スクロール問題を防ぐため関数として渡す）
  const updateNewLecture = (key, value) => {
    setNewLecture(prev => ({ ...prev, [key]: value }));
  };

  const updateEditingLecture = (key, value) => {
    setEditingLecture(prev => prev ? { ...prev, [key]: value } : prev);
  };

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Mic className="text-purple-500" /> 講演会管理</h2>
        <button onClick={() => setIsAddOpen(true)} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2 shadow-lg"><Plus size={18} /> 講演を追加</button>
      </div>

      {/* 講演一覧 */}
      <div className="space-y-4">
        {lectureList.map(lecture => (
          <div key={lecture.id} className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex flex-col md:flex-row gap-6">
              {/* 講師写真 */}
              <div className="flex-shrink-0">
                {lecture.speakerPhoto ? (
                  <img src={lecture.speakerPhoto} alt={lecture.speakerName} className="w-24 h-24 rounded-full object-cover border-4 border-purple-100" />
                ) : (
                  <div className="w-24 h-24 rounded-full bg-purple-100 flex items-center justify-center text-purple-400"><Users size={32} /></div>
                )}
              </div>
              {/* 講演情報 */}
              <div className="flex-1">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="text-xl font-bold text-slate-800">{lecture.theme}</h3>
                    <p className="text-purple-600 font-bold">{lecture.speakerName}</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setEditingLecture({ ...lecture })} className="text-blue-500 hover:text-blue-700 p-1"><Edit3 size={18} /></button>
                    <button onClick={() => handleDelete(lecture.id)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={18} /></button>
                  </div>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm">
                  <div><span className="text-slate-400">時間:</span> <span className="font-bold">{lecture.time || '-'}</span></div>
                  <div><span className="text-slate-400">場所:</span> <span className="font-bold">{lecture.location || '-'}</span></div>
                  <div><span className="text-slate-400">講演費:</span> <span className="font-bold text-green-600">¥{(lecture.speakerFee || 0).toLocaleString()}</span></div>
                  <div><span className="text-slate-400">担当:</span> <span className="font-bold">{lecture.person || '-'}</span></div>
                </div>
                {lecture.summary && <p className="mt-3 text-sm text-slate-600 bg-slate-50 p-3 rounded">{lecture.summary}</p>}
              </div>
            </div>
          </div>
        ))}
        {lectureList.length === 0 && (
          <div className="text-center py-16 bg-slate-50 rounded-xl border border-slate-200">
            <Mic size={48} className="mx-auto text-slate-300 mb-4" />
            <p className="text-slate-400 font-bold">講演会が登録されていません</p>
            <p className="text-slate-400 text-sm mt-1">「講演を追加」ボタンから登録してください</p>
          </div>
        )}
      </div>

      {/* 追加モーダル */}
      {isAddOpen && (
        <LectureFormModal
          data={newLecture}
          updateField={updateNewLecture}
          onSave={handleAdd}
          onCancel={() => setIsAddOpen(false)}
          title="新しい講演を追加"
          staffList={staffList}
        />
      )}
      {/* 編集モーダル */}
      {editingLecture && (
        <LectureFormModal
          data={editingLecture}
          updateField={updateEditingLecture}
          onSave={handleUpdate}
          onCancel={() => setEditingLecture(null)}
          title="講演を編集"
          staffList={staffList}
        />
      )}
    </div>
  );
}

function TabFiles() {
  const DRIVE_LINK = "https://drive.google.com/drive/folders/1-2kpoKvlPNgTdMUPzCIGjqXm4gkQM3Gx?usp=drive_link";
  return (
    <div className="p-8 text-center">
      <div className="bg-blue-50 border border-blue-100 p-12 rounded-3xl flex flex-col items-center justify-center">
        <Folder size={80} className="text-blue-400 mb-6" />
        <h3 className="text-2xl font-bold text-blue-900 mb-2">資料管理センター</h3>
        <p className="text-blue-600 mb-8">案内チラシやその他参考資料は、以下のGoogle Driveフォルダで一元管理されています。</p>
        <a href={DRIVE_LINK} target="_blank" rel="noreferrer" className="bg-blue-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-xl hover:bg-blue-700 transition-transform transform hover:scale-105 flex items-center gap-3">
          <ExternalLink size={24} /> Google Driveフォルダを開く
        </a>
      </div>
    </div>
  );
}
// ============================================================================
// 5. 機能別タブコンポーネント (続き)
// ============================================================================

function TabTasks({ tasks, setTasks, staff }) {
  const [newTaskTitle, setNewTaskTitle] = useState(''); const [newTaskCat, setNewTaskCat] = useState('sales'); const [newTaskPhase, setNewTaskPhase] = useState('prep');
  const [editingTask, setEditingTask] = useState(null);
  const [dragItem, setDragItem] = useState(null);
  const [dragOverItem, setDragOverItem] = useState(null);

  const staffList = staff ? staff.split(',').map(s => s.trim()) : [];

  const addTask = () => { if (!newTaskTitle) return; setTasks([...tasks, { id: `t${Date.now()}`, category: newTaskCat, phase: newTaskPhase, title: newTaskTitle, status: 'pending', assignee: '', dueDate: '', desc: '' }]); setNewTaskTitle(''); };
  const updateTask = () => { setTasks(tasks.map(t => t.id === editingTask.id ? editingTask : t)); setEditingTask(null); };
  const deleteTask = (id) => { if (window.confirm("削除しますか？")) { setTasks(tasks.filter(t => t.id !== id)); setEditingTask(null); } };
  const toggleStatus = (id) => { setTasks(tasks.map(t => t.id === id ? { ...t, status: t.status === 'done' ? 'pending' : 'done' } : t)); };

  const handleDragStart = (e, task) => {
    setDragItem(task);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleDragEnter = (e, targetTask) => {
    e.preventDefault();
    if (dragItem?.id !== targetTask.id) {
      setDragOverItem(targetTask);
    }
  };

  const handleDrop = (e, targetTask) => {
    e.preventDefault();
    if (!dragItem || dragItem.id === targetTask.id) return;

    const newTasks = [...tasks];
    const dragIndex = newTasks.findIndex(t => t.id === dragItem.id);
    const dropIndex = newTasks.findIndex(t => t.id === targetTask.id);

    const [movedItem] = newTasks.splice(dragIndex, 1);

    if (movedItem.category !== targetTask.category || movedItem.phase !== targetTask.phase) {
      movedItem.category = targetTask.category;
      movedItem.phase = targetTask.phase;
    }

    newTasks.splice(dropIndex, 0, movedItem);
    setTasks(newTasks);
    setDragItem(null);
    setDragOverItem(null);
  };

  const toggleAssignee = (name) => {
    const current = editingTask.assignee ? editingTask.assignee.split(',').map(s => s.trim()).filter(s => s) : [];
    if (current.includes(name)) {
      setEditingTask({ ...editingTask, assignee: current.filter(s => s !== name).join(', ') });
    } else {
      setEditingTask({ ...editingTask, assignee: [...current, name].join(', ') });
    }
  };

  const TaskSection = ({ title, category, phase, colorClass, icon: Icon }) => (
    <div className="mb-6">
      <h5 className={`font-bold mb-3 flex items-center gap-2 text-sm uppercase tracking-wider ${colorClass} border-b pb-1`}><Icon size={14} /> {title}</h5>
      <div className="space-y-2 min-h-[100px]"
        onDragOver={(e) => e.preventDefault()}>
        {tasks.map((t) => {
          if (t.category !== category || t.phase !== phase) return null;
          const isDragging = dragItem?.id === t.id;
          const isOver = dragOverItem?.id === t.id;

          return (
            <div
              key={t.id}
              onDragEnter={(e) => handleDragEnter(e, t)}
              onDragOver={(e) => e.preventDefault()}
              onDrop={(e) => handleDrop(e, t)}
              className={`bg-white p-3 rounded-lg border transition-all group relative flex gap-2 
                ${isDragging ? 'opacity-50 border-dashed border-blue-400' : 'border-slate-200 hover:shadow-md hover:border-blue-300'} 
                ${isOver ? 'border-t-4 border-t-blue-500 mt-2' : ''}
              `}
            >
              <div
                draggable
                onDragStart={(e) => handleDragStart(e, t)}
                className="cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 flex items-center p-2 border-r border-slate-100"
              >
                <GripVertical size={16} />
              </div>

              <div className="flex-1 flex items-start gap-3 cursor-pointer" onClick={() => setEditingTask(t)}>
                <button onClick={(e) => { e.stopPropagation(); toggleStatus(t.id); }} className={`mt-0.5 w-5 h-5 rounded border flex-shrink-0 flex items-center justify-center transition-colors ${t.status === 'done' ? 'bg-blue-500 border-blue-500 text-white' : 'border-slate-300 hover:border-blue-400 bg-white'}`}>{t.status === 'done' && <CheckSquare size={14} />}</button>
                <div className="flex-1 min-w-0">
                  <div className={`text-sm font-medium ${t.status === 'done' ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{t.title}</div>
                  {(t.assignee || t.dueDate) && (<div className="flex gap-3 mt-1 text-xs text-slate-500">{t.assignee && <span className="flex items-center gap-1 bg-slate-100 px-1.5 rounded"><Users size={10} /> {t.assignee}</span>}{t.dueDate && <span className={`flex items-center gap-1 bg-slate-100 px-1.5 rounded ${new Date(t.dueDate) < new Date() && t.status !== 'done' ? 'text-red-500 font-bold' : ''}`}><Clock size={10} /> {t.dueDate}</span>}</div>)}
                </div>
                <div className="text-slate-300 group-hover:text-blue-400"><Edit3 size={14} /></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  return (
    <div className="p-8 h-full flex flex-col relative">
      <div className="flex gap-2 mb-6 bg-slate-100 p-2 rounded-xl">
        <input type="text" placeholder="新しいタスクを追加..." value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg outline-none text-sm" />
        <select value={newTaskCat} onChange={e => setNewTaskCat(e.target.value)} className="p-2 border border-slate-200 rounded-lg bg-white outline-none text-sm"><option value="sales">営業</option><option value="planning">企画</option></select>
        <select value={newTaskPhase} onChange={e => setNewTaskPhase(e.target.value)} className="p-2 border border-slate-200 rounded-lg bg-white outline-none text-sm"><option value="prep">準備</option><option value="post">終了後</option></select>
        <div className="bg-white border border-slate-200 rounded-lg px-3 flex items-center text-sm text-slate-500">担当: 後で設定</div>
        <button onClick={addTask} className="bg-slate-800 text-white px-4 rounded-lg font-bold hover:bg-slate-700 text-sm">追加</button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8 h-full overflow-hidden">
        <div className="bg-indigo-50/50 rounded-2xl p-6 border border-indigo-100 overflow-y-auto h-[600px] scrollbar-thin"><h3 className="font-bold text-indigo-900 mb-6 flex items-center gap-2 text-lg"><div className="w-4 h-4 rounded-full bg-indigo-500" /> 営業チーム (Sales)</h3><TaskSection title="準備タスク" category="sales" phase="prep" colorClass="text-indigo-600 border-indigo-200" icon={Flag} /><div className="my-8 border-t-2 border-dashed border-indigo-200 relative"><span className="absolute top-[-10px] left-1/2 -translate-x-1/2 bg-indigo-100 text-indigo-400 text-xs px-2 font-bold">EVENT DAY</span></div><TaskSection title="終了後タスク" category="sales" phase="post" colorClass="text-indigo-600 border-indigo-200" icon={CheckCircle} /></div>
        <div className="bg-emerald-50/50 rounded-2xl p-6 border border-emerald-100 overflow-y-auto h-[600px] scrollbar-thin"><h3 className="font-bold text-emerald-900 mb-6 flex items-center gap-2 text-lg"><div className="w-4 h-4 rounded-full bg-emerald-500" /> 企画チーム (Planning)</h3><TaskSection title="準備タスク" category="planning" phase="prep" colorClass="text-emerald-600 border-emerald-200" icon={Flag} /><div className="my-8 border-t-2 border-dashed border-emerald-200 relative"><span className="absolute top-[-10px] left-1/2 -translate-x-1/2 bg-emerald-100 text-emerald-400 text-xs px-2 font-bold">EVENT DAY</span></div><TaskSection title="終了後タスク" category="planning" phase="post" colorClass="text-emerald-600 border-emerald-200" icon={CheckCircle} /></div>
      </div>

      {editingTask && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4 animate-slide-up">
            <div className="flex justify-between items-center border-b pb-4">
              <h3 className="font-bold text-lg flex items-center gap-2"><Edit3 size={18} /> タスク編集</h3>
              <button onClick={() => setEditingTask(null)} className="p-1 hover:bg-slate-100 rounded"><X size={20} /></button>
            </div>

            <div>
              <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">タスク名</label>
              <input type="text" value={editingTask.title} onChange={e => setEditingTask({ ...editingTask, title: e.target.value })} className="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" />
            </div>

            <div>
              <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">担当者 (複数選択可)</label>
              <div className="flex flex-wrap gap-2 p-2 border rounded bg-slate-50 max-h-24 overflow-y-auto">
                {staffList.map(s => {
                  const isSelected = editingTask.assignee?.includes(s);
                  return (
                    <button
                      key={s}
                      onClick={() => toggleAssignee(s)}
                      className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${isSelected ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-slate-600 border-slate-300 hover:border-blue-400'}`}
                    >
                      {s}
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">期限</label>
                <input type="date" value={editingTask.dueDate || ''} onChange={e => setEditingTask({ ...editingTask, dueDate: e.target.value })} className="w-full p-2 border border-slate-300 rounded" />
              </div>
              <div>
                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">移動</label>
                <select value={`${editingTask.category}-${editingTask.phase}`} onChange={e => {
                  const [cat, ph] = e.target.value.split('-');
                  setEditingTask({ ...editingTask, category: cat, phase: ph });
                }} className="w-full p-2 border border-slate-300 rounded bg-white">
                  <option value="sales-prep">営業 - 準備</option>
                  <option value="sales-post">営業 - 終了後</option>
                  <option value="planning-prep">企画 - 準備</option>
                  <option value="planning-post">企画 - 終了後</option>
                </select>
              </div>
            </div>

            <div>
              <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">詳細</label>
              <textarea rows="3" value={editingTask.desc || ''} onChange={e => setEditingTask({ ...editingTask, desc: e.target.value })} className="w-full p-2 border border-slate-300 rounded" />
            </div>

            <div className="flex justify-between pt-4 border-t">
              <button onClick={() => deleteTask(editingTask.id)} className="text-red-500 hover:text-red-700 font-bold text-sm flex items-center gap-1"><Trash2 size={16} /> 削除</button>
              <div className="flex gap-2">
                <button onClick={() => setEditingTask(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded">キャンセル</button>
                <button onClick={updateTask} className="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow-lg">保存</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function TabMakers({ exhibition, setMakers, updateMainData }) {
  const { makers, formUrlMaker, formConfig } = exhibition;
  const [subTab, setSubTab] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [isMailConfigOpen, setIsMailConfigOpen] = useState(false);
  const [isFormEditorOpen, setIsFormEditorOpen] = useState(false);
  const [isResponseDemoOpen, setIsResponseDemoOpen] = useState(false);
  const [editingNoteId, setEditingNoteId] = useState(null);
  const [noteEditValue, setNoteEditValue] = useState('');
  const [simpleAddCode, setSimpleAddCode] = useState('');
  const [simpleAddName, setSimpleAddName] = useState('');
  const [selectedMaker, setSelectedMaker] = useState(null);

  const [isCopied, setIsCopied] = useState(false); // コピーフィードバック用

  const [isEditMakerOpen, setIsEditMakerOpen] = useState(false);
  const [editingMakerData, setEditingMakerData] = useState(null);

  // ソート機能
  const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
  const handleSort = (key) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  // URL短縮機能
  const [shortMakerUrl, setShortMakerUrl] = useState('');
  const [isMakerUrlShortening, setIsMakerUrlShortening] = useState(false);
  const shortenMakerUrl = async () => {
    if (!formUrlMaker) return;
    setIsMakerUrlShortening(true);
    try {
      const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(formUrlMaker)}`);
      if (response.ok) {
        const shortened = await response.text();
        setShortMakerUrl(shortened);
        navigator.clipboard.writeText(shortened);
        alert('短縮URLをクリップボードにコピーしました！');
      } else {
        alert('URL短縮に失敗しました');
      }
    } catch (e) {
      alert('URL短縮エラー: ' + e.message);
    }
    setIsMakerUrlShortening(false);
  };

  const fileInputRef = useRef(null);

  const makerList = makers || [];

  // トークン一括補完（既存データ移行用）
  useEffect(() => {
    if (makerList.length > 0) {
      const missingTokens = makerList.some(m => !m.accessToken);
      if (missingTokens) {
        console.log('Fixing missing tokens...');
        const updated = makerList.map(m => m.accessToken ? m : { ...m, accessToken: crypto.randomUUID() });
        updateMainData('makers', updated);
      }
    }
  }, [makerList.length]); // only check when length changes or mount

  // 会社名の正規化（株式会社、㈱、有限会社などを除去）
  const normalizeCompanyName = (name) => {
    if (!name) return '';
    return name
      .replace(/株式会社/g, '')
      .replace(/㈱/g, '')
      .replace(/有限会社/g, '')
      .replace(/㈲/g, '')
      .replace(/合同会社/g, '')
      .replace(/合資会社/g, '')
      .replace(/\s+/g, '')
      .trim()
      .toLowerCase();
  };

  // 回答済みメーカーの正規化された会社名リスト
  const respondedNormalizedNames = makerList
    .filter(m => m.status === 'confirmed' || m.status === 'declined')
    .map(m => normalizeCompanyName(m.companyName));

  // 未回答の可能性があるメーカー（招待リストにいて、回答者の会社名と一致しない）
  const potentiallyUnanswered = makerList.filter(m => {
    if (m.source === 'web_response') return false; // Web回答者は除外
    if (m.status === 'confirmed' || m.status === 'declined') return false; // 既に回答済み
    const normalizedName = normalizeCompanyName(m.companyName);
    // 回答者リストに同じ会社名がない場合は未回答の可能性
    return !respondedNormalizedNames.includes(normalizedName);
  });

  const filteredMakers = makerList.filter(m => {
    const term = searchTerm.toLowerCase();
    const match = (m.companyName?.toLowerCase().includes(term)) || (m.code?.toLowerCase().includes(term)) || (m.repName?.toLowerCase().includes(term));
    if (subTab === 'confirmed') return m.status === 'confirmed' && match;
    if (subTab === 'declined') return m.status === 'declined' && match;
    if (subTab === 'unanswered') return potentiallyUnanswered.some(u => (u.id || u.code) === (m.id || m.code)) && match;
    // 招待リスト(all)では、Web回答のみの人（source: 'web_response'）は除外
    if (subTab === 'all') return m.source !== 'web_response' && match;
    return match;
  });

  // ソート適用
  const sortedMakers = [...filteredMakers].sort((a, b) => {
    if (!sortConfig.key) return 0;
    const aVal = a[sortConfig.key] ?? '';
    const bVal = b[sortConfig.key] ?? '';
    const numA = typeof aVal === 'number' ? aVal : parseInt(aVal) || 0;
    const numB = typeof bVal === 'number' ? numB : parseInt(bVal) || 0;
    // 数値比較可能なら数値比較
    if (!isNaN(numA) && !isNaN(numB) && sortConfig.key !== 'companyName' && sortConfig.key !== 'repName') {
      return sortConfig.direction === 'asc' ? numA - numB : numB - numA;
    }
    // 文字列比較
    return sortConfig.direction === 'asc'
      ? String(aVal).localeCompare(String(bVal), 'ja')
      : String(bVal).localeCompare(String(aVal), 'ja');
  });

  const calculateTotals = () => {
    const confirmed = makerList.filter(m => m.status === 'confirmed');
    return {
      booth: confirmed.reduce((sum, m) => sum + extractNum(m.boothCount), 0),
      staff: confirmed.reduce((sum, m) => sum + extractNum(m.staffCount), 0),
      lunch: confirmed.reduce((sum, m) => sum + extractNum(m.lunchCount), 0),
      desk: confirmed.reduce((sum, m) => sum + extractNum(m.itemsDesk), 0),
      chair: confirmed.reduce((sum, m) => sum + extractNum(m.itemsChair), 0),
      power: confirmed.filter(m => m.itemsPower === '必要').length
    };
  };
  const totals = calculateTotals();
  // 招待リスト（web_responseを除外）の統計
  const invitedMakers = makerList.filter(m => m.source !== 'web_response');
  const stats = {
    total: invitedMakers.length, // 招待総数はweb回答を除外
    confirmed: makerList.filter(m => m.status === 'confirmed').length,
    declined: makerList.filter(m => m.status === 'declined').length,
    pending: invitedMakers.filter(m => m.status === 'listed').length, // 未回答も招待者のみ
    unanswered: potentiallyUnanswered.length // 未回答の可能性
  };

  const handleSimpleAdd = () => {
    if (!simpleAddCode || !simpleAddName) return;
    const newMaker = { id: Date.now(), code: simpleAddCode, companyName: simpleAddName, status: 'listed', note: '手動追加', accessToken: crypto.randomUUID() };
    updateMainData('makers', [...makerList, newMaker]);
    setSimpleAddCode(''); setSimpleAddName('');
  };

  const handleCSVUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const data = await parseCSV(file);
      if (data && data.length > 0) {
        if (window.confirm(`${data.length}件のメーカーデータを追加しますか？\n（既存のリストに追加されます）`)) {
          updateMainData('makers', [...makerList, ...data]);
          alert('インポートが完了しました');
        }
      } else {
        alert('有効なデータが見つかりませんでした。');
      }
    } catch (err) {
      alert('CSV読み込みエラー: ' + err.message);
    }
    e.target.value = '';
  };

  const handleClearAllMakers = () => {
    if (window.confirm("【警告】\n全てのメーカーリストを削除します。\n回答済みのデータも消えますが本当によろしいですか？")) {
      updateMainData('makers', []);
    }
  }

  const exportMakersCSV = () => { const data = makerList.map(m => ({ Code: m.code, Company: m.companyName, Note: m.note })); downloadCSV(data, 'makers_list.csv'); };

  const exportConfirmedCSV = () => {
    const baseUrl = window.location.origin + window.location.pathname;
    const confirmed = makerList.filter(m => m.status === 'confirmed');

    if (confirmed.length === 0) {
      alert('出力対象のメーカーがありません');
      return;
    }

    // Build data with only non-empty fields
    const allFieldsMapping = {
      '会社名': 'companyName', '担当者名': 'repName', '電話番号': 'phone', 'メールアドレス': 'email',
      '希望コマ数': 'boothCount', '参加人数': 'staffCount', '昼食数': 'lunchCount',
      '長机': 'itemsDesk', '椅子': 'itemsChair', '電源': 'itemsPower', '電源詳細': 'powerDetail',
      '運送便': 'transport', '出荷個口数': 'packages', '支払方法': 'payment',
      '搬入日時': 'moveInDate', '備考': 'note', '展示予定品': 'products'
    };

    // Find which fields have at least one non-empty value
    const usedFields = {};
    for (const [label, key] of Object.entries(allFieldsMapping)) {
      if (confirmed.some(m => m[key] !== undefined && m[key] !== null && m[key] !== '')) {
        usedFields[label] = key;
      }
    }

    // Always include Dashboard URL
    const data = confirmed.map(m => {
      const row = {};
      for (const [label, key] of Object.entries(usedFields)) {
        row[label] = m[key] || '';
      }
      row['Dashboard URL'] = m.accessToken ? `${baseUrl}?mode=dashboard&id=${exhibition.id}&key=${m.accessToken}` : '';
      return row;
    });

    downloadCSV(data, 'confirmed_makers_detail.csv');
  };

  const saveNote = (id) => {
    const updated = makerList.map(m => (m.id || m.code) === id ? { ...m, note: noteEditValue } : m);
    updateMainData('makers', updated);
    setEditingNoteId(null);
  };
  const startEditNote = (m) => { setEditingNoteId(m.id || m.code); setNoteEditValue(m.note || ''); };
  const updateMailConfig = (key, val) => { const newConfig = { ...formConfig, mail: { ...formConfig.mail, [key]: val } }; updateMainData('formConfig', newConfig); };
  const handleConfigUpdate = (newConfig) => { updateMainData('formConfig', newConfig); setIsFormEditorOpen(false); };
  const handleFormResponse = (formData) => {
    // デモ回答をリストに追加
    const isConfirmed = formData.status === 'confirmed' || formData.status === '出展を申し込む';
    const newMaker = {
      id: crypto.randomUUID(),
      ...formData,
      code: 'DEMO-' + Date.now().toString().slice(-4),
      status: isConfirmed ? 'confirmed' : 'declined',
      note: 'デモ回答'
    };
    updateMainData('makers', [...(makers || []), newMaker]);
    setIsResponseDemoOpen(false);
    alert('デモ回答をリストに追加しました');
  };

  const deleteMaker = (id) => {
    if (window.confirm("このメーカーを削除しますか？")) {
      const updated = makerList.filter(m => (m.id || m.code) !== id);
      updateMainData('makers', updated);
    }
  };

  const startEditMaker = (maker) => {
    setEditingMakerData({ ...maker });
    setIsEditMakerOpen(true);
  };

  const saveEditMaker = () => {
    if (!editingMakerData) return;
    const updated = makerList.map(m =>
      ((m.id || m.code) === (editingMakerData.id || editingMakerData.code))
        ? editingMakerData
        : m
    );
    updateMainData('makers', updated);
    setIsEditMakerOpen(false);
  };

  // URLリフレッシュ機能
  const refreshMakerUrl = () => {
    if (!window.confirm('招待フォームのURLを更新します。\n古いURLは無効になりますがよろしいですか？')) return;
    const baseUrl = window.location.origin + window.location.pathname;
    const newUrl = `${baseUrl}?mode=maker_register&id=${exhibition.id}`;
    updateMainData('formUrlMaker', newUrl);
    alert('URLを更新しました！');
  };

  return (
    <div className="p-8">
      <div className="mb-6 flex gap-4 overflow-x-auto pb-4">
        <a href={typeof MASTER_SHEET_URL !== 'undefined' ? MASTER_SHEET_URL : '#'} target="_blank" rel="noreferrer" style={{ background: 'linear-gradient(to right, #10b981, #16a34a)' }} className="flex-none min-w-[280px] text-white rounded-xl p-4 shadow-lg hover:shadow-xl transition-all flex justify-between items-center group">
          <div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-lg"><FileSpreadsheet size={24} /></div><div><h4 className="font-bold text-lg">マスター管理シート</h4><p className="text-xs text-emerald-100">Google Sheets連携</p></div></div><ExternalLink size={20} className="text-emerald-100 group-hover:text-white" />
        </a>
        <button onClick={() => setIsMailConfigOpen(true)} style={{ background: 'linear-gradient(to right, #6366f1, #9333ea)' }} className="flex-none min-w-[280px] text-white rounded-xl p-4 shadow-lg hover:shadow-xl transition-all flex justify-between items-center group">
          <div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-lg"><Mail size={24} /></div><div><h4 className="font-bold text-lg">招待メール設定</h4><p className="text-xs text-indigo-100">文面テンプレート編集</p></div></div><Settings size={20} className="text-indigo-100 group-hover:text-white" />
        </button>
      </div>

      <div className="bg-slate-900 text-slate-300 rounded-xl p-5 mb-6">
        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
          <div className="flex-1 w-full">
            <h4 className="font-bold text-white mb-1 flex items-center gap-2"><Database size={18} /> オリジナル招待フォーム</h4>
            <p className="text-xs text-slate-400">このURLをメーカーに送信してください。</p>
            <div className="mt-2 flex gap-2">
              <input type="text" value={formUrlMaker} readOnly className="bg-slate-800 text-blue-300 text-xs px-3 py-2 rounded border border-slate-700 w-full" />
              <button className={`px-3 py-2 rounded text-xs flex items-center gap-1 shrink-0 transition-colors ${isCopied ? 'bg-green-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-white'}`} onClick={() => { navigator.clipboard.writeText(formUrlMaker); setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); }}>{isCopied ? <Check size={14} /> : <Copy size={14} />} {isCopied ? 'コピー完了' : 'コピー'}</button>
              <button onClick={refreshMakerUrl} className="bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded text-xs flex items-center gap-1 shrink-0" title="URLを更新"><RefreshCcw size={14} /> 更新</button>
            </div>
          </div>
          <div className="flex gap-2 w-full md:w-auto">
            <button onClick={() => setIsFormEditorOpen(true)} className="flex-1 md:flex-none bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all"><Settings size={18} /> フォーム編集</button>
            <button onClick={() => setIsResponseDemoOpen(true)} className="flex-1 md:flex-none bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-lg transform hover:scale-105 transition-all"><ExternalLink size={18} /> 回答画面 (デモ)</button>
          </div>
        </div>
      </div>

      <div className="bg-white border border-slate-200 rounded-xl p-6 mb-8 shadow-sm">
        <div className="flex justify-between items-center mb-6 border-b pb-4">
          <h3 className="font-bold text-slate-700 flex items-center gap-2"><TrendingUp size={18} /> 現在の集計状況</h3>
          <div className="text-xs text-slate-400">自動集計中</div>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div onClick={() => setSubTab('all')} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition-all ${subTab === 'all' ? 'border-blue-500 bg-blue-50' : 'border-slate-100 hover:border-blue-200'}`}><p className="text-xs font-bold text-slate-500 mb-1">招待総数</p><p className="text-3xl font-bold text-slate-800">{stats.total}<span className="text-sm font-normal text-slate-400 ml-1">社</span></p></div>
          <div onClick={() => setSubTab('confirmed')} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition-all ${subTab === 'confirmed' ? 'border-green-500 bg-green-50' : 'border-slate-100 hover:border-green-200'}`}><p className="text-xs font-bold text-green-600 mb-1">参加確定</p><p className="text-3xl font-bold text-green-800">{stats.confirmed}<span className="text-sm font-normal text-green-600 ml-1">社</span></p></div>
          <div onClick={() => setSubTab('declined')} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition-all ${subTab === 'declined' ? 'border-slate-400 bg-slate-100' : 'border-slate-100 hover:border-slate-300'}`}><p className="text-xs font-bold text-slate-500 mb-1">辞退</p><p className="text-3xl font-bold text-slate-700">{stats.declined}<span className="text-sm font-normal text-slate-400 ml-1">社</span></p></div>
          <div className="p-4 rounded-xl border-2 bg-white opacity-60 text-center"><p className="text-xs font-bold text-red-500 mb-1">未回答</p><p className="text-3xl font-bold text-red-800">{stats.pending}<span className="text-sm font-normal text-red-600 ml-1">社</span></p></div>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-6 gap-4 text-center bg-slate-50 p-4 rounded-xl">
          <div><p className="text-xs text-slate-500 mb-1">コマ数合計</p><p className="text-xl font-bold text-slate-800">{totals.booth}</p></div>
          <div><p className="text-xs text-slate-500 mb-1">参加人数</p><p className="text-xl font-bold text-slate-800">{totals.staff}</p></div>
          <div><p className="text-xs text-slate-500 mb-1">昼食数</p><p className="text-xl font-bold text-slate-800">{totals.lunch}</p></div>
          <div><p className="text-xs text-slate-500 mb-1">長机</p><p className="text-xl font-bold text-slate-800">{totals.desk}</p></div>
          <div><p className="text-xs text-slate-500 mb-1">椅子</p><p className="text-xl font-bold text-slate-800">{totals.chair}</p></div>
          <div><p className="text-xs text-slate-500 mb-1">電源利用</p><p className="text-xl font-bold text-slate-800">{totals.power}社</p></div>
        </div>
      </div>

      <div className="flex flex-col md:flex-row justify-between items-end border-b mb-6 gap-4">
        <div className="flex gap-1 w-full md:w-auto overflow-x-auto">
          <button onClick={() => setSubTab('all')} className={`px-6 py-3 text-sm font-bold border-b-2 whitespace-nowrap ${subTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500'}`}>招待リスト</button>
          <button onClick={() => setSubTab('confirmed')} className={`px-6 py-3 text-sm font-bold border-b-2 whitespace-nowrap ${subTab === 'confirmed' ? 'border-green-500 text-green-600' : 'border-transparent text-slate-500'}`}>参加メーカー</button>
          <button onClick={() => setSubTab('declined')} className={`px-6 py-3 text-sm font-bold border-b-2 whitespace-nowrap ${subTab === 'declined' ? 'border-slate-500 text-slate-600' : 'border-transparent text-slate-500'}`}>辞退</button>
          <button onClick={() => setSubTab('unanswered')} className={`px-6 py-3 text-sm font-bold border-b-2 whitespace-nowrap ${subTab === 'unanswered' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-500'}`}>未回答（可能性）<span className="ml-1 bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-xs">{stats.unanswered}</span></button>
        </div>
        <div className="mb-2 relative w-full md:w-auto">
          <Search size={16} className="absolute left-3 top-2.5 text-slate-400" />
          <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="会社名・コード検索..." className="pl-9 pr-4 py-2 border rounded-full text-sm w-full md:w-64 focus:ring-2 focus:ring-blue-500 outline-none" />
        </div>
      </div>

      {subTab === 'all' && (
        <div className="animate-fade-in">
          {/* CSV取込エリア */}
          <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 flex flex-col md:flex-row items-center gap-4 shadow-sm">
            <div className="flex-1">
              <h4 className="font-bold text-blue-800 flex items-center gap-2"><Upload size={18} /> CSV一括取込</h4>
              <p className="text-xs text-blue-600">CSV形式: A列=仕入先コード, B列=会社名 (ヘッダーなし可)</p>
            </div>
            <input type="file" accept=".csv" ref={fileInputRef} onChange={handleCSVUpload} className="hidden" />
            <button onClick={() => fileInputRef.current.click()} className="bg-white border border-blue-300 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-100 flex items-center gap-2 text-sm">
              ファイルを選択して取込
            </button>
            <div className="border-l border-blue-200 h-8 mx-2 hidden md:block"></div>
            <button onClick={handleClearAllMakers} className="text-red-500 hover:bg-red-50 px-3 py-2 rounded font-bold text-xs flex items-center gap-1">
              <Trash2 size={14} /> 全削除
            </button>
          </div>

          <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 mb-6 flex flex-col md:flex-row gap-4 items-end shadow-sm">
            <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600 self-center hidden md:block"><UserPlus size={24} /></div>
            <div className="w-full md:w-32"><label className="text-xs font-bold text-indigo-800 mb-1 block">仕入先コード</label><input type="text" value={simpleAddCode} onChange={e => setSimpleAddCode(e.target.value)} className="w-full p-2 border border-indigo-200 rounded text-sm outline-none" placeholder="M001" /></div>
            <div className="flex-1 w-full"><label className="text-xs font-bold text-indigo-800 mb-1 block">会社名</label><input type="text" value={simpleAddName} onChange={e => setSimpleAddName(e.target.value)} className="w-full p-2 border border-indigo-200 rounded text-sm outline-none" placeholder="新しいメーカー名を追加" /></div>
            <button onClick={handleSimpleAdd} className="w-full md:w-auto bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 h-fit text-sm shadow-md">追加する</button>
            <button onClick={exportMakersCSV} className="w-full md:w-auto ml-auto bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 h-fit text-sm shadow-md flex items-center justify-center gap-2"><Download size={16} /> CSV出力</button>
          </div>
          <div className="overflow-x-auto rounded-lg border border-slate-200">
            <table className="w-full text-left min-w-[600px]"><thead className="bg-slate-50 text-xs text-slate-500"><tr><th className="p-3 w-32">コード</th><th className="p-3">会社名</th><th className="p-3">備考 (編集可)</th><th className="p-3 w-32">操作</th></tr></thead><tbody>
              {filteredMakers.map((m, i) => (
                <tr key={i} className="border-b hover:bg-slate-50">
                  <td className="p-3 font-mono text-sm text-slate-600">{m.code}</td><td className="p-3 text-sm font-bold">{m.companyName}</td>
                  <td className="p-3 text-xs text-slate-500">{editingNoteId === (m.id || m.code) ? <input autoFocus value={noteEditValue} onChange={e => setNoteEditValue(e.target.value)} onBlur={() => saveNote(m.id || m.code)} onKeyDown={e => { if (e.key === 'Enter') saveNote(m.id || m.code) }} className="border p-1 rounded w-full" /> : (m.note || '-')}</td>
                  <td className="p-3 text-right flex gap-2 justify-end">
                    <button onClick={() => startEditNote(m)} className="text-slate-400 hover:text-blue-500" title="備考編集"><Edit3 size={14} /></button>
                    <button onClick={() => startEditMaker(m)} className="text-slate-400 hover:text-green-500" title="会社情報編集"><Settings size={14} /></button>
                    <button onClick={() => deleteMaker(m.id || m.code)} className="text-slate-400 hover:text-red-500" title="削除"><Trash2 size={14} /></button>
                  </td>
                </tr>
              ))}
            </tbody></table>
          </div>
        </div>
      )}

      {subTab === 'confirmed' && (
        <div className="animate-fade-in">
          <div className="flex justify-end mb-4"><button onClick={exportConfirmedCSV} className="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 h-fit text-sm shadow-md flex items-center gap-2"><Download size={16} /> 詳細CSV出力</button></div>
          <div className="overflow-x-auto rounded-lg border border-slate-200">
            <table className="w-full text-left text-sm whitespace-nowrap min-w-[800px]">
              <thead className="bg-green-50 text-green-800">
                <tr>
                  <th className="p-3 cursor-pointer hover:bg-green-100" onClick={() => handleSort('companyName')}>
                    会社名 {sortConfig.key === 'companyName' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="p-3 cursor-pointer hover:bg-green-100" onClick={() => handleSort('repName')}>
                    担当者 {sortConfig.key === 'repName' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="p-3 cursor-pointer hover:bg-green-100" onClick={() => handleSort('boothCount')}>
                    コマ数 {sortConfig.key === 'boothCount' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="p-3">備品(机/椅子)</th>
                  <th className="p-3 cursor-pointer hover:bg-green-100" onClick={() => handleSort('moveInDate')}>
                    搬入日時 {sortConfig.key === 'moveInDate' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th className="p-3">URL</th>
                  <th className="p-3 w-16">操作</th>
                </tr>
              </thead>
              <tbody>
                {sortedMakers.map((m, i) => {
                  const baseUrl = window.location.origin + window.location.pathname;
                  const dashboardUrl = m.accessToken ? `${baseUrl}?mode=dashboard&id=${exhibition.id}&key=${m.accessToken}` : null;
                  return (
                    <tr key={i} className="border-b border-slate-100 hover:bg-green-50 transition-colors group">
                      <td className="p-3 font-bold text-slate-700 group-hover:text-green-700 cursor-pointer" onClick={() => setSelectedMaker(m)}>{m.companyName}</td>
                      <td className="p-3">{m.repName}</td>
                      <td className="p-3">{m.boothCount}</td>
                      <td className="p-3">{m.itemsDesk}/{m.itemsChair}</td>
                      <td className="p-3">{m.moveInDate}</td>
                      <td className="p-3">
                        {dashboardUrl ? (
                          <button
                            onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(dashboardUrl); alert(`${m.companyName}様のダッシュボードURLをコピーしました！`); }}
                            className="bg-slate-100 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"
                            title={dashboardUrl}
                          >
                            <Copy size={12} /> URL
                          </button>
                        ) : '-'}
                      </td>
                      <td className="p-3 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); setSelectedMaker(m); }} className="text-slate-300 hover:text-blue-500" title="詳細表示"><Eye size={16} /></button>
                        <button onClick={(e) => { e.stopPropagation(); startEditMaker(m); }} className="text-slate-300 hover:text-green-500" title="編集"><Edit3 size={16} /></button>
                        <button onClick={(e) => { e.stopPropagation(); deleteMaker(m.id || m.code); }} className="text-slate-300 hover:text-red-500" title="削除"><Trash2 size={16} /></button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {subTab === 'declined' && (
        <div className="animate-fade-in">
          <div className="overflow-x-auto rounded-lg border border-slate-200"><table className="w-full text-left text-sm min-w-[600px]"><thead className="bg-slate-100 text-slate-500 font-bold"><tr><th className="p-3 w-32">コード</th><th className="p-3 w-64">会社名</th><th className="p-3">辞退理由</th></tr></thead><tbody>
            {filteredMakers.map((m, i) => (<tr key={i} className="border-b hover:bg-slate-50"><td className="p-3 font-mono text-slate-500">{m.code}</td><td className="p-3 font-bold text-slate-400 line-through decoration-slate-300">{m.companyName}</td><td className="p-3 text-slate-600">{m.declineReason || m.note || '-'}</td></tr>))}
          </tbody></table></div>
        </div>
      )}

      {subTab === 'unanswered' && (
        <div className="animate-fade-in">
          <div className="bg-red-50 border border-red-200 p-4 rounded-xl mb-6">
            <p className="text-sm text-red-700 font-bold mb-1">未回答（可能性）とは？</p>
            <p className="text-xs text-red-600">招待リストに登録されているが、参加確定・辞退リストに同名の会社が見つからないメーカーを表示しています。（株式会社・㈱等の表記差異を除いて比較）</p>
          </div>
          <div className="overflow-x-auto rounded-lg border border-red-200">
            <table className="w-full text-left text-sm min-w-[600px]">
              <thead className="bg-red-50 text-red-800 font-bold"><tr><th className="p-3 w-32">コード</th><th className="p-3">会社名</th><th className="p-3">備考</th><th className="p-3 w-20">操作</th></tr></thead>
              <tbody>
                {filteredMakers.map((m, i) => (
                  <tr key={i} className="border-b hover:bg-red-50">
                    <td className="p-3 font-mono text-slate-600">{m.code}</td>
                    <td className="p-3 font-bold text-red-700">{m.companyName}</td>
                    <td className="p-3 text-slate-500 text-xs">{m.note || '-'}</td>
                    <td className="p-3">
                      <button onClick={() => deleteMaker(m.id || m.code)} className="text-red-400 hover:text-red-600 p-1" title="削除"><Trash2 size={16} /></button>
                    </td>
                  </tr>
                ))}
                {filteredMakers.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">該当なし（全員回答済みの可能性があります）</td></tr>}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {selectedMaker && <MakerDetailModal maker={selectedMaker} onClose={() => setSelectedMaker(null)} onSave={(updatedMaker) => {
        const updated = makerList.map(m => ((m.id || m.code) === (updatedMaker.id || updatedMaker.code)) ? updatedMaker : m);
        updateMainData('makers', updated);
        setSelectedMaker(null);
        alert('保存しました');
      }} />}
      {isMailConfigOpen && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-slide-up"><div className="bg-slate-50 p-6 border-b"><h3 className="font-bold text-lg">招待メール文面設定</h3></div><div className="p-6 space-y-4"><div><label className="block text-sm font-bold mb-1">件名</label><input className="w-full border p-2 rounded" value={formConfig.mail?.subject} onChange={e => updateMailConfig('subject', e.target.value)} /></div><div><label className="block text-sm font-bold mb-1">本文</label><textarea className="w-full border p-2 rounded h-64 font-mono text-sm" value={formConfig.mail?.body} onChange={e => updateMailConfig('body', e.target.value)} /></div></div><div className="p-6 border-t flex justify-end gap-2"><button onClick={() => setIsMailConfigOpen(false)} className="bg-slate-200 px-4 py-2 rounded font-bold">閉じる</button></div></div></div>}
      {isFormEditorOpen && <FormEditorModal config={formConfig} onSave={handleConfigUpdate} onClose={() => setIsFormEditorOpen(false)} />}
      {isResponseDemoOpen && <MakerResponseForm config={formConfig} onClose={() => setIsResponseDemoOpen(false)} onSubmit={handleFormResponse} />}
      {isEditMakerOpen && (
        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl p-6 w-96 shadow-xl">
            <h3 className="font-bold text-lg mb-4">メーカー情報編集</h3>
            <div className="mb-4"><label className="block text-xs font-bold text-slate-500 mb-1">仕入先コード</label><input className="w-full border p-2 rounded" value={editingMakerData.code} onChange={e => setEditingMakerData({ ...editingMakerData, code: e.target.value })} /></div>
            <div className="mb-4"><label className="block text-xs font-bold text-slate-500 mb-1">会社名</label><input className="w-full border p-2 rounded" value={editingMakerData.companyName} onChange={e => setEditingMakerData({ ...editingMakerData, companyName: e.target.value })} /></div>
            <div className="flex justify-end gap-2"><button onClick={() => setIsEditMakerOpen(false)} className="bg-slate-200 px-4 py-2 rounded">キャンセル</button><button onClick={saveEditMaker} className="bg-blue-600 text-white px-4 py-2 rounded">保存</button></div>
          </div>
        </div>
      )}
    </div>
  );
}

// TabEntrance: QRスキャン実装 (修正版: 連打防止・URL表示)
function TabEntrance({ exhibition, updateVisitorCount, visitors, setVisitors, updateMainData, initialMode }) {
  const { formUrlVisitor, visitorFormConfig } = exhibition;
  const [mode, setMode] = useState(initialMode || 'dashboard');
  const [showSimulatedPublicForm, setShowSimulatedPublicForm] = useState(false);
  const [lastScannedVisitor, setLastScannedVisitor] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [shortUrl, setShortUrl] = useState('');
  const [isShortening, setIsShortening] = useState(false);
  const [isCopied, setIsCopied] = useState(false); // isCopied state for TabEntrance
  const [isScanning, setIsScanning] = useState(true); // Scanner state for TabEntrance

  // 連続読み取り防止用のRef
  const lastScanTime = useRef(0);

  // Scanner handler for TabEntrance
  const handleScan = (result) => {
    if (!result || result.length === 0 || !isScanning) return;
    const rawValue = result[0]?.rawValue;
    if (rawValue) {
      handleRealScan(rawValue);
    }
  };

  // URL短縮機能 (is.gd - 直接リダイレクト、英語ページ表示なし)
  const shortenUrl = async () => {
    if (!formUrlVisitor) return;
    setIsShortening(true);
    try {
      // is.gd API (無料・認証不要・直接リダイレクト)
      const response = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(formUrlVisitor)}`);
      if (response.ok) {
        const shortened = await response.text();
        setShortUrl(shortened);
        navigator.clipboard.writeText(shortened);
        alert('短縮URLをクリップボードにコピーしました！\nQRコードに使用できます。');
      } else {
        alert('URL短縮に失敗しました');
      }
    } catch (e) {
      alert('URL短縮エラー: ' + e.message);
    }
    setIsShortening(false);
  };

  // URLリフレッシュ機能
  const refreshVisitorUrl = () => {
    if (!window.confirm('来場者登録フォームのURLを更新します。\n古いURLは無効になりますがよろしいですか？')) return;
    const baseUrl = window.location.origin + window.location.pathname;
    const newUrl = `${baseUrl}?mode=visitor_register&id=${exhibition.id}`;
    updateMainData('formUrlVisitor', newUrl);
    setShortUrl(''); // 短縮URLもクリア
    alert('URLを更新しました！');
  };

  // Copy function for TabEntrance
  const copyVisitorFormUrl = () => {
    const urlToCopy = shortUrl || formUrlVisitor;
    if (!urlToCopy) return;
    navigator.clipboard.writeText(urlToCopy);
    setIsCopied(true);
    setTimeout(() => setIsCopied(false), 2000);
  };

  useEffect(() => {
    if (initialMode) setMode(initialMode);
  }, [initialMode]);

  const handleConfigSave = (newConfig) => {
    updateMainData('visitorFormConfig', newConfig);
    setMode('dashboard');
  };

  // 実機スキャン用ハンドラ (react-qr-scanner用) - 修正版
  const handleRealScan = (dataString) => {
    if (!dataString) return;

    // クールダウン処理（2秒間は再スキャンしない）
    const now = Date.now();
    if (now - lastScanTime.current < 2000) return;
    lastScanTime.current = now;

    try {
      const data = JSON.parse(dataString);

      // データ形式チェック
      if (!data.id) return;

      const exists = visitors.find(v => v.id === data.id);

      if (exists) {
        if (exists.status !== 'checked-in') {
          const updated = visitors.map(v => v.id === data.id ? { ...v, status: 'checked-in' } : v);
          updateMainData('visitors', updated);
          updateVisitorCount(exhibition.id, exhibition.currentVisitors + 1);
          setLastScannedVisitor({ ...exists, status: 'checked-in', isNew: false });
        } else {
          setLastScannedVisitor({ ...exists, msg: '既に入場済みです' });
        }
      } else {
        alert("未登録のQRコードです");
      }
    } catch (e) {
      console.log('Invalid QR Data', e);
    }
  };

  const handlePublicRegister = (data) => {
    const newVisitor = { id: crypto.randomUUID(), ...data, status: 'registered' };
    updateMainData('visitors', [...visitors, newVisitor]);
    setShowSimulatedPublicForm(false);
    alert(`登録完了！\n${newVisitor.companyName} 様`);
  };

  const filteredVisitors = visitors.filter(v =>
    (v.companyName || '').includes(searchTerm) || (v.repName || '').includes(searchTerm)
  );

  return (
    <div className="flex flex-col md:flex-row h-[800px]">
      <div className="w-full md:w-64 bg-slate-50 border-r border-slate-200 p-4 flex flex-row md:flex-col gap-2 overflow-x-auto">
        <h3 className="font-bold text-slate-500 mb-2 px-2 hidden md:block">Entrance Menu</h3>
        <button onClick={() => setMode('dashboard')} className={`flex-1 md:flex-none text-left px-4 py-3 rounded-lg font-bold flex items-center justify-center md:justify-start gap-2 whitespace-nowrap ${mode === 'dashboard' ? 'bg-blue-100 text-blue-700' : 'hover:bg-slate-100 text-slate-600'}`}><List size={18} /> <span className="hidden md:inline">来場者リスト</span><span className="md:hidden">リスト</span></button>
        <button onClick={() => setMode('scanner')} className={`flex-1 md:flex-none text-left px-4 py-3 rounded-lg font-bold flex items-center justify-center md:justify-start gap-2 whitespace-nowrap ${mode === 'scanner' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-100 text-slate-600'}`}><ScanLine size={18} /> <span className="hidden md:inline">QR受付スキャン</span><span className="md:hidden">スキャン</span></button>
        <div className="border-t my-2 hidden md:block"></div>
        <button onClick={() => setMode('editForm')} className={`flex-1 md:flex-none text-left px-4 py-3 rounded-lg font-bold flex items-center justify-center md:justify-start gap-2 whitespace-nowrap ${mode === 'editForm' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 text-slate-600'}`}><Settings size={18} /> <span className="hidden md:inline">登録フォーム編集</span><span className="md:hidden">設定</span></button>
      </div>

      <div className="flex-1 overflow-y-auto bg-white p-4 md:p-8">

        {/* 事前登録URL表示エリア */}
        <div className="bg-slate-900 text-slate-300 rounded-xl p-5 mb-6">
          <div className="flex flex-col md:flex-row items-center justify-between gap-4">
            <div className="flex-1 w-full">
              <h4 className="font-bold text-white mb-1 flex items-center gap-2"><QrCode size={18} /> 事前登録用フォーム</h4>
              <p className="text-xs text-slate-400">このURLを来場予定者に共有してください。</p>
              <div className="mt-2 flex gap-2">
                <input type="text" value={shortUrl || formUrlVisitor} readOnly className="bg-slate-800 text-blue-300 text-xs px-3 py-2 rounded border border-slate-700 w-full" />
                <button className={`px-3 py-2 rounded text-xs flex items-center gap-1 shrink-0 transition-colors ${isCopied ? 'bg-green-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-white'}`} onClick={copyVisitorFormUrl}>{isCopied ? <Check size={14} /> : <Copy size={14} />} {isCopied ? 'コピー完了' : 'コピー'}</button>
                <button onClick={refreshVisitorUrl} className="bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded text-xs flex items-center gap-1 shrink-0" title="URLを更新"><RefreshCcw size={14} /> 更新</button>
              </div>
              {/* QRコード作成リンク */}
              <div className="mt-3 flex items-center gap-2">
                <a
                  href="https://qr.paps.jp/"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-xs font-bold flex items-center gap-2 transition-colors"
                >
                  <QrCode size={14} /> QRコードを作成（外部サイト）
                </a>
                <span className="text-xs text-slate-400">URLをコピーしてQRコード作成サイトに貼り付けてください</span>
              </div>
            </div>
            <div className="flex gap-2 w-full md:w-auto">
              <button onClick={() => setShowSimulatedPublicForm(true)} className="flex-1 md:flex-none bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-lg transform hover:scale-105 transition-all"><ExternalLink size={18} /> 登録画面 (デモ)</button>
            </div>
          </div>
        </div>

        {mode === 'dashboard' && (
          <div className="animate-fade-in">
            <div className="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
              <div><h2 className="text-2xl font-bold text-slate-800">来場者リスト</h2></div>
              <div className="flex items-center gap-4 w-full md:w-auto">
                <div className="relative w-full md:w-auto">
                  <Search size={16} className="absolute left-3 top-3 text-slate-400" />
                  <input type="text" placeholder="名前・会社名で検索" className="pl-9 pr-4 py-2 border rounded-full text-sm w-full md:w-64 focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                </div>
              </div>
            </div>
            <div className="border border-slate-200 rounded-xl overflow-x-auto">
              <table className="w-full text-left text-sm min-w-[600px]">
                <thead className="bg-slate-50 text-slate-500 font-bold border-b"><tr><th className="p-4">ステータス</th><th className="p-4">受付区分</th><th className="p-4">氏名</th><th className="p-4">会社名</th><th className="p-4">人数</th></tr></thead>
                <tbody>
                  {filteredVisitors.map((v) => (
                    <tr key={v.id} className="border-b hover:bg-slate-50 transition-colors">
                      <td className="p-4">{v.status === 'checked-in' ? <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center w-fit gap-1"><CheckCircle size={12} /> 来場済</span> : <span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold">未入場</span>}</td>
                      <td className="p-4 text-slate-600">{v.type}</td><td className="p-4 font-bold text-slate-800">{v.repName}</td><td className="p-4 text-slate-600">{v.companyName}</td><td className="p-4 text-slate-600">{v.count}名</td>
                    </tr>
                  ))}
                  {filteredVisitors.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">該当なし</td></tr>}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {mode === 'scanner' && (
          <div className="flex flex-col items-center justify-center h-full animate-fade-in relative">
            <div className="bg-slate-900 rounded-3xl p-4 md:p-8 shadow-2xl w-full max-w-lg text-center relative overflow-hidden">
              <h2 className="text-xl md:text-2xl font-bold text-white mb-6 flex items-center justify-center gap-2"><Camera className="text-blue-400" /> QR Scanner</h2>

              {/* 実機カメラエリア */}
              <div className="rounded-xl overflow-hidden mb-6 bg-black relative border-2 border-slate-700 aspect-square">
                {isScanning ? (
                  <Scanner
                    onScan={handleScan}
                    styles={{ container: { width: '100%', height: '100%' } }}
                    allowMultiple={true}
                    scanDelay={500}
                    components={{
                      audio: false, // 独自のBEEP音を使うため無効化
                      onOff: false,
                      torch: false,
                    }}
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center bg-slate-900 text-white">
                    <p className="font-bold animate-pulse">Processing...</p>
                  </div>
                )}
                <div className="absolute inset-0 border-2 border-blue-500/50 pointer-events-none"></div>
              </div>

              {lastScannedVisitor && (
                <div className="bg-green-600 rounded-xl p-4 text-white animate-slide-up shadow-lg text-left">
                  <div className="flex items-center gap-4"><div className="bg-white/20 p-3 rounded-full"><UserCheck size={32} /></div><div><p className="text-xs opacity-80 uppercase tracking-wider font-bold">Check-in Complete</p><p className="text-xl font-bold">{lastScannedVisitor.repName} 様</p><p className="text-sm opacity-90">{lastScannedVisitor.companyName}</p></div></div>
                  {lastScannedVisitor.msg && <p className="mt-2 text-yellow-300 text-sm font-bold bg-black/20 p-1 rounded">{lastScannedVisitor.msg}</p>}
                </div>
              )}
              <p className="text-slate-500 text-xs mt-4">カメラへのアクセスを許可してください</p>
            </div>
          </div>
        )}

        {mode === 'editForm' && <VisitorFormEditor config={visitorFormConfig} onSave={handleConfigSave} />}
      </div>
      {showSimulatedPublicForm && <SimulatedPublicVisitorForm config={visitorFormConfig} onClose={() => setShowSimulatedPublicForm(false)} onSubmit={handlePublicRegister} />}
    </div>
  );
}
// ============================================================================
// 6. 公開フォーム・ダッシュボード・アプリ本体
// ============================================================================

// -----------------------------------------------------------
// 公開フォーム: ダウンロード機能付き（スマホ対応修正版）
// -----------------------------------------------------------
function PublicVisitorView({ exhibition, onSubmit }) {
  const { visitorFormConfig } = exhibition;
  const [formData, setFormData] = useState({});
  const [submitted, setSubmitted] = useState(false);
  const [qrData, setQrData] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    const visitorId = crypto.randomUUID();
    // QRコードにはIDのみ埋め込む（シンプルなQRで読み取りやすく）
    setQrData(visitorId);

    const finalData = { ...formData, id: visitorId };
    const success = await onSubmit(finalData);
    if (success) setSubmitted(true);
  };

  // 画像保存処理
  const downloadQR = () => {
    // ラッパーdivの中にあるcanvas要素を確実に探す
    const canvas = document.querySelector('#qr-wrapper canvas');

    if (canvas) {
      try {
        const pngUrl = canvas.toDataURL("image/png");

        // ダウンロード用リンクを作成してクリック
        const downloadLink = document.createElement("a");
        downloadLink.href = pngUrl;
        downloadLink.download = `visitor_qr_${Date.now()}.png`; // ユニークなファイル名
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      } catch (e) {
        // エラー時はアラートを出す
        alert("保存に失敗しました。QRコードを長押しして「写真に保存」してください。");
      }
    } else {
      alert("QRコードの生成待ちです。もう一度押してください。");
    }
  };

  if (submitted) {
    return (
      <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
        <div className="bg-white max-w-md w-full rounded-2xl shadow-xl p-8 text-center animate-fade-in">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 mx-auto mb-4"><Check size={32} strokeWidth={3} /></div>
          <h2 className="text-2xl font-bold text-slate-800 mb-2">登録完了</h2>
          <p className="text-slate-600 text-sm mb-6">以下のQRコードを保存し、当日受付にご提示ください。</p>

          {/* ID付きのdivで囲む (ダウンロード機能用) */}
          <div id="qr-wrapper" className="bg-white border-2 border-slate-800 p-4 rounded-xl inline-block mb-6">
            <QRCodeCanvas
              value={qrData}
              size={200}
              level={"H"}
              includeMargin={true}
            />
          </div>

          <button onClick={downloadQR} className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl mb-2 flex items-center justify-center gap-2 hover:bg-slate-700">
            <Download size={18} /> 画像として保存
          </button>
          {/* スマホユーザーへの案内 */}
          <p className="text-xs text-slate-400 mb-6">※ボタンで保存できない場合は、<br />QRコードを長押しして「写真に保存」してください。</p>

          <div className="bg-slate-50 p-4 rounded-lg text-left text-sm space-y-2 mb-6"><div className="flex justify-between"><span className="text-slate-500">氏名</span><span className="font-bold">{formData.repName || '-'}</span></div><div className="flex justify-between"><span className="text-slate-500">会社名</span><span className="font-bold">{formData.companyName || '-'}</span></div></div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8">
      <div className="max-w-xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <div className="bg-blue-600 p-6 text-white"><h1 className="text-xl font-bold mb-2">{exhibition.title}</h1><h2 className="text-lg opacity-90">{visitorFormConfig.title}</h2></div>
        <div className="p-6 md:p-8"><form onSubmit={handleSubmit} className="space-y-5">{visitorFormConfig.items.map(item => (<div key={item.id}><label className="block text-sm font-bold text-slate-700 mb-1">{item.label} {item.required && <span className="text-red-500">*</span>}</label>{item.type === 'select' ? (<select required={item.required} className="w-full border border-slate-300 p-3 rounded-lg bg-white outline-none" onChange={e => setFormData({ ...formData, [item.id]: e.target.value })}><option value="">選択してください</option>{item.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>) : (<input type={item.type} required={item.required} className="w-full border border-slate-300 p-3 rounded-lg outline-none" placeholder={item.help} onChange={e => setFormData({ ...formData, [item.id]: e.target.value })} />)}</div>))}<button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all mt-4">登録してQRコードを発行</button></form></div>
      </div>
    </div>
  );
}

function PublicMakerView({ exhibition, onSubmit }) {
  return <MakerResponseForm config={exhibition.formConfig} onClose={() => { }} onSubmit={async (data) => { await onSubmit(data); }} />;
}

function DashboardView({ exhibitions, onCreateClick, onCardClick, onDeleteClick }) {
  // Helper function to calculate days until event
  const getDaysUntil = (dates) => {
    if (!dates || dates.length === 0) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const eventDates = dates.map(d => new Date(d)).sort((a, b) => a - b);
    const firstDate = eventDates[0];
    const lastDate = eventDates[eventDates.length - 1];
    const diffFirst = Math.ceil((firstDate - today) / (1000 * 60 * 60 * 24));
    const diffLast = Math.ceil((lastDate - today) / (1000 * 60 * 60 * 24));
    return { daysUntilFirst: diffFirst, daysUntilLast: diffLast, isPast: diffLast < 0 };
  };

  return (
    <div className="space-y-8 animate-fade-in">
      <div className="flex flex-col md:flex-row justify-between items-end gap-4"><div><h2 className="text-3xl font-bold text-slate-800">Projects</h2><p className="text-slate-500 mt-1">現在進行中の展示会プロジェクト一覧</p></div><button onClick={onCreateClick} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow-lg transition-all hover:-translate-y-1"><Plus size={20} /> 新規展示会を作成</button></div>
      {exhibitions.length === 0 ? (<div className="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300"><p className="text-slate-400 mb-4">まだプロジェクトがありません</p><button onClick={onCreateClick} className="text-blue-600 font-bold hover:underline">最初の展示会を作成する</button></div>) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{exhibitions.map((ex) => {
          const visitorProgress = Math.min((ex.currentVisitors / ex.targetVisitors) * 100, 100);
          const eventDateStr = ex.dates && ex.dates.length > 0 ? ex.dates[0] : null;
          const countdown = getDaysUntil(ex.dates);
          const isPast = countdown?.isPast || false;

          return (
            <div key={ex.id} onClick={() => onCardClick(ex)} className={`group bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden flex flex-col relative ${isPast ? 'opacity-60 grayscale' : ''}`}>
              <button onClick={(e) => { e.stopPropagation(); onDeleteClick(ex.id); }} className="absolute top-2 right-2 z-10 bg-white/80 p-2 rounded-full hover:bg-red-100 text-slate-400 hover:text-red-500 transition-colors"><Trash2 size={16} /></button>

              {/* Countdown Badge */}
              {countdown && (
                <div className={`absolute top-2 left-2 z-10 px-3 py-1 rounded-full text-xs font-bold shadow ${isPast ? 'bg-slate-600 text-white' :
                  countdown.daysUntilFirst <= 7 ? 'bg-red-500 text-white' :
                    countdown.daysUntilFirst <= 30 ? 'bg-amber-500 text-white' :
                      'bg-blue-500 text-white'
                  }`}>
                  {isPast ? '終了' : countdown.daysUntilFirst === 0 ? '本日開催' : `あと${countdown.daysUntilFirst}日`}
                </div>
              )}

              <div className="h-40 bg-slate-200 relative overflow-hidden"><img src={ex.imageUrl} alt={ex.place} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" /><div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-4"><span className="text-white font-semibold flex items-center gap-1"><MapPin size={16} /> {ex.prefecture}・{ex.place}</span></div></div>
              <div className="p-6 flex-1 flex flex-col">
                <h3 className="text-xl font-bold text-slate-800 mb-2 group-hover:text-blue-600 transition-colors">{ex.title}</h3>
                {eventDateStr && (<div className="flex items-center gap-2 mb-3 text-sm"><Calendar size={14} className="text-blue-500" /><span className="font-bold text-blue-700">{eventDateStr}</span>{ex.dates && ex.dates.length > 1 && <span className="text-slate-400">他{ex.dates.length - 1}日</span>}</div>)}
                <div className="flex flex-wrap gap-2 mb-2">{(ex.preDates && ex.preDates.length > 0) && (<span className="bg-amber-100 text-amber-700 text-xs px-2 py-1 rounded-md font-bold">前日搬入あり</span>)}</div>
                <div className="mt-auto pt-4 border-t border-slate-100"><div className="flex justify-between text-xs mb-1"><span className="text-slate-500">集客目標</span><span className="font-bold text-slate-700">{ex.currentVisitors.toLocaleString()} / {ex.targetVisitors.toLocaleString()}</span></div><div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{ width: `${visitorProgress}%` }}></div></div></div>
              </div>
            </div>
          );
        })}</div>
      )}
    </div>
  );
}

function CreateExhibitionForm({ data, setData, onCancel, onSubmit }) {
  const [tempDate, setTempDate] = useState(''); const [tempPreDate, setTempPreDate] = useState(''); const [staffName, setStaffName] = useState(''); const [isFetchingImg, setIsFetchingImg] = useState(false);
  const [validationErrors, setValidationErrors] = useState([]);

  const handleChange = (e) => setData({ ...data, [e.target.name]: e.target.value });
  const addDate = (type) => { if (type === 'main' && tempDate) { setData({ ...data, dates: [...data.dates, tempDate].sort() }); setTempDate(''); } else if (type === 'pre' && tempPreDate) { setData({ ...data, preDates: [...data.preDates, tempPreDate].sort() }); setTempPreDate(''); } };
  const removeDate = (type, index) => { if (type === 'main') { const newDates = [...data.dates]; newDates.splice(index, 1); setData({ ...data, dates: newDates }); } else { const newPreDates = [...data.preDates]; newPreDates.splice(index, 1); setData({ ...data, preDates: newPreDates }); } };
  const addStaff = () => { if (!staffName.trim()) return; const currentStaff = data.staff ? data.staff.split(',').map(s => s.trim()) : []; setData({ ...data, staff: [...currentStaff, staffName].join(', ') }); setStaffName(''); };
  const removeStaff = (name) => { const currentStaff = data.staff ? data.staff.split(',').map(s => s.trim()) : []; setData({ ...data, staff: currentStaff.filter(s => s !== name).join(', ') }); };
  const simulateFetchImage = () => { if (!data.venueUrl) return; setIsFetchingImg(true); setTimeout(() => { const mockImages = ['https://images.unsplash.com/photo-1587825140708-dfaf72ae4b04?auto=format&fit=crop&w=800&q=80', 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?auto=format&fit=crop&w=800&q=80', 'https://images.unsplash.com/photo-1560439514-e960a3ef5019?auto=format&fit=crop&w=800&q=80']; const random = mockImages[Math.floor(Math.random() * mockImages.length)]; setData({ ...data, imageUrl: random }); setIsFetchingImg(false); }, 1500); };

  // Validation function
  const validateAndSubmit = () => {
    const errors = [];
    if (!data.title.trim()) errors.push('展示会タイトルは必須です');
    if (!data.dates || data.dates.length === 0) errors.push('開催日を1日以上追加してください');
    if (!data.targetVisitors || data.targetVisitors <= 0) errors.push('集客目標を入力してください');
    if (!data.targetMakers || data.targetMakers <= 0) errors.push('招致メーカー目標を入力してください');
    if (!data.targetProfit || data.targetProfit <= 0) errors.push('目標利益額を入力してください');
    if (!data.staff || data.staff.split(',').filter(s => s.trim()).length === 0) errors.push('運営スタッフを1人以上追加してください');

    if (errors.length > 0) {
      setValidationErrors(errors);
      return;
    }
    setValidationErrors([]);
    onSubmit();
  };

  const RequiredLabel = ({ children }) => (
    <label className="block text-sm font-medium text-slate-600 mb-1">
      {children} <span className="text-red-500">*</span>
    </label>
  );

  return (
    <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden animate-slide-up">
      <div className="bg-slate-900 p-8 text-white flex justify-between items-center"><div><h2 className="text-2xl font-bold">New Exhibition Project</h2><p className="text-slate-400">新しい展示会プロジェクトを立ち上げます</p></div><button onClick={onCancel} className="p-2 hover:bg-slate-800 rounded-full"><X size={24} /></button></div>
      <div className="p-8 space-y-8 h-[70vh] overflow-y-auto">
        {validationErrors.length > 0 && (
          <div className="bg-red-50 border border-red-200 p-4 rounded-lg">
            <p className="text-red-700 font-bold text-sm mb-2">以下の項目を確認してください：</p>
            <ul className="text-red-600 text-sm list-disc list-inside">
              {validationErrors.map((err, i) => <li key={i}>{err}</li>)}
            </ul>
          </div>
        )}

        <section><h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4 flex items-center gap-2"><FileText className="text-blue-600" /> 基本情報</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="col-span-2"><RequiredLabel>展示会タイトル</RequiredLabel><input type="text" name="title" value={data.title} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例：2026 未来技術展" /></div><div><RequiredLabel>開催日 (複数可)</RequiredLabel><div className="flex gap-2 mb-2"><input type="date" value={tempDate} onChange={e => setTempDate(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg" /><button onClick={() => addDate('main')} className="bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200"><Plus size={20} /></button></div><div className="flex flex-wrap gap-2">{data.dates.map((d, i) => (<span key={i} className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm flex items-center gap-1">{d} <button onClick={() => removeDate('main', i)}><X size={12} /></button></span>))}</div></div><div><label className="block text-sm font-medium text-slate-600 mb-1">事前準備日 (複数可)</label><div className="flex gap-2 mb-2"><input type="date" value={tempPreDate} onChange={e => setTempPreDate(e.target.value)} className="flex-1 p-2 border border-slate-200 rounded-lg" /><button onClick={() => addDate('pre')} className="bg-amber-100 text-amber-600 p-2 rounded-lg hover:bg-amber-200"><Plus size={20} /></button></div><div className="flex flex-wrap gap-2">{data.preDates.map((d, i) => (<span key={i} className="bg-amber-50 text-amber-700 px-2 py-1 rounded text-sm flex items-center gap-1">{d} <button onClick={() => removeDate('pre', i)}><X size={12} /></button></span>))}</div></div></div></section>

        <section><h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4 flex items-center gap-2"><MapPin className="text-blue-600" /> エリア・会場・Web</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-slate-600 mb-1">エリア選択</label><select name="prefecture" value={data.prefecture} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg bg-white"><option value="">都道府県を選択...</option>{PREFECTURES.map(group => (<optgroup key={group.region} label={group.region}>{group.prefs.map(p => <option key={p} value={p}>{p}</option>)}</optgroup>))}</select></div><div><label className="block text-sm font-medium text-slate-600 mb-1">会場名（予定）</label><input type="text" name="place" value={data.place} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" placeholder="例：福岡国際センター" /></div><div className="col-span-2"><label className="block text-sm font-medium text-slate-600 mb-1">会場住所</label><input type="text" name="venueAddress" value={data.venueAddress} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" placeholder="例：福岡県福岡市博多区石城町２−１" /></div><div><label className="block text-sm font-medium text-slate-600 mb-1">開場時間</label><input type="time" name="openTime" value={data.openTime} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" /></div><div><label className="block text-sm font-medium text-slate-600 mb-1">閉場時間</label><input type="time" name="closeTime" value={data.closeTime} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" /></div><div className="col-span-2"><label className="block text-sm font-medium text-slate-600 mb-1">展示会場URL</label><div className="flex gap-2"><input type="text" name="venueUrl" value={data.venueUrl} onChange={handleChange} className="flex-1 p-3 border border-slate-200 rounded-lg" placeholder="https://..." /><button onClick={simulateFetchImage} disabled={!data.venueUrl || isFetchingImg} className="bg-slate-800 text-white px-4 rounded-lg text-sm font-bold hover:bg-slate-700 disabled:opacity-50 flex items-center gap-2 whitespace-nowrap">{isFetchingImg ? <RefreshCw className="animate-spin" size={16} /> : <LinkIcon size={16} />} 画像を取得</button></div>{data.imageUrl && (<div className="mt-2 p-2 border border-slate-200 rounded-lg bg-slate-50 flex items-center gap-4"><img src={data.imageUrl} alt="Preview" className="w-20 h-14 object-cover rounded" /><span className="text-xs text-green-600 font-bold">✓ 画像を取得しました</span></div>)}</div><div className="col-span-2"><label className="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><Map size={16} /> GoogleマップURL</label><input type="text" name="googleMapsUrl" value={data.googleMapsUrl || ''} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" placeholder="https://maps.google.com/..." /></div><div className="col-span-2"><label className="block text-sm font-medium text-slate-600 mb-1">コンセプト</label><textarea name="concept" value={data.concept} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" rows="3" placeholder="展示会のテーマや狙いを記入" /></div></div></section>

        <section><h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4 flex items-center gap-2"><Target className="text-blue-600" /> 目標設定・チーム</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div><RequiredLabel>集客目標 (人)</RequiredLabel><input type="number" name="targetVisitors" value={data.targetVisitors} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" /></div><div><RequiredLabel>招致メーカー目標 (社)</RequiredLabel><input type="number" name="targetMakers" value={data.targetMakers} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-lg" /></div><div><RequiredLabel>目標利益額 (円)</RequiredLabel><input type="number" name="targetProfit" value={data.targetProfit} onChange={handleChange} className="w-full p-3 border border-blue-300 bg-blue-50 rounded-lg font-bold text-blue-800" placeholder="1000000" /></div><div className="col-span-1 md:col-span-3"><RequiredLabel>運営スタッフ</RequiredLabel><div className="flex gap-2 mb-2"><input type="text" value={staffName} onChange={e => setStaffName(e.target.value)} className="flex-1 p-3 border border-slate-200 rounded-lg" placeholder="スタッフ名" /><button onClick={addStaff} className="bg-slate-800 text-white px-4 rounded-lg"><Plus /></button></div><div className="flex flex-wrap gap-2">{data.staff && data.staff.split(',').filter(s => s).map((s, i) => (<span key={i} className="bg-slate-100 text-slate-700 px-3 py-1 rounded-full flex items-center gap-2 text-sm">{s.trim()} <button onClick={() => removeStaff(s.trim())}><X size={14} /></button></span>))}</div></div></div></section>

        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-sm text-yellow-800 flex items-start gap-2"><AlertCircle size={16} className="mt-0.5 shrink-0" /><p>新規作成時、メーカーリストは空の状態で作成されます。後ほどCSVで一括インポートしてください。</p></div>
        <div className="flex justify-end gap-4 pt-4 border-t"><button onClick={onCancel} className="px-6 py-3 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">キャンセル</button><button onClick={validateAndSubmit} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all">プロジェクト作成</button></div>
      </div>
    </div>
  );
}

function ExhibitionDetail({ exhibition, onBack, updateVisitorCount, updateExhibitionData, batchUpdateExhibitionData }) {
  const [activeTab, setActiveTab] = useState('main');
  const [entranceMode, setEntranceMode] = useState('dashboard'); // QRスキャナーモード制御用

  const setVenueDetails = (d) => updateExhibitionData(exhibition.id, 'venueDetails', d);
  const setMakers = (m) => updateExhibitionData(exhibition.id, 'makers', m);
  const setVisitors = (v) => updateExhibitionData(exhibition.id, 'visitors', v);
  const setTasks = (t) => updateExhibitionData(exhibition.id, 'tasks', t);
  const updateMainData = (k, v) => updateExhibitionData(exhibition.id, k, v);
  const updateMainDataBatch = (updates) => batchUpdateExhibitionData(exhibition.id, updates);

  // QRスキャナーを直接開くハンドラ
  const openScanner = () => {
    setActiveTab('entrance');
    setEntranceMode('scanner');
  };

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <button onClick={onBack} className="text-slate-400 hover:text-blue-600 flex items-center gap-1 mb-2 text-sm">
            <ArrowLeft size={16} /> ダッシュボードに戻る
          </button>
          <div className="flex items-center gap-4 flex-wrap">
            {/* 開催日表示 */}
            <div className="flex flex-col items-start gap-1">
              {exhibition.dates && exhibition.dates.length > 0 && (
                <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-bold text-sm flex items-center gap-2">
                  <Calendar size={14} /> {exhibition.dates[0]}
                  {exhibition.dates.length > 1 && <span className="text-blue-500">(+{exhibition.dates.length - 1}日)</span>}
                </span>
              )}
              {exhibition.preDates && exhibition.preDates.length > 0 && (
                <span className="bg-amber-100 text-amber-700 px-3 py-1 rounded-lg font-bold text-sm flex items-center gap-2">
                  <Truck size={14} /> 前日搬入あり
                </span>
              )}
            </div>
            <h1 className="text-3xl font-bold text-slate-800">{exhibition.title}</h1>
            {/* プロジェクトタイトル横のQRスキャンボタン */}
            <button
              onClick={openScanner}
              className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95"
              title="QRスキャナーを起動"
            >
              <ScanLine size={20} />
            </button>
          </div>
        </div>
      </div>

      <div className="flex overflow-x-auto gap-2 border-b border-slate-200 pb-1 scrollbar-hide">
        {ALL_TAB_DEFINITIONS.map(tab => (
          <button key={tab.id} onClick={() => { setActiveTab(tab.id); if (tab.id !== 'entrance') setEntranceMode('dashboard'); }} className={`flex items-center gap-2 px-4 py-3 rounded-t-lg font-medium transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-800 hover:bg-white/50'}`}><tab.icon size={18} /> {tab.label}</button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-slate-100 min-h-[500px]">
        {activeTab === 'main' && <TabMainBoard exhibition={exhibition} updateMainData={updateMainData} updateBatch={updateMainDataBatch} tasks={exhibition.tasks || []} />}
        {activeTab === 'schedule' && <TabSchedule scheduleData={exhibition.schedule} updateMainData={updateMainData} staff={exhibition.staff || ''} dates={exhibition.dates || []} preDates={exhibition.preDates || []} />}
        {activeTab === 'equipment' && <TabEquipment details={exhibition.venueDetails || {}} setDetails={setVenueDetails} />}
        {activeTab === 'makers' && <TabMakers exhibition={exhibition} setMakers={setMakers} updateMainData={updateMainData} />}
        {activeTab === 'tasks' && <TabTasks tasks={exhibition.tasks || []} setTasks={setTasks} staff={exhibition.staff || ''} />}
        {activeTab === 'budget' && <TabBudget exhibition={exhibition} updateMainData={updateMainData} />}
        {activeTab === 'entrance' && <TabEntrance exhibition={exhibition} updateVisitorCount={updateVisitorCount} visitors={exhibition.visitors || []} setVisitors={setVisitors} updateMainData={updateMainData} initialMode={entranceMode} />}
        {activeTab === 'lectures' && <TabLectures lectures={exhibition.lectures || []} updateMainData={updateMainData} staff={exhibition.staff || ''} />}
        {activeTab === 'files' && <TabFiles />}
      </div>
    </div>
  );
}

function App() {
  const [view, setView] = useState('loading');
  const [exhibitions, setExhibitions] = useState([]);
  const [selectedExhibition, setSelectedExhibition] = useState(null);
  const [newExhibition, setNewExhibition] = useState({ title: '', dates: [], preDates: [], place: '', prefecture: '', venueAddress: '', openTime: '10:00', closeTime: '17:00', concept: '', targetVisitors: 0, targetMakers: 0, targetProfit: 0, venueUrl: '', googleMapsUrl: '', imageUrl: '', staff: '' });

  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [appId, setAppId] = useState(null);
  const [urlMode, setUrlMode] = useState('dashboard');
  const [targetExhibitionId, setTargetExhibitionId] = useState(null);
  const [dashboardMaker, setDashboardMaker] = useState(null);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // Login State
  const [isAuthenticated, setIsAuthenticated] = useState(() => {
    return localStorage.getItem('exhibition_auth') === 'true';
  });
  const [loginPassword, setLoginPassword] = useState('');
  const [loginError, setLoginError] = useState('');

  const PASSCODE = 'kuwanatakashi';

  const handleLogin = () => {
    if (loginPassword === PASSCODE) {
      localStorage.setItem('exhibition_auth', 'true');
      setIsAuthenticated(true);
      setLoginError('');
    } else {
      setLoginError('パスワードが正しくありません');
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('exhibition_auth');
    setIsAuthenticated(false);
  };

  useEffect(() => {
    const init = async () => {
      // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
      // ここにあなたの Firebase Config を貼り付けてください
      const firebaseConfig = {
        apiKey: "AIzaSyDsIpXihZp7hQE2yeNcGxgPH-2iU-Obt-s",
        authDomain: "exhibition-app-891e0.firebaseapp.com",
        projectId: "exhibition-app-891e0",
        storageBucket: "exhibition-app-891e0.firebasestorage.app",
        messagingSenderId: "374193547856",
        appId: "1:374193547856:web:1e71260bfe402d626cbf55"
      };
      // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        setAppId('default-app');
        setDb(firestore);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => setUser(u));
      } catch (e) {
        console.error("Firebase init failed:", e);
      }
    };
    init();
  }, []);

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');
    const id = params.get('id');
    if (mode && id) {
      setUrlMode(mode);
      setTargetExhibitionId(id);
    } else {
      setUrlMode('dashboard');
    }
  }, []);

  useEffect(() => {
    if (!user || !db || !appId) return;
    const exRef = collection(db, 'artifacts', appId, 'public', 'data', 'exhibitions');
    const unsubscribe = onSnapshot(exRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      data.sort((a, b) => b.createdAt - a.createdAt);
      setExhibitions(data);

      // ★追加: 選択中の展示会データもリアルタイム更新する
      if (selectedExhibition) {
        const latest = data.find(e => e.id === selectedExhibition.id);
        if (latest) {
          // JSON.stringifyで比較して変更がある場合のみ更新（ループ防止）
          if (JSON.stringify(latest) !== JSON.stringify(selectedExhibition)) {
            console.log('[DEBUG] Syncing selectedExhibition from server snapshot');
            setSelectedExhibition(latest);
          }
        }
      }

      if (urlMode === 'visitor_register' && targetExhibitionId) {
        const target = data.find(e => e.id === targetExhibitionId);
        if (target) { setSelectedExhibition(target); setView('public_visitor_form'); }
        else { setView('not_found'); }
      } else if (urlMode === 'maker_register' && targetExhibitionId) {
        const target = data.find(e => e.id === targetExhibitionId);
        if (target) { setSelectedExhibition(target); setView('public_maker_form'); }
        else { setView('not_found'); }
      } else if (urlMode === 'dashboard') { // Maker Dashboard Logic
        const params = new URLSearchParams(window.location.search);
        const key = params.get('key');
        if (key && targetExhibitionId) {
          const target = data.find(e => e.id === targetExhibitionId);
          if (target) {
            const maker = (target.makers || []).find(m => m.accessToken === key);
            if (maker) {
              setSelectedExhibition(target);
              setDashboardMaker(maker);
              setView('maker_dashboard');
            } else {
              setView('not_found'); // Invalid Token
            }
          } else {
            setView('not_found');
          }
        } else {
          setView(prev => prev === 'loading' ? 'dashboard' : prev); // Login functionality?
        }
      } else {
        setView(prev => prev === 'loading' ? 'dashboard' : prev);
      }
    });
    return () => unsubscribe();
  }, [user, db, appId, urlMode, targetExhibitionId, selectedExhibition]); // selectedExhibitionを依存配列に追加（注意: 無限ループ対策済み）

  const handleCreate = async () => {
    if (!user || !db) return;
    const id = crypto.randomUUID();
    const finalImg = newExhibition.imageUrl || 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&w=800&q=80';
    const baseUrl = window.location.origin + window.location.pathname;
    const formUrlMaker = `${baseUrl}?mode=maker_register&id=${id}`;
    const formUrlVisitor = `${baseUrl}?mode=visitor_register&id=${id}`;

    // メーカー初期リストは空配列を使用（CSV取込前提）
    const newProject = {
      ...newExhibition, id, createdAt: Date.now(), currentVisitors: 0, imageUrl: finalImg,
      makers: [], visitors: [], venueDetails: { cost: 0, equipment: [], notes: '', internalSupplies: INITIAL_INTERNAL_SUPPLIES },
      otherBudgets: [], tasks: INITIAL_TASKS, formUrlMaker, formUrlVisitor,
      formConfig: DEFAULT_FORM_CONFIG, visitorFormConfig: DEFAULT_VISITOR_FORM_CONFIG, hotels: [], schedule: { dayBefore: [], eventDay: [] }
    };
    try {
      console.log('[DEBUG] Creating new project:', newProject);
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'exhibitions', id), newProject);
      console.log('[DEBUG] Creation success');
      setView('dashboard');
      setNewExhibition({ title: '', dates: [], preDates: [], place: '', prefecture: '', venueAddress: '', openTime: '10:00', closeTime: '17:00', concept: '', targetVisitors: 0, targetMakers: 0, targetProfit: 0, venueUrl: '', imageUrl: '', staff: '' });

    } catch (e) {
      console.error('[DEBUG] Creation error:', e);
      alert('作成エラー: ' + e.message);
    }
  };

  const deleteExhibition = async (id) => { if (window.confirm("削除しますか？")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'exhibitions', id)); if (selectedExhibition?.id === id) setView('dashboard'); } };
  const updateExhibitionData = async (id, key, value) => {
    try {
      console.log(`[DEBUG] Updating single key: ${key}`, value);
      const exRef = doc(db, 'artifacts', appId, 'public', 'data', 'exhibitions', id);
      if (selectedExhibition?.id === id) setSelectedExhibition(prev => ({ ...prev, [key]: value }));
      await updateDoc(exRef, { [key]: value });
      console.log(`[DEBUG] Successfully updated ${key}`);
    } catch (e) {
      console.error(`[DEBUG] Error updating ${key}:`, e);
      alert(`保存エラー (${key}): ` + e.message);
    }
  };
  const batchUpdateExhibitionData = async (id, updates) => {
    try {
      console.log('[DEBUG] Batch updating exhibition:', updates);
      // 特別に日付データをチェック
      if (updates.dates) console.log('[DEBUG] Dates to save:', updates.dates);
      if (updates.preDates) console.log('[DEBUG] PreDates to save:', updates.preDates);

      const exRef = doc(db, 'artifacts', appId, 'public', 'data', 'exhibitions', id);
      if (selectedExhibition?.id === id) setSelectedExhibition(prev => ({ ...prev, ...updates }));
      await updateDoc(exRef, updates);
      console.log('[DEBUG] Batch update success');
      console.log('Batch update success');
    } catch (e) {
      console.error('[DEBUG] Batch update error:', e);
      alert('一括保存エラー: ' + e.message);
    }
  };
  const updateVisitorCount = async (id, n) => { updateExhibitionData(id, 'currentVisitors', n); };
  const handlePublicSubmit = async (type, data) => {
    if (!selectedExhibition) return;
    const current = selectedExhibition;

    // ... (rest of handlePublicSubmit)

    let updates = {};
    let finalStatus;
    if (type === 'visitor') {
      const newVisitor = { id: data.id || crypto.randomUUID(), ...data, status: 'registered', registeredAt: Date.now() };
      updates = { visitors: [...(current.visitors || []), newVisitor] };
    } else if (type === 'maker') {
      // デバッグログ
      console.log('[DEBUG] handlePublicSubmit - Received data:', data);
      console.log('[DEBUG] handlePublicSubmit - data.status:', data.status);

      // ステータス判定を厳密に行う
      const isConfirmed = data.status === 'confirmed' ||
        data.status === '出展を申し込む' ||
        data.status === 'Confirmed' ||
        (data.status && data.status.includes('申し込む'));
      finalStatus = isConfirmed ? 'confirmed' : 'declined';

      console.log('[DEBUG] handlePublicSubmit - isConfirmed:', isConfirmed, '-> finalStatus:', finalStatus);

      // 既存のメーカーリストから会社名またはメールで検索
      const existingMakers = current.makers || [];
      const existingIndex = existingMakers.findIndex(m =>
        (m.companyName && m.companyName === data.companyName) ||
        (m.email && m.email === data.email)
      );

      if (existingIndex >= 0) {
        // 既存メーカーを更新（招待リストにいる場合）
        const updatedMakers = [...existingMakers];
        updatedMakers[existingIndex] = {
          ...updatedMakers[existingIndex],
          ...data,
          status: finalStatus,
          respondedAt: Date.now()
        };
        updates = { makers: updatedMakers };
      } else {
        // 新規回答者（招待リストにはいなかった）- 回答者としてのみ追加
        const newMaker = {
          id: crypto.randomUUID(),
          ...data,
          code: 'WEB-' + Date.now().toString().slice(-4),
          status: finalStatus,
          source: 'web_response', // 招待リストからではなくWeb回答
          respondedAt: Date.now()
        };
        updates = { makers: [...existingMakers, newMaker] };
      }
    }

    try {
      await updateExhibitionData(current.id, Object.keys(updates)[0], Object.values(updates)[0]);
      if (type === 'maker') {
        // Return objects for QR display
        const updatedMakers = updates.makers;
        const ourMaker = updatedMakers[updatedMakers.length - 1]; // Assume last if new, or find
        // Simplified: just return the data + computed status
        return ourMaker;
      }
      return true;
    } catch (e) { alert("送信エラー: " + e.message); return false; }
  };

  const handleVisitorScan = async (code) => {
    if (!selectedExhibition || !dashboardMaker) return { success: false, type: 'error', message: 'System error: Missing context' };
    const current = selectedExhibition;

    console.log('[DEBUG] handleVisitorScan code:', code);

    // 1. Find Visitor (Handle JSON or Raw ID)
    let searchId = code;
    try {
      const parsed = JSON.parse(code);
      if (parsed && parsed.id) {
        searchId = parsed.id;
      }
    } catch (e) {
      // Not JSON, use as is
    }

    const visitor = (current.visitors || []).find(v => v.id === searchId);
    if (!visitor) {
      return { success: false, type: 'error', message: '未登録の来場者QRコードです' };
    }

    // 2. Check Duplicates
    const alreadyScanned = (current.scanLogs || []).some(log =>
      log.makerId === (dashboardMaker.id || dashboardMaker.code) &&
      log.visitorId === visitor.id
    );

    if (alreadyScanned) {
      return { success: false, type: 'warning', message: `${visitor.repName} 様は既にスキャン済みです`, visitor };
    }

    // 3. Create Scan Log (Save ALL visitor data)
    const newLog = {
      id: crypto.randomUUID(),
      makerId: dashboardMaker.id || dashboardMaker.code,
      visitorId: visitor.id,
      scannedAt: Date.now(),
      visitorSnapshot: { ...visitor } // Save ALL visitor data
    };

    // 4. Update DB (Fire-and-forget for faster UI response)
    const currentLogs = current.scanLogs || [];
    const updatedLogs = [...currentLogs, newLog];
    updateExhibitionData(current.id, 'scanLogs', updatedLogs).catch(err => {
      console.error('Failed to save scan log:', err);
    });
    console.log('Scan logged (async):', newLog);

    return { success: true, type: 'success', message: 'スキャン完了', visitor };
  };

  if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Loader className="animate-spin text-blue-600 mb-2 mx-auto" size={40} /><p className="text-slate-500 font-bold">Connecting to Database...</p></div></div>;
  if (view === 'not_found') return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-500">プロジェクトが見つかりません。URLを確認してください。</div>;
  if (view === 'public_visitor_form') return <PublicVisitorView exhibition={selectedExhibition} onSubmit={(d) => handlePublicSubmit('visitor', d)} />;
  if (view === 'public_maker_form') return <PublicMakerView exhibition={selectedExhibition} onSubmit={(d) => handlePublicSubmit('maker', d)} />;
  if (view === 'maker_dashboard' && selectedExhibition && dashboardMaker) {
    return <MakerDashboard maker={dashboardMaker} exhibitionName={selectedExhibition.title} scanLogs={selectedExhibition.scanLogs} onScan={handleVisitorScan} />;
  }

  // Login Screen
  if (!isAuthenticated && view !== 'public_visitor_form' && view !== 'public_maker_form' && view !== 'maker_dashboard') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full mb-4">
              <Ghost className="text-red-500" size={24} />
              <span className="font-bold text-lg">Kaientai-X</span>
            </div>
            <h2 className="text-2xl font-bold text-slate-800">ログイン</h2>
            <p className="text-slate-500 text-sm mt-2">パスワードを入力してください</p>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">パスワード</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                className="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                placeholder="パスワードを入力"
              />
            </div>

            {loginError && (
              <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm">
                {loginError}
              </div>
            )}

            <button
              onClick={handleLogin}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg"
            >
              ログイン
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans flex flex-col md:flex-row">
      <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 className="text-lg font-bold flex items-center gap-2"><Ghost className="text-red-500" size={20} /> Kaientai-X</h1>
        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}><Menu size={24} /></button>
      </div>

      <aside className={`fixed inset-y-0 left-0 z-40 w-64 bg-slate-900 text-white transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
          <div><h1 className="text-2xl font-bold tracking-tighter text-blue-400 flex items-center gap-2"><Ghost className="text-red-500" size={28} /> Kaientai-X</h1><p className="text-xs text-slate-400 mt-1">Event Management System</p></div>
          <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-slate-400"><X /></button>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <button onClick={() => { setView('dashboard'); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300'}`}><LayoutDashboard size={20} /> ダッシュボード</button>
        </nav>
        <div className="p-4 border-t border-slate-800">
          <div className="flex items-center gap-3 mb-3"><img src="/ship_blue_icon.png" alt="Admin" className="w-10 h-10 rounded-full object-cover border border-slate-700 bg-white" /><div><p className="text-sm font-medium">caremax-corp</p><p className="text-xs text-slate-400 truncate max-w-[150px]" title="seisaku.tokyo@kaientaiweb.jp">seisaku.tokyo@kaientaiweb.jp</p></div></div>
          <button onClick={handleLogout} className="w-full text-red-400 hover:bg-red-500/10 px-3 py-2 rounded-lg text-sm flex items-center gap-2"><LogOut size={16} /> ログアウト</button>
        </div>
      </aside>

      {isMobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>}

      <main className="flex-1 h-[calc(100vh-60px)] md:h-screen overflow-y-auto bg-slate-50 relative">
        <div className="p-4 md:p-10 max-w-7xl mx-auto">
          {view === 'dashboard' && <DashboardView exhibitions={exhibitions} onCreateClick={() => setView('create')} onCardClick={(ex) => { setSelectedExhibition(ex); setView('detail'); }} onDeleteClick={deleteExhibition} />}
          {view === 'create' && <CreateExhibitionForm data={newExhibition} setData={setNewExhibition} onCancel={() => setView('dashboard')} onSubmit={handleCreate} />}
          {view === 'detail' && selectedExhibition && <ExhibitionDetail exhibition={selectedExhibition} onBack={() => setView('dashboard')} updateVisitorCount={updateVisitorCount} updateExhibitionData={updateExhibitionData} batchUpdateExhibitionData={batchUpdateExhibitionData} />}
        </div>
      </main>


    </div>
  );
}

export default App;